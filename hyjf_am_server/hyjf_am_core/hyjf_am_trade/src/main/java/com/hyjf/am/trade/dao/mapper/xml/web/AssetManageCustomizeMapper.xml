<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.web.AssetManageCustomizeMapper">

	<!-- 近期回款列表 -->
	<resultMap id="recentPaymentMap" type="com.hyjf.am.trade.dao.model.customize.web.RecentPaymentListCustomize">
		<result column="project_name" property="projectName" />
		<result column="borrow_apr" property="borrowApr" />
		<result column="invest_date" property="investDate" />
		<result column="total_wait" property="totalWait" />
		<result column="type" property="type" />
		<result column="coupon_type" property="couponType" />
		<result column="projectNid" property="projectNid" />
	</resultMap>
	<select id="selectRecentPaymentList" resultMap="recentPaymentMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time as orderby_invest_date,
		CASE
		WHEN hbc.credit_capital_assigned IS NOT NULL THEN 1
		ELSE 0 END type,
		0 coupon_type,
		IFNULL(rec.recover_capital_wait,ten.account)+
		IFNULL( rec.recover_interest_wait, 0 )-
		(SELECT IFNULL(SUM(ct.assign_interest - ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		)-
		(SELECT IFNULL(SUM(ct.assign_capital - ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		) total_wait
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover rec
		ON ten.nid = rec.nid
		AND rec.recover_capital > rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = ten.borrow_nid
		LEFT JOIN (SELECT hbc.tender_nid,
		MIN(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		borrow.`status` = 4
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		2 AS type,
		0 coupon_type,
		(ten.assign_capital+ten.assign_interest) total_wait
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = ten.bid_nid
		WHERE ten.user_id= #{userId}
		AND borrow.`status` = 4
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, hb.`borrow_nid`) AS project_name,
		hb.borrow_nid AS projectNid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hb.borrow_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(MAX(hcr.recover_time), '%Y-%m-%d' ) AS recover_time,
		MAX(hcr.recover_time),
		3 type,
		hcc.coupon_type coupon_type,
		IFNULL(SUM(hcr.recover_account),0) total_wait
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=0
		AND IFNULL(SUM(hcr.recover_account),0)>0
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(hiii.borrow_extra_yield, '%') borrow_apr,

		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		4 AS type,
		0 coupon_type,
		hiii.repay_interest_wait AS total_wait
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = hiii.borrow_nid
		INNER JOIN (select * from ht_increase_interest_loan where user_id=#{userId}
		) hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowInfo.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE borrow.`status` = 4
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		hhp.plan_name,
		<!-- hhp.plan_nid AS projectNid, -->
		hhp.plan_name AS projectNid,
		CONCAT(hhp.expect_apr, '%') borrow_apr,
		IF(IFNULL(hha.quit_time,0)=0,'--',FROM_UNIXTIME(hha.quit_time, '%Y-%m-%d' )) AS quit_time,
		hha.last_payment_time,
		5 AS type,
		0 coupon_type,
		hha.wait_total wait_total
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp
		ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status=3
		AND hha.user_id=#{userId}

		UNION ALL
		SELECT
		hhp.plan_name AS project_name,
		hbtc.borrow_nid AS projectNid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hhp.expect_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(hcr.recover_time, '%Y-%m-%d' ) AS recover_time,
		hcr.recover_time,
		3 type,
		hcc.coupon_type coupon_type,
		IFNULL(hcr.recover_account,0) total_wait
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hcr.recover_status=0
		) t
		ORDER BY t.orderby_invest_date,t.type
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>


	<!-- 资金管理用户当前持有债权列表 -->
	<resultMap id="currentHoldObligatoryRightMap" type="com.hyjf.am.trade.dao.model.customize.trade.CurrentHoldObligatoryRightListCustomize">
		<result column="project_name" property="projectName" />
		<result column="borrow_nid" property="borrowNid" />
		<result column="borrow_period" property="borrowPeriod" />
		<result column="borrow_style" property="borrowStyle" />
		<result column="borrow_class" property="borrowClass" />
		<result column="project_type" property="projectType" />
		<result column="borrow_apr" property="borrowApr" />
		<result column="ten_user_id" property="tenUserId" />
		<result column="nid" property="nid" />
		<result column="addtime" property="addtime" />
		<result column="invest_date" property="investDate" />
		<result column="capital" property="capital" />
		<result column="type" property="type" />
		<result column="DATA" property="data" />
		<result column="coupon_type" property="couponType" />
		<result column="total_wait" property="totalWait" />
		<result column="credit_nid" property="creditNid" />
		<result column="credit_tender_nid" property="creditTenderNid" />

		<result column="creditUserId" property="creditUserId" />

	</resultMap>

	<select id="selectCurrentHoldObligatoryRightList" resultMap="currentHoldObligatoryRightMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT

		1 AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrow.project_name, borrow.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		ten.user_id AS ten_user_id,
		ten.nid nid,
		FROM_UNIXTIME( ten.addtime, '%Y-%m-%d' ) AS addtime,
		ten.addtime as orderby_addtime,
		IFNULL(FROM_UNIXTIME( IF(borrow.repay_last_time='',NULL,borrow.repay_last_time), '%Y-%m-%d' ),'--') AS invest_date,
		borrow.repay_last_time as orderby_invest_date,
		(ten.account-(
		SELECT IFNULL(SUM(ct.assign_capital),0)
		FROM huiyingdai_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid)) AS capital,
		CASE
		WHEN hbc.credit_capital_assigned IS NOT NULL THEN 1
		ELSE 0 END type,
		CASE
		WHEN cast(borrow.`status` AS CHAR)<![CDATA[<>]]>4 THEN '投资中'
		ELSE
		CASE
		WHEN cast(hbc.credit_status AS CHAR)=0 THEN '转让中'
		WHEN cast(hbc.credit_status AS CHAR)=1 THEN '部分债转'
		ELSE '现金投资' END
		END AS DATA,
		0 coupon_type,
		IF(borrow.repay_last_time='','--',
		IFNULL(rec.recover_capital_wait,ten.account)+
		IFNULL( rec.recover_interest_wait, 0 )-
		(SELECT IFNULL(SUM(ct.assign_interest - ct.assign_repay_interest),0)
		FROM huiyingdai_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		)-
		(SELECT IFNULL(SUM(ct.assign_capital - ct.assign_repay_capital),0)
		FROM huiyingdai_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		)- (
		SELECT
		IFNULL(SUM(rp.charge_interest) ,0)
		FROM
		huiyingdai_credit_repay rp
		WHERE
		rec.nid = rp.credit_tender_nid
		and rp.status = 1
		)
		) total_wait,
		'' credit_nid,
		'' credit_tender_nid
		FROM
		huiyingdai_borrow_tender ten
		LEFT JOIN huiyingdai_borrow_recover rec
		ON ten.nid = rec.nid
		AND rec.recover_capital <![CDATA[>]]> rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN huiyingdai_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		INNER JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN (SELECT hbc.tender_nid,
		SUM(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM huiyingdai_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		(
		borrow.`status` = 2
		OR borrow.`status` = 3
		OR borrow.`status` = 4
		)
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL


		UNION ALL
		SELECT

		ten.credit_user_id AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrow.project_name, borrow.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		ten.user_id AS ten_user_id,
		ten.assign_nid nid,
		FROM_UNIXTIME(ten.add_time, '%Y-%m-%d') AS addtime,
		ten.add_time,
		IFNULL(FROM_UNIXTIME(IF(borrow.repay_last_time='',NULL,borrow.repay_last_time),'%Y-%m-%d'),'--') AS invest_date,
		borrow.repay_last_time,
		ten.assign_capital AS capital,
		2 AS type,
		'承接债转' DATA,
		0 coupon_type,
		(ten.assign_capital+ten.assign_interest
		-(
		SELECT
		IFNULL(sum(hdcrp.assign_interest) , 0)
		FROM
		huiyingdai_credit_repay hdcrp
		WHERE
		hdcrp.assign_nid = ten.assign_nid
		AND hdcrp.`status` = 1
		)
		) total_wait,
		ten.credit_nid credit_nid,
		ten.credit_tender_nid credit_tender_nid
		FROM
		huiyingdai_credit_tender ten
		INNER JOIN huiyingdai_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		INNER JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		WHERE ten.user_id= #{userId}
		AND borrow.`status` = 4
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL


		UNION ALL
		SELECT

		1 AS creditUserId,

		hb.borrow_nid,
		IFNULL(hb.project_name, hb.`name`) AS project_name,
		CASE
		WHEN hb.borrow_style = 'endday' THEN
		CONCAT(hb.borrow_period, '天')
		ELSE
		CONCAT(
		hb.borrow_period,
		'个月'
		)
		END borrow_period,
		hb.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		hb.project_type project_type,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hb.borrow_apr, '%')
		END
		borrow_apr,
		hbtc.user_id AS ten_user_id,
		hbtc.nid nid,
		FROM_UNIXTIME( hbtc.addtime, '%Y-%m-%d' ) AS addtime,
		hbtc.addtime,
		IFNULL(FROM_UNIXTIME( IF(MAX(hcr.recover_time)='',NULL,MAX(hcr.recover_time)), '%Y-%m-%d' ),'--') AS recover_time,
		MAX(hcr.recover_time),
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS capital,
		3 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(FORMAT(hcc.coupon_quota, 2),'元体验金')
		WHEN 2 THEN CONCAT(hcc.coupon_quota,'%加息券')
		WHEN 3 THEN CONCAT(FORMAT(hcc.coupon_quota, 2),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type,
		IFNULL(SUM(hcr.recover_account)-SUM(hcr.recover_account_yes),0) total_wait,
		'' credit_nid,
		'' credit_tender_nid
		FROM
		hyjf_borrow_tender_cpn hbtc
		INNER JOIN huiyingdai_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		LEFT JOIN hyjf_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN hyjf_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN hyjf_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN hyjf_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		INNER JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = hb.project_type
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=0
		AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0


		UNION ALL


		SELECT

		1 AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrow.project_name, borrow.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(hiii.borrow_extra_yield, '%') borrow_apr,
		hiii.user_id AS ten_user_id,
		hiii.order_id nid,
		FROM_UNIXTIME( hiii.create_time, '%Y-%m-%d' ) AS addtime,
		hiii.create_time,
		IFNULL(FROM_UNIXTIME( IF(borrow.repay_last_time='',NULL,borrow.repay_last_time), '%Y-%m-%d' ),'--') AS invest_date,
		borrow.repay_last_time,
		hiii.account AS capital,
		4 AS type,
		'产品加息' AS DATA,
		0 coupon_type,
		IF(borrow.`status` = 4,hiii.repay_interest_wait,'--') AS total_wait,
		'' credit_nid,
		'' credit_tender_nid
		FROM
		hyjf_increase_interest_invest hiii
		INNER JOIN huiyingdai_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN hyjf_increase_interest_loan hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN huiyingdai_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE
		(
		borrow.`status` = 2
		OR borrow.`status` = 3
		OR borrow.`status` = 4
		)
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL

		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
			ORDER BY t.orderby_addtime desc,t.capital
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.capital desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.capital asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_addtime desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_addtime asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_invest_date desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_invest_date asc
			</if>
		</if>
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>


	<select id="selectCurrentHoldObligatoryRightListTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT
			ten.nid nid
			FROM
				ht_borrow_tender ten
            LEFT JOIN ht_borrow_recover rec
                ON ten.nid = rec.nid  AND rec.recover_capital <![CDATA[>]]> rec.credit_amount AND rec.recover_account_wait> 0
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
			INNER JOIN ht_borrow_info hbi ON borrow.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			LEFT JOIN (SELECT hbc.tender_nid,
							SUM(hbc.credit_capital_assigned) credit_capital_assigned,
							MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
						GROUP BY hbc.tender_nid
					) hbc ON ten.nid=hbc.tender_nid
			WHERE
				(
					borrow.`status` = 2
					OR borrow.`status` = 3
					OR borrow.`status` = 4
				)
			AND ten.user_id= #{userId}
			AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
				ten.assign_nid nid
			FROM
				ht_credit_tender ten
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
			INNER JOIN ht_borrow_info hbi ON borrow.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			WHERE ten.user_id= #{userId}
			AND borrow.`status` = 4
			AND ten.assign_interest>0
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
			hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
			INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
			INNER JOIN ht_borrow_info hbi ON hb.borrow_nid = hbi.borrow_nid
			LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
			INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
			INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
			INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			WHERE hbtc.user_id= #{userId}
			AND hb.plan_nid IS NULL
            GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=0
               AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0
			UNION ALL
			SELECT
			hiii.order_id nid
			FROM
				ht_increase_interest_invest hiii
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
			INNER JOIN ht_borrow_info hbi ON hb.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id=hiii.order_id
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
			WHERE
				(
					borrow.`status` = 2
					OR borrow.`status` = 3
					OR borrow.`status` = 4
				)
			AND hiii.user_id=#{userId}
			AND borrow.plan_nid IS NULL
		) t
	</select>

	<select id="selectRepaymentListTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT
				hbr.nid nid
			FROM
				ht_borrow_recover hbr
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hbr.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
			LEFT JOIN (SELECT hbc.tender_nid,
								MIN(hbc.credit_capital_assigned) credit_capital_assigned,
								MIN(hbc.credit_capital) credit_capital,
								MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
						GROUP BY hbc.tender_nid ) hbc ON hbr.nid = hbc.tender_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND IFNULL(hbc.credit_capital,hbt.account) > IFNULL(hbc.credit_capital_assigned,0)
			AND hbr.user_id= #{userId}
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT

				hct.assign_nid nid
			FROM
				ht_credit_tender hct
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hct.bid_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_tender hbt ON hct.credit_tender_nid=hbt.nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND hct.assign_interest<![CDATA[>]]>0
			AND hct.user_id= #{userId}
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
				hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
			INNER JOIN ht_borrow borrow ON hbtc.borrow_nid = borrow.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
			INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
			INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
			INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE hbtc.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=1
			UNION ALL
			SELECT
				hiil.invest_order_id nid
			FROM
				ht_increase_interest_loan hiil
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiil.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND hiil.user_id= #{userId}
			AND borrow.plan_nid IS NULL
		) t
	</select>
	<!-- 获取转让记录列表资源总数 -->
	<select id="countCreditRecordTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT
		COUNT(credit_nid) AS total
		FROM
		ht_borrow_credit
		<where>
			<if test="userId != null and userId != '' and userId != 0">
				AND credit_user_id = #{userId}
			</if>
		</where>
	</select>

	<select id="selectRepaymentList" resultMap="repaymentMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		hbr.user_id AS ten_user_id,
		hbr.nid nid,
		hbr.recover_capital_yes-(
		SELECT IFNULL(SUM(ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid) account,
		hbr.recover_account_yes-
		(SELECT IFNULL(SUM(ct.assign_repay_account),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid
		) recover_account_all,


		hbr.recover_interest_yes -
		(SELECT IFNULL(SUM(ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid
		) recover_account_interest,
		FROM_UNIXTIME( hbr.recover_yestime, '%Y-%m-%d' ) repay_orddate,
		hbr.recover_yestime orderby_repay_orddate,
		CASE
		WHEN hbr.credit_amount > 0 THEN 1
		ELSE 0
		END type,
		CASE
		WHEN hbr.credit_amount > 0 THEN
		'部分债转'
		ELSE
		'现金投资'
		END AS DATA,
		0 coupon_type,
		hbt.account groupaccount
		FROM
		ht_borrow_recover hbr
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hbr.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		LEFT JOIN ht_borrow_credit hbc ON hbr.nid = hbc.tender_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE borrow.`status` = 5
		AND hbr.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		GROUP BY hbr.nid
		HAVING IFNULL(MIN(hbc.credit_capital),hbt.account) > IFNULL(MIN(hbc.credit_capital_assigned),0)
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		hct.user_id AS ten_user_id,
		hct.assign_nid nid,
		hct.assign_repay_capital AS capital,
		hct.assign_repay_account AS capital_paid,
		hct.assign_repay_interest AS assign_repay_interest,
		FROM_UNIXTIME( hct.assign_repay_yes_time, '%Y-%m-%d' ),
		hct.assign_repay_yes_time orderby_repay_orddate,
		2 AS type,
		'承接债转' DATA,
		0 coupon_type,
		'' groupaccount
		FROM
		ht_credit_tender hct
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hct.bid_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_tender hbt ON hct.credit_tender_nid=hbt.nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE borrow.`status` = 5
		AND hct.assign_interest<![CDATA[>]]>0
		AND hct.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE CONCAT(borrow.borrow_apr, '%')
		END borrow_apr,
		hbtc.user_id AS ten_user_id,
		hbtc.nid nid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS capital,
		hbtc.recover_account_yes,
		hbtc.recover_account_interest_yes,

		FROM_UNIXTIME( MAX(hcr.recover_yestime), '%Y-%m-%d' ),
		MAX(hcr.recover_yestime) orderby_repay_orddate,
		3 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(FORMAT(hcc.coupon_quota, 2),'元体验金')
		WHEN 2 THEN CONCAT(hcc.coupon_quota,'%加息券')
		WHEN 3 THEN CONCAT(FORMAT(hcc.coupon_quota, 2),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type,
		'' groupaccount
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow borrow ON hbtc.borrow_nid = borrow.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE hbtc.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=1
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(hiil.borrow_extra_yield, '%') borrow_apr,
		hiil.user_id AS ten_user_id,
		hiil.invest_order_id nid,
		hiil.invest_account account,
		hiil.repay_interest_yes recover_account_all,
		hiil.repay_interest_yes recover_account_interest,
		FROM_UNIXTIME( hiil.repay_action_time, '%Y-%m-%d' ) repay_orddate,
		hiil.repay_action_time orderby_repay_orddate,
		4 type,
		'产品加息' AS DATA,
		0 coupon_type,
		'' groupaccount
		FROM
		ht_increase_interest_loan hiil
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiil.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE borrow.`status` = 5
		AND hiil.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
			ORDER BY t.orderby_repay_orddate desc,t.account
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.account desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.account asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.recover_account_interest desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.recover_account_interest asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_repay_orddate desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_repay_orddate asc
			</if>
		</if>

		<if test="limitStart >= 0" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>
	<resultMap id="CreditBaseResultMap" type="com.hyjf.am.trade.dao.model.customize.trade.TenderCreditDetailCustomize" >
		<id column="credit_id" property="creditId" />
		<result column="credit_nid" property="creditNid" />
		<result column="credit_user_id" property="creditUserId" />
		<result column="bid_nid" property="bidNid" />
		<result column="bid_apr" property="bidApr" />
		<result column="bid_name" property="bidName" />
		<result column="borrow_style" property="borrowStyle" />
		<result column="borrow_style_name" property="borrowStyleName" />
		<result column="tender_nid" property="tenderNid" />
		<result column="credit_status" property="creditStatus" />
		<result column="credit_order" property="creditOrder" />
		<result column="credit_period" property="creditPeriod" />
		<result column="credit_term" property="creditTerm" />
		<result column="credit_capital" property="creditCapital" />
		<result column="credit_account" property="creditAccount" />
		<result column="credit_interest" property="creditInterest" />
		<result column="credit_interest_advance" property="creditInterestAdvance" />
		<result column="credit_discount" property="creditDiscount" />
		<result column="credit_income" property="creditIncome" />
		<result column="credit_fee" property="creditFee" />
		<result column="credit_price" property="creditPrice" />
		<result column="credit_capital_assigned" property="creditCapitalAssigned" />
		<result column="credit_interest_assigned" property="creditInterestAssigned" />
		<result column="credit_repay_account" property="creditRepayAccount" />
		<result column="credit_repay_capital" property="creditRepayCapital" />
		<result column="credit_repay_interest" property="creditRepayInterest" />
		<result column="credit_repay_end_time" property="creditRepayEndTime" />
		<result column="credit_repay_last_time" property="creditRepayLastTime" />
		<result column="credit_repay_next_time" property="creditRepayNextTime" />
		<result column="credit_repay_yes_time" property="creditRepayYesTime" />
		<result column="create_date" property="createDate" />
		<result column="add_time" property="addTime" />
		<result column="add_time_int" property="addTimeInt" />
		<result column="end_time" property="endTime" />
		<result column="assign_time" property="assignTime" />
		<result column="assign_num" property="assignNum" />
		<result column="recover_period" property="recoverPeriod" />
		<result column="credit_inProgress" property="creditInProgress" />
		<result column="tenderTime" property="tenderTime" />
		<result column="tender_period" property="tenderPeriod" />
		<result column="last_days" property="lastDays" />
		<result column="receivedAccount" property="receivedAccount" />
		<result column="project_name" property="projectName" />
	</resultMap>
	<!-- 获取转让记录列表资源 -->
	<select id="selectCreditRecordList" resultMap="CreditBaseResultMap" parameterType="java.util.Map">
		SELECT
		<!--项目编号  -->
		hb.borrow_nid AS bid_nid,
		<!-- 原始转让本金 -->
		hbc.credit_capital,
		<!-- 折让比例 -->
		hbc.credit_discount,
		<!-- 债转时间 -->
		FROM_UNIXTIME(hbc.add_time,'%Y-%m-%d %H:%i') AS add_time,
		<!-- 债转时间 -->
		hbc.add_time AS add_time_int,
		<!-- 已转让金额 -->
		hbc.credit_capital_assigned,
		<!-- 累计收到金额 -->
		(
		SELECT
		IFNULL(SUM(hct.assign_pay - hct.credit_fee),0)
		FROM
		huiyingdai_credit_tender hct
		WHERE
		hct.credit_tender_nid = hbc.tender_nid
		AND hbc.credit_nid = hct.credit_nid
		) AS receivedAccount,
		FROM_UNIXTIME(hbt.add_time, '%Y-%m-%d %H:%i:%s') AS tenderTime,
		(DATEDIFF(
		FROM_UNIXTIME(
		unix_timestamp(now()),
		'%Y-%m-%d 00:00:00'
		),
		FROM_UNIXTIME(hb.recover_last_time, '%Y-%m-%d 00:00:00')
		)) AS tender_period,
		(DATEDIFF(
		FROM_UNIXTIME(
		CAST(hb.repay_last_time AS SIGNED),
		'%Y-%m-%d 00:00:00'
		),
		FROM_UNIXTIME(unix_timestamp(now()), '%Y-%m-%d 00:00:00')
		)) AS last_days,
		CASE WHEN credit_capital>credit_capital_assigned AND TRUNCATE(credit_capital_assigned/credit_capital*100,2) = 100.00
		THEN 99 ELSE TRUNCATE(credit_capital_assigned/credit_capital*100,2) END AS credit_inProgress,
		hbc.credit_nid,
		hbc.credit_status,
		hbc.credit_term
		FROM huiyingdai_borrow_credit hbc
		INNER JOIN huiyingdai_borrow hb ON hbc.bid_nid = hb.borrow_nid
		INNER JOIN huiyingdai_borrow_style hbs ON hb.borrow_style = hbs.nid
		LEFT JOIN huiyingdai_borrow_tender hbt ON hbc.bid_nid = hbt.borrow_nid AND hbc.tender_nid = hbt.nid

		<where>
			<if test="userId != null and userId != '' and userId != 0">
				AND hbc.credit_user_id = #{userId}
			</if>
		</where>
		order by hbc.credit_status, hbc.add_time desc
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>

</mapper>