<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.trade.WebProjectListCustomizeMapper">
    <sql id="Where_Clause_New">
        <where>
            <if test="projectType != null and projectType != ''">
                htbpt.borrow_project_type = #{projectType,jdbcType=VARCHAR}
            </if>
            <if test="borrowClass != null and borrowClass != ''">
                AND htbpt.borrow_class = #{borrowClass,jdbcType=VARCHAR}
            </if>
            <if test="borrowClass == null or borrowClass == ''">
                <!-- 新手汇  -->
                AND htbpt.borrow_class <![CDATA[<>]]> 'NEW'
                <!-- 汇直投列表数据过滤:只显示有效的项目 -->
                <if test="projectType == 'HZT'">
                    AND CASE
                    WHEN ( htb.`status` = 1 AND htb.verify_status = 3)
                    THEN
                    htb.ontime + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    ELSE
                    htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    END
                </if>
            </if>
            <if test="status == null or status == ''">
                AND
                (
                ( htb.`status` = 1 AND htb.verify_status = 3 )
                OR ( htb.`status` = 2 AND htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                OR ( htb.`status` = 3 )
                OR ( htb.`status` = 4 )
                )
            </if>

            <if test="status != null and status != ''">
                <!-- 获取 等待投资中 -->
                <if test="status == '1'.toString()">
                    AND ( htb.`status` = 1 AND htb.verify_status = 3 )
                </if>
                <!-- 获取 投资中 -->
                <if test="status == '2'.toString()">
                    AND ( htb.`status` = 2 AND htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                </if>
                <!-- 获取 投标结束 -->
                <if test="status == '3'.toString()">
                    AND (htb.`status` = 3)
                </if>
                <!-- 获取 还款中 -->
                <if test="status == '4'.toString()">
                    AND ( htb.`status` = 4)
                </if>
            </if>
            AND htb.is_show <![CDATA[<>]]> 1
            <if test="publishInstCode != null and publishInstCode != ''">
                AND (htb.publish_inst_code = #{publishInstCode,jdbcType=VARCHAR} OR htb.publish_inst_code ='0')
            </if>
        </where>
    </sql>

    <!-- 项目列表 ResultMap-->
    <resultMap id="ProjectListNewMap" type="com.hyjf.am.trade.dao.model.customize.trade.WebProjectListCustomize">
        <id column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
        <result column="borrow_name" property="borrowName" jdbcType="VARCHAR" />
        <result column="project_name" property="projectName" jdbcType="VARCHAR" />
        <result column="is_new" property="isNew" jdbcType="VARCHAR" />
        <result column="borrow_style" property="borrowStyle" jdbcType="VARCHAR" />
        <result column="project_type" property="projectType" jdbcType="VARCHAR" />
        <result column="borrow_type" property="borrowType" jdbcType="VARCHAR" />
        <result column="borrow_apr" property="borrowApr" jdbcType="VARCHAR" />
        <result column="borrow_period" property="borrowPeriod" jdbcType="VARCHAR" />
        <result column="borrow_period_type" property="borrowPeriodType" jdbcType="VARCHAR" />
        <result column="borrow_account" property="borrowAccount" jdbcType="VARCHAR" />
        <result column="borrow_schedule" property="borrowSchedule" jdbcType="VARCHAR" />
        <result column="tstatus" property="status" jdbcType="VARCHAR" />
        <result column="on_time" property="onTime" jdbcType="VARCHAR" />
        <result column="time" property="time" jdbcType="VARCHAR" />
        <result column="couponEnable" property="couponEnable" jdbcType="VARCHAR" />
        <result column="booking_status" property="bookingStatus" jdbcType="INTEGER" />
        <result column="booking_begin_time" property="bookingBeginTime" jdbcType="INTEGER" />
        <result column="booking_end_time" property="bookingEndTime" jdbcType="INTEGER" />
        <result column="borrow_account_scale_appoint" property="borrowAccountScaleAppoint" jdbcType="DECIMAL" />
        <result column="borrow_extra_yield" property="borrowExtraYield" jdbcType="DECIMAL" />
        <result column="borrow_asset_number" property="borrowAssetNumber" jdbcType="VARCHAR" />
        <result column="borrow_class" property="borrowClass" jdbcType="VARCHAR" />
    </resultMap>
    <!--Web端获取项目列表-->
    <select id="searchProjectList" resultMap="ProjectListNewMap" parameterType="Map">
        SELECT
            htb.borrow_nid,
            htb.borrow_nid AS project_name,
            htb.borrow_style AS borrow_style,
            htb.borrow_apr,
            htb.borrow_period,
            htb.account AS borrow_account,
            TRUNCATE((htb.borrow_account_yes/htb.account)*100,2) AS borrow_schedule,
            CASE WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN '10'
            WHEN htb.`status` = 2
            AND (htb.verify_time + (hbi.borrow_valid_time * 24 * 60 * 60) > UNIX_TIMESTAMP(NOW())) THEN
            '11'
            WHEN htb.`status` = 3 THEN
            '12'
            WHEN htb.`status` = 4 THEN
            '13'
            ELSE
            ''
            END AS tstatus,
            CASE WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN
            FROM_UNIXTIME(htb.ontime,'%Y-%m-%d %H:%i:%s') ELSE '' END AS on_time,
            CASE  WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN htb.ontime ELSE ''END AS time,
            (htbpt.increase_money OR htbpt.interest_coupon) AS couponEnable,
            htbpt.borrow_class borrow_class
        FROM ht_borrow htb
        INNER JOIN ht_borrow_info hbi on hbi.borrow_nid = htb.borrow_nid
        INNER JOIN ht_borrow_project_type htbpt ON htbpt.borrow_cd = hbi.project_type
        LEFT JOIN ht_borrow_style htbs ON htb.borrow_style = htbs.nid

        <include refid = "Where_Clause_New" />
        ORDER BY
        htb.`status` ASC,
        CASE
        WHEN htb.`status` = '1'
        AND htb.verify_status = 3
        AND htb.ontime IS NOT NULL
        AND LENGTH(trim(htb.ontime)) > 1 THEN
        htb.ontime
        END ASC,
        CASE
        WHEN htb.`status` = '2' THEN
        htb.verify_time
        END DESC,
        CASE
        WHEN htb.`status` = '3' THEN
        htb.borrow_full_time
        END DESC,
        CASE
        WHEN htb.`status` = '4' THEN
        htb.borrow_full_time
        END DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>


    <select id="countProjectList" resultType="int" parameterType="Map">
        SELECT
           count(*)
        FROM ht_borrow htb
        INNER JOIN ht_borrow_info hbi on hbi.borrow_nid = htb.borrow_nid
        INNER JOIN ht_borrow_project_type htbpt ON htbpt.borrow_cd = hbi.project_type
        LEFT JOIN ht_borrow_style htbs ON htb.borrow_style = htbs.nid
        <include refid = "Where_Clause_New" />
    </select>

    <!--债权转让查询data -->
    <select id="searchCreditList">
        select
        <include refid="Credit_Base_Column_List"/>
        from   huiyingdai_borrow_credit
        INNER JOIN huiyingdai_borrow ON huiyingdai_borrow_credit.bid_nid = huiyingdai_borrow.borrow_nid
	    INNER JOIN huiyingdai_borrow_style hbs ON huiyingdai_borrow.borrow_style = hbs.nid
	    <include refid="Credit_Where_Column"/>
        ORDER BY credit_inProgress DESC,
        <if test="discountSort != null and discountSort != ''">
            credit_discount ${discountSort},
        </if>
        <if test="termSort != null and termSort != ''">
            credit_term ${termSort},
        </if>
        <if test="capitalSort != null and capitalSort != ''">
            credit_capital ${capitalSort},
        </if>
        add_time DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>

    <!--债权转让查询count-->
    <select id="countCreditList" resultType="int" parameterType="Map">>
        select count(*)
        from   huiyingdai_borrow_credit
        INNER JOIN huiyingdai_borrow ON huiyingdai_borrow_credit.bid_nid = huiyingdai_borrow.borrow_nid
        INNER JOIN huiyingdai_borrow_style hbs ON huiyingdai_borrow.borrow_style = hbs.nid
        <include refid="Credit_Where_Column"/>
    </select>



    <!--债权转让查询where-->
    <sql id="Credit_Where_Column">
        <where>
            huiyingdai_borrow.is_show <![CDATA[<>]]> 1
            <if test="creditStatus != null and creditStatus != ''">
                AND credit_status = #{creditStatus}
            </if>
            <if test="borrowPeriodMin != null and borrowPeriodMin != ''">
                AND borrow_period <![CDATA[>=]]> #{borrowPeriodMin}
                <if test="borrowPeriodMax != null and borrowPeriodMax != ''">
                    AND borrow_period <![CDATA[<]]> #{borrowPeriodMax}
                </if>
            </if>
            AND ((
                huiyingdai_borrow.borrow_style !='endday'
                <if test="borrowAprMin != null and borrowAprMin != ''">
                    AND huiyingdai_borrow_credit.bid_apr <![CDATA[>=]]>  #{borrowAprMin}
                    <if test=" borrowAprMax != null and borrowAprMax != ''">
                        AND huiyingdai_borrow_credit.bid_apr <![CDATA[<]]> #{borrowAprMax}
                    </if>
                </if>
            ) OR (
                huiyingdai_borrow.borrow_style ='endday'
                <if test="borrowAprMin != null and borrowAprMin != ''">
                    AND huiyingdai_borrow_credit.bid_apr <![CDATA[>=]]>  #{borrowAprMin} * 30
                    <if test=" borrowAprMax != null and borrowAprMax != ''">
                        AND huiyingdai_borrow_credit.bid_apr <![CDATA[<]]> #{borrowAprMax} * 30
                    </if>
                </if>
            ))
        </where>
    </sql>

    <!--债权转让查询列-->
    <sql id="Credit_Base_Column_List" >
	    credit_id,
	    credit_nid,
	    credit_user_id,
	    bid_nid,
	    bid_apr,
	    bid_name,
	    borrow_style,
	    hbs.name AS borrow_style_name,
	    huiyingdai_borrow_credit.tender_nid,
	    credit_status,
	    credit_order,
	    credit_period,
	    credit_term,
	    credit_capital,
	    credit_account,
	    credit_interest,
	    credit_interest_advance,
	    credit_discount,
	    credit_income,
	    credit_fee,
	    credit_price,
	    credit_capital_assigned,
	    credit_interest_assigned,
	    credit_repay_account,
	    credit_repay_capital,
	    credit_repay_interest,
	    CASE
		WHEN credit_repay_end_time != 0 THEN
			FROM_UNIXTIME(credit_repay_end_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_end_time,
		CASE
		WHEN credit_repay_last_time != 0 THEN
			FROM_UNIXTIME(credit_repay_last_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_last_time,
		CASE
		WHEN credit_repay_next_time != 0 THEN
			FROM_UNIXTIME(credit_repay_next_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_next_time,
		CASE
		WHEN credit_repay_yes_time != 0 THEN
			FROM_UNIXTIME(credit_repay_yes_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_yes_time,
	    create_date,
	    CASE
		WHEN add_time != 0 THEN
			FROM_UNIXTIME(add_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS add_time,
		add_time AS add_time_int,
		CASE
		WHEN end_time != 0 THEN
			FROM_UNIXTIME(end_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS end_time,
		CASE
		WHEN assign_time != 0 THEN
			FROM_UNIXTIME(assign_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS assign_time,
		assign_num,
	    recover_period,
	   case when credit_capital>credit_capital_assigned and truncate(credit_capital_assigned/credit_capital*100,2)=100.00 then 99 else truncate(credit_capital_assigned/credit_capital*100,2) end   AS credit_inProgress
	</sql>


</mapper>