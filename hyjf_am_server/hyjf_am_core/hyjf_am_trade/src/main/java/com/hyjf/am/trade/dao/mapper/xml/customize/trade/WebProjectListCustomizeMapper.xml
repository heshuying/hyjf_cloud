<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.trade.WebProjectListCustomizeMapper">
    <sql id="Where_Clause_New">
        <where>
            <if test="projectType != null and projectType != ''">
                htbpt.borrow_project_type = #{projectType,jdbcType=VARCHAR}
            </if>
            <if test="borrowClass != null and borrowClass != ''">
                AND htbpt.borrow_class = #{borrowClass,jdbcType=VARCHAR}
            </if>
            <if test="borrowClass == null or borrowClass == ''">
                <!-- 新手汇  -->
                AND htbpt.borrow_class <![CDATA[<>]]> 'NEW'
                <!-- 汇直投列表数据过滤:只显示有效的项目 -->
                <if test="projectType == 'HZT'">
                    AND CASE
                    WHEN ( htb.`status` = 1 AND htb.verify_status = 3)
                    THEN
                    htb.ontime + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    ELSE
                    htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    END
                </if>
            </if>
            <if test="status == null or status == ''">
                AND
                (
                ( htb.`status` = 1 AND htb.verify_status = 3 )
                OR ( htb.`status` = 2 AND htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                OR ( htb.`status` = 3 )
                OR ( htb.`status` = 4 )
                )
            </if>

            <if test="status != null and status != ''">
                <!-- 获取 等待投资中 -->
                <if test="status == '1'.toString()">
                    AND ( htb.`status` = 1 AND htb.verify_status = 3 )
                </if>
                <!-- 获取 投资中 -->
                <if test="status == '2'.toString()">
                    AND ( htb.`status` = 2 AND htb.verify_time + ( hbi.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                </if>
                <!-- 获取 投标结束 -->
                <if test="status == '3'.toString()">
                    AND (htb.`status` = 3)
                </if>
                <!-- 获取 还款中 -->
                <if test="status == '4'.toString()">
                    AND ( htb.`status` = 4)
                </if>
            </if>
            AND htb.is_show <![CDATA[<>]]> 1
            <if test="publishInstCode != null and publishInstCode != ''">
                AND (htb.publish_inst_code = #{publishInstCode,jdbcType=VARCHAR} OR htb.publish_inst_code ='0')
            </if>
        </where>
    </sql>

    <!-- 项目列表 ResultMap-->
    <resultMap id="ProjectListNewMap" type="com.hyjf.am.trade.dao.model.customize.trade.WebProjectListCustomize">
        <id column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
        <result column="borrow_name" property="borrowName" jdbcType="VARCHAR" />
        <result column="project_name" property="projectName" jdbcType="VARCHAR" />
        <result column="is_new" property="isNew" jdbcType="VARCHAR" />
        <result column="borrow_style" property="borrowStyle" jdbcType="VARCHAR" />
        <result column="project_type" property="projectType" jdbcType="VARCHAR" />
        <result column="borrow_type" property="borrowType" jdbcType="VARCHAR" />
        <result column="borrow_apr" property="borrowApr" jdbcType="VARCHAR" />
        <result column="borrow_period" property="borrowPeriod" jdbcType="VARCHAR" />
        <result column="borrow_period_type" property="borrowPeriodType" jdbcType="VARCHAR" />
        <result column="borrow_account" property="borrowAccount" jdbcType="VARCHAR" />
        <result column="borrow_schedule" property="borrowSchedule" jdbcType="VARCHAR" />
        <result column="tstatus" property="status" jdbcType="VARCHAR" />
        <result column="on_time" property="onTime" jdbcType="VARCHAR" />
        <result column="time" property="time" jdbcType="VARCHAR" />
        <result column="couponEnable" property="couponEnable" jdbcType="VARCHAR" />
        <result column="booking_status" property="bookingStatus" jdbcType="INTEGER" />
        <result column="booking_begin_time" property="bookingBeginTime" jdbcType="INTEGER" />
        <result column="booking_end_time" property="bookingEndTime" jdbcType="INTEGER" />
        <result column="borrow_account_scale_appoint" property="borrowAccountScaleAppoint" jdbcType="DECIMAL" />
        <result column="borrow_extra_yield" property="borrowExtraYield" jdbcType="DECIMAL" />
        <result column="borrow_asset_number" property="borrowAssetNumber" jdbcType="VARCHAR" />
        <result column="borrow_class" property="borrowClass" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="HjhPlanMap" type="com.hyjf.am.trade.dao.model.customize.trade.WebProjectListCustomize">
        <id column="plan_nid" property="planNid" jdbcType="VARCHAR" />
        <result column="plan_name" property="planName" jdbcType="VARCHAR" />
        <result column="expect_apr" property="planApr" jdbcType="VARCHAR" />
        <result column="lock_period" property="planPeriod" jdbcType="VARCHAR" />
        <result column="is_month" property="isMonth" jdbcType="VARCHAR" />
        <result column="available_invest_account" property="availableInvestAccount" jdbcType="VARCHAR" />
        <result column="plan_invest_status" property="status" jdbcType="VARCHAR" />
        <result column="plan_invest_status_name" property="statusName" jdbcType="VARCHAR" />
        <result column="coupon_config" property="couponEnable" jdbcType="VARCHAR" />
    </resultMap>
    <!--Web端获取项目列表-->
    <select id="searchProjectList" resultMap="ProjectListNewMap" parameterType="Map">
        SELECT
            htb.borrow_nid,
            htb.borrow_nid AS project_name,
            htb.borrow_style AS borrow_style,
            htb.borrow_apr,
            htb.borrow_period,
            htb.account AS borrow_account,
            TRUNCATE((htb.borrow_account_yes/htb.account)*100,2) AS borrow_schedule,
            CASE WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN '10'
            WHEN htb.`status` = 2
            AND (htb.verify_time + (hbi.borrow_valid_time * 24 * 60 * 60) > UNIX_TIMESTAMP(NOW())) THEN
            '11'
            WHEN htb.`status` = 3 THEN
            '12'
            WHEN htb.`status` = 4 THEN
            '13'
            ELSE
            ''
            END AS tstatus,
            CASE WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN
            FROM_UNIXTIME(htb.ontime,'%Y-%m-%d %H:%i:%s') ELSE '' END AS on_time,
            CASE  WHEN htb.`status` = 1 AND htb.verify_status = 3 THEN htb.ontime ELSE ''END AS time,
            (htbpt.increase_money OR htbpt.interest_coupon) AS couponEnable,
            htbpt.borrow_class borrow_class
        FROM ht_borrow htb
        INNER JOIN ht_borrow_info hbi on hbi.borrow_nid = htb.borrow_nid
        INNER JOIN ht_borrow_project_type htbpt ON htbpt.borrow_cd = hbi.project_type
        LEFT JOIN ht_borrow_style htbs ON htb.borrow_style = htbs.nid

        <include refid = "Where_Clause_New" />
        ORDER BY
        htb.`status` ASC,
        CASE
        WHEN htb.`status` = '1'
        AND htb.verify_status = 3
        AND htb.ontime IS NOT NULL
        AND LENGTH(trim(htb.ontime)) > 1 THEN
        htb.ontime
        END ASC,
        CASE
        WHEN htb.`status` = '2' THEN
        htb.verify_time
        END DESC,
        CASE
        WHEN htb.`status` = '3' THEN
        htb.borrow_full_time
        END DESC,
        CASE
        WHEN htb.`status` = '4' THEN
        htb.borrow_full_time
        END DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>


    <select id="countProjectList" resultType="int" parameterType="Map">
        SELECT
           count(*)
        FROM ht_borrow htb
        INNER JOIN ht_borrow_info hbi on hbi.borrow_nid = htb.borrow_nid
        INNER JOIN ht_borrow_project_type htbpt ON htbpt.borrow_cd = hbi.project_type
        LEFT JOIN ht_borrow_style htbs ON htb.borrow_style = htbs.nid
        <include refid = "Where_Clause_New" />
    </select>

    <!--债权转让查询data -->
    <select id="searchCreditList"  resultMap="ProjectListNewMap" parameterType="Map">
        select
        <include refid="Credit_Base_Column_List"/>
        from   huiyingdai_borrow_credit
        INNER JOIN huiyingdai_borrow ON huiyingdai_borrow_credit.bid_nid = huiyingdai_borrow.borrow_nid
	    INNER JOIN huiyingdai_borrow_style hbs ON huiyingdai_borrow.borrow_style = hbs.nid
	    <include refid="Credit_Common_Where_Column"/>
        ORDER BY credit_inProgress DESC,
        <if test="discountSort != null and discountSort != ''">
            credit_discount ${discountSort},
        </if>
        <if test="termSort != null and termSort != ''">
            credit_term ${termSort},
        </if>
        <if test="capitalSort != null and capitalSort != ''">
            credit_capital ${capitalSort},
        </if>
        add_time DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>

    <!--债权转让查询count-->
    <select id="countCreditList" resultType="int" parameterType="Map">>
        select count(*)
        from   huiyingdai_borrow_credit
        INNER JOIN huiyingdai_borrow ON huiyingdai_borrow_credit.bid_nid = huiyingdai_borrow.borrow_nid
        INNER JOIN huiyingdai_borrow_style hbs ON huiyingdai_borrow.borrow_style = hbs.nid
        <include refid="Credit_Common_Where_Column"/>
    </select>



    <!--债权转让(web，app)查询公用where-->
    <sql id="Credit_Common_Where_Column">
        <where>
            huiyingdai_borrow.is_show <![CDATA[<>]]> 1
            <if test="creditStatus != null and creditStatus != ''">
                AND credit_status = #{creditStatus}
            </if>
            <if test="borrowPeriodMin != null and borrowPeriodMin != ''">
                AND borrow_period <![CDATA[>=]]> #{borrowPeriodMin}
                <if test="borrowPeriodMax != null and borrowPeriodMax != ''">
                    AND borrow_period <![CDATA[<]]> #{borrowPeriodMax}
                </if>
            </if>
            AND ((
                huiyingdai_borrow.borrow_style !='endday'
                <if test="borrowAprMin != null and borrowAprMin != ''">
                    AND huiyingdai_borrow_credit.bid_apr <![CDATA[>=]]>  #{borrowAprMin}
                    <if test=" borrowAprMax != null and borrowAprMax != ''">
                        AND huiyingdai_borrow_credit.bid_apr <![CDATA[<]]> #{borrowAprMax}
                    </if>
                </if>
            ) OR (
                huiyingdai_borrow.borrow_style ='endday'
                <if test="borrowAprMin != null and borrowAprMin != ''">
                    AND huiyingdai_borrow_credit.bid_apr <![CDATA[>=]]>  #{borrowAprMin} * 30
                    <if test=" borrowAprMax != null and borrowAprMax != ''">
                        AND huiyingdai_borrow_credit.bid_apr <![CDATA[<]]> #{borrowAprMax} * 30
                    </if>
                </if>
            ))
        </where>
    </sql>

    <!--债权转让查询列-->
    <sql id="Credit_Base_Column_List" >
	    credit_id,
	    credit_nid,
	    credit_user_id,
	    bid_nid,
	    bid_apr,
	    bid_name,
	    borrow_style,
	    hbs.name AS borrow_style_name,
	    huiyingdai_borrow_credit.tender_nid,
	    credit_status,
	    credit_order,
	    credit_period,
	    credit_term,
	    credit_capital,
	    credit_account,
	    credit_interest,
	    credit_interest_advance,
	    credit_discount,
	    credit_income,
	    credit_fee,
	    credit_price,
	    credit_capital_assigned,
	    credit_interest_assigned,
	    credit_repay_account,
	    credit_repay_capital,
	    credit_repay_interest,
	    CASE
		WHEN credit_repay_end_time != 0 THEN
			FROM_UNIXTIME(credit_repay_end_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_end_time,
		CASE
		WHEN credit_repay_last_time != 0 THEN
			FROM_UNIXTIME(credit_repay_last_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_last_time,
		CASE
		WHEN credit_repay_next_time != 0 THEN
			FROM_UNIXTIME(credit_repay_next_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_next_time,
		CASE
		WHEN credit_repay_yes_time != 0 THEN
			FROM_UNIXTIME(credit_repay_yes_time, '%Y-%m-%d')
		ELSE
			''
		END AS credit_repay_yes_time,
	    create_date,
	    CASE
		WHEN add_time != 0 THEN
			FROM_UNIXTIME(add_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS add_time,
		add_time AS add_time_int,
		CASE
		WHEN end_time != 0 THEN
			FROM_UNIXTIME(end_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS end_time,
		CASE
		WHEN assign_time != 0 THEN
			FROM_UNIXTIME(assign_time, '%Y-%m-%d %H:%i:%s')
		ELSE
			''
		END AS assign_time,
		assign_num,
	    recover_period,
	   case when credit_capital>credit_capital_assigned and truncate(credit_capital_assigned/credit_capital*100,2)=100.00 then 99 else truncate(credit_capital_assigned/credit_capital*100,2) end   AS credit_inProgress
	</sql>

    <!--web端查询计划专区上部统计数据-->
    <select id="searchPlanData" resultType="map" >
				SELECT
			count(hha.id) + (
				SELECT
					count(dpa.id) AS total_record
				FROM
					hyjf_debt_plan_accede dpa
			) AS accedeTimes,
			FORMAT(
				(IFNULL(sum(hha.accede_account), 0) + (
					SELECT
						IFNULL(sum(dpa.accede_account), 0)
					FROM
						hyjf_debt_plan_accede dpa
				))/10000,
				2
			) AS accedeAccountTotal,
			FORMAT(
				(IFNULL(
					sum(hha.received_interest),
					0
				) + (
					SELECT
						IFNULL(
							sum(dpa.repay_interest_yes),
							0
						)
					FROM
						hyjf_debt_plan_accede dpa
				))/10000,
				2
			) AS interestTotal
		FROM
			hyjf_hjh_accede hha

	</select>

    <select id="searchWebPlanList" resultMap="HjhPlanMap" parameterType="Map">
        SELECT
        hp.plan_nid AS plan_nid,
        hp.plan_name AS plan_name,
        hp.expect_apr AS expect_apr,
        hp.lock_period AS lock_period,
        hp.is_month,
        CASE
        WHEN hp.plan_invest_status = 1
        THEN FORMAT(IF(hp.available_invest_account <![CDATA[<=]]> 0, 0, hp.available_invest_account) , 2)
        WHEN hp.plan_invest_status = 2
        THEN '0.00'
        ELSE '0.00'
        END AS available_invest_account,
        hp.plan_invest_status AS plan_invest_status,
        CASE
        WHEN hp.plan_invest_status = 1 AND FORMAT(hp.available_invest_account , 2) <![CDATA[<=]]> 0.00
        THEN '稍后开启'
        WHEN hp.plan_invest_status = 1
        THEN '立即加入'
        WHEN hp.plan_invest_status = 2
        THEN '稍后开启'
        ELSE ''
        END AS plan_invest_status_name
        FROM
        ht_hjh_plan hp
        <include refid="Web_Plan_Where_Clause" />
        ORDER BY
        <if test="isHome != null" >
            hp.lock_period asc,
            hp.plan_invest_status asc, hp.available_invest_account desc, hp.id
        </if>
        <if test="isHome == null" >
            hp.is_month asc,
            hp.lock_period asc,
            hp.id
        </if>
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>

    <select id="countWebPlanList" resultType="java.lang.Integer" parameterType="java.util.Map">
        SELECT
        count(hp.id) AS recordTotal
        FROM
        hyjf_hjh_plan hp
        <include refid="Web_Plan_Where_Clause" />
    </select>

    <sql id="Web_Plan_Where_Clause">
        <where>
            hp.del_flg = 0
            AND hp.plan_display_status = 1
            <if test="isHome != null" >
                AND hp.is_month = 1
                AND hp.lock_period IN(1 , 3 , 6 , 12)
            </if>
        </where>
    </sql>

    <!-- >>>>>>>>>>>>>>>>>>>>>>>>>>web end<<<<<<<<<<<<<<<<<<<<<<<<<<<-->
    <!-- >>>>>>>>>>>>>>>>>>>>>>>>>>app start<<<<<<<<<<<<<<<<<<<<<<<<<<<-->

    <select id="countAppProject" resultType="int">
        SELECT
        COUNT(hydb.borrow_nid) AS total
        FROM
        huiyingdai_borrow hydb
        LEFT JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
        <include refid="App_Where_Clause" />
    </select>

    <select id="searchAppProjectList"  resultMap="ProjectListNewMap" parameterType="Map">
        SELECT
        hydbpt.borrow_class AS borrow_type,
        hydbpt.borrow_name AS borrow_desc,
        hydb.borrow_nid,

        hydb.borrow_nid AS borrow_name,

        hydb.borrow_apr,
        CASE WHEN hydb.borrow_style = 'endday'
        THEN CONCAT(hydb.borrow_period, '天')
        ELSE CONCAT(hydb.borrow_period, '个月')
        END borrow_period,
        hydb.borrow_period borrow_period_int,
        CASE WHEN hydb.borrow_style = 'endday' THEN '天' ELSE '个月' END borrow_period_type,
        CASE
        WHEN hydb.account >= 10000 THEN
        CASE
        WHEN hydb.account % 10000 = 0 THEN
        CONCAT(
        FORMAT((hydb.account / 10000), 0),
        '万'
        )
        WHEN hydb.account % 10000 <![CDATA[<>]]> 0
        AND hydb.account % 1000 = 0 THEN
        CONCAT(
        FORMAT(hydb.account / 10000, 1),
        '万'
        )
        WHEN hydb.account % 10000 <![CDATA[<>]]> 0
        AND hydb.account % 1000 <![CDATA[<>]]> 0
        AND hydb.account % 100 = 0 THEN
        CONCAT(
        FORMAT(hydb.account / 10000, 2),
        '万'
        )
        WHEN hydb.account % 10000 <![CDATA[<>]]> 0
        AND hydb.account % 1000 <![CDATA[<>]]> 0
        AND hydb.account % 100 <![CDATA[<>]]> 0
        AND hydb.account % 10 = 0 THEN
        CONCAT(
        FORMAT(hydb.account / 10000, 3),
        '万'
        )
        ELSE
        CONCAT(
        FORMAT(hydb.account/ 10000, 4),
        '万'
        )
        END
        ELSE
        CONCAT(
        FORMAT(hydb.account, 0),
        '元'
        )
        END AS borrow_total,
        hydb.borrow_account_scale AS borrow_schedule,
        CASE
        WHEN hydb.`status` = 1 AND hydb.verify_status = 3 THEN '10'
        WHEN hydb.`status` = 2 AND ( hydb.verify_time + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) ) THEN '11'
        WHEN hydb.`status` = 3 THEN '12'
        WHEN hydb.`status` = 4 THEN '13'
        ELSE
        ''
        END AS tstatus,
        CONCAT(#{host},'?borrowNid=',hydb.borrow_nid) AS borrow_url,
        CASE
        WHEN hydb.`status` = 1 AND hydb.verify_status =3
        THEN FROM_UNIXTIME( hydb.ontime, '%m-%d %H:%i' )
        ELSE ''
        END AS on_time,
        (hydb.borrow_interest_coupon or hydb.borrow_taste_money) as couponEnable,
        case when hydb.borrow_extra_yield=0 then
        ''
        else
        CONCAT('+',hydb.borrow_extra_yield, '%')
        end
        borrow_extra_yield,
        case
        when hydb.project_type = 4 then 'XSH'
        when hydb.project_type = 11 then 'ZXH'
        when hydb.project_type = 13 then 'HJLC'
        else 'HZT'
        end project_type_code,
        IFNULL(hydb.borrow_account_wait,0) borrow_account_wait
        FROM
        huiyingdai_borrow hydb
        LEFT JOIN huiyingdai_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
        <include refid="App_Where_Clause" />
        ORDER BY
        hydb.`status` ASC,
        <if test="planform != null and planform =='wx'" >
            hydb.borrow_account_scale DESC,
        </if>
        CASE
        WHEN hydb.`status` = '1' AND hydb.verify_status = 3 AND hydb.ontime IS NOT NULL AND LENGTH(trim(hydb.ontime)) <![CDATA[>]]> 1
        THEN
        hydb.ontime
        END ASC,
        CASE
        WHEN hydb.`status` = '2'
        THEN hydb.borrow_account_scale
        END DESC,
        CASE
        WHEN hydb.`status` = '2' and hydb.borrow_account_scale=0
        THEN hydb.addtime
        END DESC,
        CASE
        WHEN hydb.`status` = '3'
        THEN hydb.addtime
        END DESC,
        CASE
        WHEN hydb.`status` = '4'
        THEN hydb.addtime
        END DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>


    </select>

    <sql id="App_Where_Clause">
        <where>
            <if test="projectType == null or projectType == ''">
                (hydbpt.borrow_project_type ='HZT' OR hydbpt.borrow_project_type ='HXF')
            </if>
            <if test="projectType != null and projectType != ''">
                hydbpt.borrow_project_type = 'HZT'
            </if>
            <if test="type != null and type != ''">
                AND hydb.project_type = #{type,jdbcType=VARCHAR}
            </if>
            <if test="(type == null or type == '') and projectType!='CFH' and projectType!='ZQ'">
                AND hydb.project_type <![CDATA[<>]]> '4'
                <if test="projectType == 'HZT'">
                    AND CASE
                    WHEN  ( hydb.`status` = 1 AND hydb.verify_status = 3)
                    THEN
                    hydb.ontime + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    ELSE
                    hydb.verify_time + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                    END
                </if>
                AND hydb.project_type <![CDATA[<>]]> '11'
                <!-- 融通宝过滤 -->
                <if test="version != null and version != '' and '1.4.2' > version ">
                    AND hydb.project_type <![CDATA[<>]]> '13'
                </if>
            </if>
            <!-- 包含汇直投、尊享汇、新手汇  modify by cwyang 改版要求债权页面除新手汇项目其他投资项目 -->
            <if test="(type == null or type == '') and projectType=='CFH' ">
                AND hydb.project_type NOT IN (4,8)
                AND CASE
                WHEN ( hydb.`status` = 1 AND ( hydb.verify_status = 3 ) AND ( EXISTS ( SELECT 1 FROM huiyingdai_borrow_bail bb WHERE bb.borrow_nid = hydb.borrow_nid ) ) )
                THEN
                hydb.ontime + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                ELSE
                hydb.verify_time + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                END
            </if>
            <!-- 包含汇直投、尊享汇、融通宝 -->
            <if test="(type == null or type == '') and projectType=='ZQ' ">
                AND hydb.project_type NOT IN (4,8)
                AND CASE
                WHEN ( hydb.`status` = 1 AND ( hydb.verify_status = 3 ) AND ( EXISTS ( SELECT 1 FROM huiyingdai_borrow_bail bb WHERE bb.borrow_nid = hydb.borrow_nid ) ) )
                THEN
                hydb.ontime + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                ELSE
                hydb.verify_time + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() )
                END
            </if>
            <if test="status == null or status == ''">
                AND
                (
                ( hydb.`status` = 1 AND hydb.verify_status = 3 )
                OR ( hydb.`status` = 2 AND hydb.verify_time + ( borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                OR ( hydb.`status` = 3 )
                OR ( hydb.`status` = 4 )
                )
            </if>
            <choose>
                <!-- 获取待发布 -->
                <when test="status == '10'">
                    AND ( hydb.`status` = 1 AND hydb.verify_status = 3 )
                </when>
                <!-- 获取 投资中 -->
                <when test="status == '11'">
                    AND ( hydb.`status` = 2 AND hydb.verify_time + ( borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                </when>
                <!-- 获取 投标结束 -->
                <when test="status == '12'">
                    AND (hydb.`status` = 3)
                </when>
                <!-- 获取 还款中 3天内-->
                <when test="status == '13'">
                    AND (hydb.`status` = 4 AND borrow_success_time <![CDATA[>=]]> UNIX_TIMESTAMP( NOW() )-(60*60*24*3))
                </when>
                <!-- 新手汇 定时发标 -->
                <when test="status == '14'">
                    AND ( hydb.`status` = 1 AND hydb.project_type = 4 AND hydb.verify_status = 3 )
                </when>
                <!-- 新手汇 投资中 -->
                <when test="status == '15'">
                    AND ( hydb.`status` = 2 AND hydb.project_type = 4 AND hydb.verify_time + ( hydb.borrow_valid_time * 24 * 60 *60 ) <![CDATA[>]]> UNIX_TIMESTAMP( NOW() ) )
                </when>
            </choose>
            <if test="termStart != null and termStart != ''">
                AND CASE
                WHEN hydb.borrow_style = 'endday' THEN
                hydb.borrow_period/30 <![CDATA[>=]]>#{termStart,jdbcType=INTEGER}
                ELSE hydb.borrow_period <![CDATA[>=]]>#{termStart,jdbcType=INTEGER}
                END
            </if>
            <if test="termEnd != null and termEnd != ''">
                AND
                CASE
                WHEN hydb.borrow_style = 'endday' THEN hydb.borrow_period / 30 <![CDATA[<=]]> #{termEnd,jdbcType=INTEGER}
                ELSE hydb.borrow_period <![CDATA[<=]]> #{termEnd,jdbcType=INTEGER}
                END
            </if>
            <if test="interestStart != null and interestStart != ''">
                AND hydb.borrow_apr <![CDATA[>=]]>#{interestStart,jdbcType=INTEGER}
            </if>
            <if test="interestEnd != null and interestEnd != ''">
                AND hydb.borrow_apr <![CDATA[<=]]>#{interestEnd,jdbcType=INTEGER}
            </if>
            <if test="projectCd != null and projectCd != ''">
                AND hydbpt.borrow_cd = #{projectCd,jdbcType=INTEGER}
            </if>
            AND hydb.is_show <![CDATA[<>]]> 1

            <if test="publishInstCode != null and publishInstCode != ''">
                AND (hydb.publish_inst_code = #{publishInstCode,jdbcType=VARCHAR} OR hydb.publish_inst_code ='0')
            </if>

        </where>
    </sql>

    <!--app 债转count-->
    <select id="countAppCredit" resultType="int" parameterType="Map">
        SELECT
        COUNT(credit_nid)
        from huiyingdai_borrow_credit
        INNER JOIN huiyingdai_borrow ON huiyingdai_borrow_credit.bid_nid = huiyingdai_borrow.borrow_nid INNER JOIN huiyingdai_borrow_style hbs
        ON hydb.borrow_style = hbs.nid
        <include refid="Credit_Common_Where_Column"/>
    </select>


    <!--app 债转list-->
    <select id="searchAppCreditList" resultMap="ProjectListNewMap" parameterType="java.util.Map">
        select
        CONCAT('HZR',hydc.credit_nid ) AS borrow_nid,
        CONCAT('HZR',hydc.credit_nid ) AS borrow_name,
        '汇转让' AS borrow_desc,
        'HZR' AS borrow_type,
        hydc.bid_apr AS borrow_apr,
        hydc.credit_capital-hydc.credit_capital_assigned AS credit_inProgress,
        CASE
        WHEN hydc.credit_capital >= 10000 THEN
        CASE
        WHEN hydc.credit_capital % 10000 = 0 THEN
        CONCAT(
        FORMAT((hydc.credit_capital / 10000), 0),
        '万'
        )
        WHEN hydc.credit_capital % 10000 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 1000 = 0 THEN
        CONCAT(
        FORMAT(hydc.credit_capital / 10000, 1),
        '万'
        )
        WHEN hydc.credit_capital % 10000 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 1000 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 100 = 0 THEN
        CONCAT(
        FORMAT(hydc.credit_capital / 10000, 2),
        '万'
        )
        WHEN hydc.credit_capital % 10000 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 1000 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 100 <![CDATA[<>]]> 0
        AND hydc.credit_capital % 10 = 0 THEN
        CONCAT(
        FORMAT(hydc.credit_capital / 10000, 3),
        '万'
        )
        ELSE
        CONCAT(
        FORMAT(hydc.credit_capital/ 10000, 4),
        '万'
        )
        END
        ELSE
        CONCAT(
        FORMAT(hydc.credit_capital, 0),
        '元'
        )
        END AS borrow_total,
        hydc.credit_term AS borrow_period,
        '11' AS tstatus,
        '' AS on_time,
        truncate(hydc.credit_capital_assigned/hydc.credit_capital,2)*100 AS borrow_schedule,
        CONCAT(#{host},'?creditNid=',hydc.credit_nid) AS borrow_url,
        hydc.add_time AS add_time,
        '0' AS couponEnable
        from huiyingdai_borrow_credit hydc
        INNER JOIN huiyingdai_borrow hydb
        ON hydc.bid_nid = hydb.borrow_nid
        INNER JOIN huiyingdai_borrow_style hbs
        ON hydb.borrow_style = hbs.nid
        <include refid="Credit_Common_Where_Column"/>
        ORDER BY
        borrow_schedule DESC, borrow_period DESC
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>

    <!--app债转list-->
    <select id="searchAppPlanList" resultMap="HjhPlanMap" parameterType="Map">
        SELECT
        hp.plan_nid AS plan_nid,
        hp.plan_name AS plan_name,
        hp.expect_apr AS expect_apr,
        hp.lock_period AS lock_period,
        hp.is_month,
        CASE
        WHEN hp.plan_invest_status = 1
        THEN FORMAT(IF(hp.available_invest_account <![CDATA[<=]]> 0, 0, hp.available_invest_account) , 2)
        WHEN hp.plan_invest_status = 2
        THEN '0.00'
        ELSE '0.00'
        END AS available_invest_account,
        hp.plan_invest_status AS plan_invest_status,
        CASE
        WHEN hp.plan_invest_status = 1 AND FORMAT(hp.available_invest_account , 2) <![CDATA[<=]]> 0.00
        THEN '稍后开启'
        WHEN hp.plan_invest_status = 1
        THEN '立即加入'
        WHEN hp.plan_invest_status = 2
        THEN '稍后开启'
        ELSE ''
        END AS plan_invest_status_name
        FROM
        hyjf_hjh_plan hp
        <include refid="App_PLan_Where_Clause" />
        ORDER BY
        <if test="isHome != null" >
            hp.lock_period asc,
            hp.plan_invest_status asc, hp.available_invest_account desc, hp.id
        </if>
        <if test="isHome == null" >
            hp.is_month asc,
            hp.lock_period asc,
            hp.id
        </if>
        <if test="limitStart != null and limitEnd !=null" >
            LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
        </if>
    </select>

    <!--app计划list-->
    <select id="countAppPlanList" resultType="java.lang.Integer" parameterType="java.util.Map">
        SELECT
        count(hp.id) AS recordTotal
        FROM
        hyjf_hjh_plan hp
        <include refid="App_PLan_Where_Clause" />
    </select>

    <!--app计划where-->
    <sql id="App_PLan_Where_Clause">
        <where>
            hp.del_flg = 0
            AND hp.plan_display_status = 1
            <if test="isHome != null" >
                AND hp.is_month = 1
                AND hp.lock_period IN(1 , 3 , 6 , 12)
            </if>
        </where>
    </sql>

    <!-- >>>>>>>>>>>>>>>>>>>>>>>>>>app end<<<<<<<<<<<<<<<<<<<<<<<<<<<-->


</mapper>