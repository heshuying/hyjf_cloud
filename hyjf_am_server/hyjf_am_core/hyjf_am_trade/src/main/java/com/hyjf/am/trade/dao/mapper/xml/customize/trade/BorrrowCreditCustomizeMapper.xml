<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.trade.BorrowCreditCustomizeMapper">

    <select id="getBorrowCreditDetail" resultType="com.hyjf.am.vo.trade.borrow.BorrowCreditDetailVO" parameterType="map">
        SELECT	hb.project_type type,
        hb.company_or_personal AS comOrPer,
        hb.borrow_nid AS borrowNid,
        hb.borrow_apr AS borrowApr,
        hb.borrow_style AS borrowStyle,
        hbc.credit_nid AS creditNid,
        hbc.tender_nid AS tenderNid,
        hbc.credit_capital AS creditCapital,
        (
        hbc.credit_capital - hbc.credit_capital_assigned
        ) AS creditAssignCapital,
        hbc.credit_discount AS creditDiscount,
        hbc.credit_term AS creditTerm,
        hbc.credit_term_hold AS creditTermHold,
        CASE
        WHEN hb.borrow_style = 'endday' THEN
        CONCAT(hb.borrow_period, '天')
        ELSE
        CONCAT(hb.borrow_period, '个月')
        END borrowPeriod,
        hbc.credit_price AS creditPrice,
        FROM_UNIXTIME(
        hbc.create_time,
        '%Y-%m-%d %H:%i:%s'
        ) AS creditTime,
        hbc.create_time AS creditTimeInt,
        hui.truename AS creditUserTrueName,
        hbc.credit_user_id AS creditUserId,
        hbc.credit_repay_end_time AS creditRepayEndTime,
        CASE
        WHEN hb.`status` = 0
        AND hb.verify_status = 1 THEN
        '10'
        WHEN hb.`status` = 1
        AND hb.borrow_status = 1
        AND hb.borrow_account_yes <![CDATA[<]]> hb.account
        AND (
        hb.verify_time + (
        hb.borrow_valid_time * 24 * 60 * 60
        ) > UNIX_TIMESTAMP(NOW())
        ) THEN
        '11'
        WHEN hb.`status` = 1
        AND hb.reverify_time = '0'
        AND (
        (
        hb.reverify_status = 0
        AND hb.borrow_account_yes >= hb.account
        )
        OR (
        hb.verify_time + (
        hb.borrow_valid_time * 24 * 60 * 60
        ) <![CDATA[<]]> UNIX_TIMESTAMP(NOW())
        )
        ) THEN
        '12'
        WHEN hb.`status` = 3
        AND hb.repay_full_status = 0 THEN
        '13'
        WHEN hb.`status` = 3
        AND hb.repay_full_status = 1 THEN
        '14'
        <!-- WHEN hb.`status` = 2 THEN
            '15' -->
        ELSE
        ''
        END AS `status`
        FROM
        ht_borrow_credit hbc
        LEFT JOIN ht_borrow hb ON hbc.bid_nid = hb.borrow_nid
        LEFT JOIN ht_users hu ON hu.user_id = hbc.credit_user_id
        LEFT JOIN ht_users_info hui ON hui.user_id = hu.user_id
        WHERE
        hbc.credit_nid = #{creditNid}
    </select>



    <select id="getAppCreditDetailByCreditNid" resultType="com.hyjf.am.vo.trade.hjh.AppCreditDetailCustomizeVO" parameterType="java.util.Map">
        SELECT
        <!-- 项目编号 -->
        hbc.credit_nid AS creditNid,
        <!-- 画面表示的项目编号 -->
        CONCAT('HZR',hbc.credit_nid ) AS creditNidPage,
        <!-- 项目期限 -->
        CONCAT(hbc.credit_term ,'天') AS borrowPeriod,
        <!-- 项目期限 -->
        hbc.credit_term AS creditTerm,
        <!-- 债权已 持有天数 -->
        hbc.credit_term_hold creditTermHold,
        <!-- 债转状态 -->
        hbc.credit_status AS status,
        <!-- 债转本金 -->
        hbc.credit_capital AS creditCapital,
        <!-- 项目剩余 可投资金额 -->
        (hbc.credit_capital - hbc.credit_capital_assigned) AS investAccount,
        <!-- 折价比率 -->
        hbc.credit_discount AS creditDiscount,
        <!-- 还款方式 -->
        hydbs.name AS repayStyle,
        <!-- 原项目 -->
        hbc.bid_nid AS bidNid,
        <!-- 原表年化利率 -->
        hbc.bid_apr AS bidApr,
        <!-- 转让时间 -->
        FROM_UNIXTIME(hbc.create_time,'%Y-%m-%d %H:%i:%s') AS creditTime,
        <!-- 截止时间 -->
        FROM_UNIXTIME(hbc.end_time,'%Y-%m-%d %H:%i:%s') AS endTime,
        <!-- 成功时间 -->
        FROM_UNIXTIME(hbc.assign_time,'%Y-%m-%d %H:%i:%s') AS assignTime,
        <!-- 投资进度 -->
        truncate(hbc.credit_capital_assigned/hbc.credit_capital*100,2) AS borrowSchedule
        FROM
        ht_borrow_credit hbc
        LEFT JOIN ht_borrow hb ON hbc.bid_nid = hb.borrow_nid
        LEFT JOIN ht_borrow_style hydbs ON hydbs.nid = hb.borrow_style
        WHERE
        hbc.credit_nid = #{creditNid}
    </select>

    <select id="getBorrowCreditList4Admin" resultMap="selectBorrowCreditListMap" parameterType="Map">
        SELECT
        bc.credit_id,
        bc.credit_nid,
        CASE
            WHEN bc.client = 1 THEN '微信'
            WHEN bc.client = 2 THEN 'android'
            WHEN bc.client = 3 THEN  'ios'
            WHEN bc.client = 0 THEN  'pc'
        ELSE '其他' END  as client,
        bc.bid_nid,
        u.username,
        FORMAT(bc.credit_capital, 2) AS credit_capital,
        FORMAT(bc.credit_capital, 2) AS credit_capital_price,
        CONCAT(credit_discount, '%') AS credit_discount,
        FORMAT(bc.credit_price, 2) AS credit_price,
        bc.credit_capital_assigned,
        CASE
            WHEN bc.credit_status = '1' THEN '停止'
            WHEN bc.credit_status = '2' THEN '完全承接'
        ELSE
        '进行中'
        END AS credit_status_name,
        CASE WHEN bc.repay_status= 0 THEN '未还款'
            WHEN bc.repay_status = 1 THEN '还款成功'
            WHEN bc.repay_status = 2 THEN '还款失败'
        ELSE '还款失败' END AS repay_status_name,
        CASE
            WHEN bc.credit_status = '1' THEN '1'
            WHEN bc.credit_status = '2' THEN '2'
        ELSE
        CASE
          WHEN bc.end_time  <![CDATA[<]]> UNIX_TIMESTAMP(NOW()) THEN '1'
        ELSE
        '0'
        END
        END AS credit_status,
        CASE WHEN bc.create_time != 0 AND bc.create_time IS NOT NULL THEN FROM_UNIXTIME( bc.create_time, '%Y-%m-%d %H:%i:%s' ) ELSE '' END AS add_time,
        CASE WHEN b.repay_last_time != 0 AND b.repay_last_time IS NOT NULL THEN FROM_UNIXTIME( b.repay_last_time, '%Y-%m-%d %H:%i:%s' ) ELSE '' END AS repay_last_time
        FROM
          ht_borrow_credit bc
        INNER JOIN ht_borrow b ON bc.bid_nid = b.borrow_nid
        LEFT JOIN ht_r_user u ON u.user_id = bc.credit_user_id
        <include refid="Where_Clause" />
        ORDER BY
        bc.create_time DESC
        <if test="limitStart >= 0" >
            LIMIT #{limitStart} , #{limitEnd}
        </if>
    </select>

    <select id="countBorrowCreditList4Admin" parameterType="map" resultType="int">
        SELECT
          count(bc.credit_id)
        FROM
        ht_borrow_credit bc
        INNER JOIN ht_borrow b ON bc.bid_nid = b.borrow_nid
        <include refid="Where_Clause" />

    </select>

    <select id="getBorrowCreditTotalCount" resultMap="sumBorrowCreditMap"  parameterType="map">

        SELECT
            SUM(bc.credit_capital) AS credit_capital,
            SUM(bc.credit_capital) AS credit_capital_price,
            SUM(bc.credit_price) AS credit_price,
            SUM(bc.credit_capital_assigned) AS credit_capital_assigned
        FROM
        ht_borrow_credit bc
        INNER JOIN ht_borrow b ON bc.bid_nid = b.borrow_nid
        <include refid="Where_Clause" />
    </select>



    <resultMap id="sumBorrowCreditMap" type="com.hyjf.am.vo.admin.BorrowCreditSumVO">
        <result column="credit_capital" property="sumCreditCapital" jdbcType="VARCHAR" />
        <result column="credit_capital_price" property="sumCreditCapitalPrice" jdbcType="VARCHAR" />
        <result column="credit_price" property="sumCreditPrice" jdbcType="VARCHAR" />
        <result column="credit_capital_assigned" property="sumCreditCapitalAssigned" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="selectBorrowCreditListMap" type="com.hyjf.am.trade.dao.model.customize.admin.AdminBorrowCreditCustomize">
        <result column="credit_id" property="creditId" jdbcType="VARCHAR" />
        <result column="credit_nid" property="creditNid" jdbcType="VARCHAR" />
        <result column="bid_nid" property="bidNid" jdbcType="VARCHAR" />
        <result column="username" property="userName" jdbcType="VARCHAR" />
        <result column="credit_capital" property="creditCapital" jdbcType="VARCHAR" />
        <result column="credit_discount" property="creditDiscount" jdbcType="VARCHAR" />
        <result column="credit_capital_price" property="creditCapitalPrice" jdbcType="VARCHAR" />
        <result column="credit_price" property="creditPrice" jdbcType="VARCHAR" />
        <result column="credit_capital_assigned" property="creditCapitalAssigned" jdbcType="VARCHAR" />
        <result column="credit_status_name" property="creditStatusName" jdbcType="VARCHAR" />
        <result column="repay_status_name" property="repayStatusName" jdbcType="VARCHAR" />
        <result column="credit_status" property="creditStatus" jdbcType="VARCHAR" />
        <result column="add_time" property="addTime" jdbcType="VARCHAR" />
        <result column="repay_last_time" property="repayLastTime" jdbcType="VARCHAR" />
        <result column="client" property="client" jdbcType="VARCHAR" />
    </resultMap>


    <sql id="Where_Clause">
        <where>
            <!-- 项目编号 -->
            <if test="bidNid != null and bidNid != ''">
                AND bc.bid_nid LIKE CONCAT('%', #{bidNid}, '%')
            </if>
            <!-- 债转编号 -->
            <if test="creditNid != null and creditNid != ''">
                AND bc.credit_nid LIKE CONCAT('%', #{creditNid}, '%')
            </if>
            <!-- 用户名 -->
            <if test="userName != null and userName != ''">
                AND u.username LIKE CONCAT('%', #{userName}, '%')
            </if>
            <!-- 承接人-->
            <if test="creditUsername != null and creditUsername != ''">
                AND credit_users.username LIKE CONCAT('%', #{creditUsername}, '%')
            </if>
            <!-- 订单号-->
            <if test="assignNid != null and assignNid != ''">
                AND ct.assign_nid LIKE CONCAT('%', #{assignNid}, '%')
            </if>
            <!-- 客户端-->
            <if test="client != null and client != ''">
                AND bc.client=#{client}
            </if>
            <!-- 转让状态 -->
            <if test="creditStatus == '1'.toString()">
                AND ( bc.credit_status = 1 OR ( bc.credit_status = 0 AND bc.create_time  <![CDATA[<]]> UNIX_TIMESTAMP(NOW()) ) )
            </if>
            <!-- 转让状态 -->
            <if test="creditStatus == '2'.toString()">
                AND bc.credit_status = 2
            </if>
            <!-- 转让状态 -->
            <if test="creditStatusSrch == '0'.toString()">
                AND ( bc.credit_status = 0 AND bc.create_time  <![CDATA[>=]]> UNIX_TIMESTAMP(NOW()) )
            </if>
            <!-- 时间 -->
            <if test="timeStart != null and timeStart != ''">
                AND bc.create_time <![CDATA[>=]]> unix_timestamp(#{timeStartSrch})
            </if>
            <if test="timeEnd != null and timeEnd != ''">
                AND bc.create_time <![CDATA[<=]]> unix_timestamp(#{timeEndSrch})+86399
            </if>
        </where>
    </sql>


</mapper>