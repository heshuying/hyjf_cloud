<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
		namespace="com.hyjf.am.trade.dao.mapper.customize.BorrowTenderCustomizeMapper">
	<select id="getUtmTenderNum" resultType="INTEGER" >
		SELECT count(*) FROM (
			SELECT user_id FROM ht_borrow_tender
			UNION ALL
			SELECT user_id FROM ht_product_list
			UNION ALL
			SELECT user_id FROM ht_debt_plan_accede
			UNION ALL
			SELECT user_id FROM ht_credit_tender) a
			<where>
				<if test="type != null and type != ''">
					AND a.client=#{type}
				</if>
				<if test="list != null and list.size() > 0">
					and a.user_id in
					<foreach collection="list" item="item" index="index" open="("  separator="," close=")" >
						#{item}
					</foreach>
				</if>
				<if test="dayStart != null and dayStart != ''">
					AND a.create_time <![CDATA[>=]]> #{dayStart}
				</if>
				<if test="dayEnd != null and dayEnd != ''">
					AND a.create_time <![CDATA[<=]]> #{dayEnd}
				</if>
			</where>
			
	</select>
	
	<select id="getHztTenderPrice" resultType="DECIMAL" >
		select sum(hbt.account) from ht_borrow_tender hbt left join ht_borrow hb on hbt.borrow_nid = hb.user_id
		<where>
			hb.project_type <![CDATA[<>]]> 8
			AND hb.project_type <![CDATA[<>]]> 13
			<if test="list != null and list.size() > 0">
			and hbt.user_id in
				<foreach collection="list" item="item" index="index" open="("  separator="," close=")" >
					#{item}
				</foreach>
			</if>
			<if test="dayStart != null and dayStart != ''">
				AND hbt.create_time <![CDATA[>=]]> #{dayStart}
			</if>
			<if test="dayEnd != null and dayEnd != ''">
				AND hbt.create_time <![CDATA[<=]]> #{dayEnd}
			</if>
		</where>
	</select>
	
	<select id="getHxfTenderPrice" resultType="DECIMAL" >
		select sum(hbt.account) from ht_borrow_tender hbt left join ht_borrow hb on hbt.borrow_nid = hb.user_id
		<where>
			hb.project_type = 8
			<if test="list != null and list.size() > 0">
				and hbt.user_id in
				<foreach collection="list" item="item" index="index" open="("  separator="," close=")" >
					#{item}
				</foreach>
			</if>
			<if test="dayStart != null and dayStart != ''">
				AND hbt.create_time <![CDATA[>=]]> #{dayStart}
			</if>
			<if test="dayEnd != null and dayEnd != ''">
				AND hbt.create_time <![CDATA[<=]]> #{dayEnd}
			</if>
		</where>
	</select>
	
	<select id="getRtbTenderPrice" resultType="DECIMAL" >
	select sum(hbt.account) from ht_borrow_tender hbt left join ht_borrow hb on hbt.borrow_nid = hb.user_id
		<where>
			hb.project_type = 13
			<if test="list != null and list.size() > 0">
				and hbt.user_id in
				<foreach collection="list" item="item" index="index" open="("  separator="," close=")" >
					#{item}
				</foreach>
			</if>
			<if test="dayStart != null and dayStart != ''">
				AND hbt.create_time <![CDATA[>=]]> #{dayStart}
			</if>
			<if test="dayEnd != null and dayEnd != ''">
				AND hbt.create_time <![CDATA[<=]]> #{dayEnd}
			</if>
		</where>
	</select>

	<resultMap id="currentCouponRecover" type="com.hyjf.am.vo.trade.coupon.CouponRecoverCustomizeVO">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="recover_interest" property="recoverInterest" jdbcType="VARCHAR" />
		<result column="recover_account" property="recoverAccount" jdbcType="VARCHAR" />
		<result column="recover_capital" property="recoverCapital" jdbcType="VARCHAR" />
		<result column="coupon_type" property="couponType" jdbcType="INTEGER" />
		<result column="coupon_user_code" property="couponUserCode" jdbcType="VARCHAR" />
	</resultMap>

	<select id="getCurrentCouponRecover" resultMap="currentCouponRecover" parameterType="java.util.Map">
			SELECT
				cr.id,
				cr.recover_interest,
				cr.recover_account,
				cr.recover_capital,
				cc.coupon_type,
				cu.coupon_user_code
			FROM
				ht_coupon_recover cr
			INNER JOIN ht_coupon_tender ct ON cr.tender_id = ct.order_id
			INNER JOIN ht_coupon_user cu ON ct.coupon_grant_id = cu.id
			INNER JOIN ht_coupon_config cc ON cu.coupon_code = cc.coupon_code
			WHERE
				cr.tender_id = #{tenderNid}
			AND cr.recover_period = #{periodNow}
			AND cr.recover_status = 0
			AND cr.received_flg = 1
			AND cr.del_flag = 0
			AND ct.del_flag = 0
			AND cu.del_flag = 0
			AND cc.del_flag = 0
	</select>

	<resultMap id="tenderNotifyMap" type="com.hyjf.am.vo.trade.wrb.WrbTenderNotifyCustomizeVO">
		<result column="user_id" property="userId" jdbcType="INTEGER"/>
		<result column="addtime" property="investTime" jdbcType="VARCHAR"/>
		<result column="nid" property="nid" jdbcType="VARCHAR"/>
		<result column="account" property="account" jdbcType="DECIMAL"/>
		<result column="invest_period" property="investPeriod" jdbcType="VARCHAR"/>
		<result column="borrow_apr" property="borrowApr" jdbcType="VARCHAR"/>
		<result column="borrow_style_name" property="borrowStyleName" jdbcType="VARCHAR"/>
		<result column="borrow_name" property="borrowName" jdbcType="VARCHAR"/>
		<result column="borrow_nid" property="borrowNid" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="selectWrbTenderInfo" resultMap="tenderNotifyMap">
		SELECT  t.user_id,
		FROM_UNIXTIME(t.create_time,'%Y-%m-%d %H:%i:%s'),
		t.nid,
		t.account,
		CASE WHEN b.borrow_style = 'endday' THEN b.borrow_period ELSE b.borrow_period*30 END AS invest_period,
		b.borrow_apr,
		s.name AS borrow_style_name,
		info.name AS borrow_name,
		b.borrow_nid AS borrow_nid
		FROM ht_borrow_tender t
		LEFT JOIN ht_borrow b ON b.borrow_nid = t.borrow_nid
		LEFT JOIN ht_borrow_info info ON info.id = b.id
		LEFT JOIN ht_borrow_style s ON s.nid = b.borrow_style
		WHERE t.user_id = #{userId}
		AND t.nid = #{nid}
	</select>

	<select id="getBorrowTenderByAddtime" resultMap="tenderNotifyMap" >
		SELECT
		tender.user_id,
		tender.borrow_nid,
		tender.account
		FROM
		ht_borrow_tender tender
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = tender.borrow_nid
		<where>
			<if test="sourceIdSrch != null and sourceIdSrch == 'hztTenderPrice'">
				borrow.project_type <![CDATA[<>]]> 8
				AND borrow.project_type <![CDATA[<>]]> 13
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'hxfTenderPrice'">
				borrow.project_type = 8
			</if>
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND tender.create_time  <![CDATA[>=]]>  timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND tender.create_time  <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>
	</select>

	<select id="getCreditTenderByAddtime" resultMap="tenderNotifyMap" >
		SELECT
		hct.user_id,
		hct.assign_capital as account
		FROM
		ht_credit_tender hct
		<where>
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND  hct.create_time <![CDATA[>=]]>  timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND hct.create_time <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>
	</select>

	<select id="getAccountRechargeByAddtime" resultMap="tenderNotifyMap" >
		SELECT
		recharge.user_id,
		recharge.money as account
		FROM
		ht_account_recharge recharge
		<where>
			recharge.`status` = 2
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND recharge.create_time <![CDATA[>=]]> timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND recharge.create_time <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>
	</select>

	<select id="getBorrowTenderByClient" resultMap="tenderNotifyMap" >
		SELECT
		tender.user_id
		FROM
		ht_borrow_tender tender
		<where>
			<if test="sourceIdSrch != null and sourceIdSrch == 'ios'">
				tender.client = 3
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'android'">
				tender.client = 2
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'pc'">
				tender.client = 0
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'wechat'">
				tender.client = 1
			</if>

			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND  tender.create_time <![CDATA[>=]]>  timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND  tender.create_time <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>
	</select>

	<select id="getProductListByClient" resultMap="tenderNotifyMap" >

		SELECT
		list.user_id
		FROM
		ht_product_list list
		<where>

			<if test="sourceIdSrch != null and sourceIdSrch == 'ios'">
				list.client = 3
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'android'">
				list.client = 2
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'pc'">
				list.client = 0
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'wechat'">
				list.client = 1
			</if>
			AND list.invest_status = 0
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND  list.invest_time <![CDATA[>=]]>  UNIX_TIMESTAMP(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND list.invest_time<![CDATA[<=]]>  UNIX_TIMESTAMP(#{timeEndSrch})
			</if>
		</where>

	</select>

	<select id="getDebtPlanAccedeByClient" resultMap="tenderNotifyMap" >
		SELECT
		hdpa.user_id
		FROM
		ht_debt_plan_accede hdpa
		<where>
			<if test="sourceIdSrch != null and sourceIdSrch == 'ios'">
				hdpa.client = 3
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'android'">
				hdpa.client = 2
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'pc'">
				hdpa.client = 0
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'wechat'">
				hdpa.client = 1
			</if>
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND hdpa.create_time <![CDATA[>=]]>  timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND hdpa.create_time <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>

	</select>

	<select id="getCreditTenderByClient" resultMap="tenderNotifyMap" >
		SELECT
		hct.user_id
		FROM
		ht_credit_tender hct
		<where>
			<if test="sourceIdSrch != null and sourceIdSrch == 'ios'">
				hct.client = 3
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'android'">
				hct.client = 2
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'pc'">
				hct.client = 0
			</if>
			<if test="sourceIdSrch != null and sourceIdSrch == 'wechat'">
				hct.client = 1
			</if>
			<if test="timeStartSrch != null and timeStartSrch != ''">
				AND hct.create_time  <![CDATA[>=]]>  timestamp(#{timeStartSrch})
			</if>
			<if test="timeEndSrch != null and timeEndSrch != ''">
				AND hct.create_time <![CDATA[<=]]>  timestamp(#{timeEndSrch})
			</if>
		</where>

	</select>

	<!--应急中心二期，历史数据上报，上报智投承接信息 start add by nxl-->
	<!--查找 未还款，转让被部分被承接的债权信息 -->
	<resultMap id="hjhDebtCreditCustomizeVO" type="com.hyjf.am.vo.trade.hjh.HjhDebtCreditCustomizeVO">
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="plan_nid" property="planNid" jdbcType="VARCHAR" />
		<result column="plan_order_id" property="planOrderId" jdbcType="VARCHAR" />
		<result column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
		<result column="credit_nid" property="creditNid" jdbcType="INTEGER" />
		<result column="credit_status" property="creditStatus" jdbcType="VARCHAR" />
		<result column="assign_order_id" property="assignOrderId" jdbcType="VARCHAR" />
		<result column="credit_capital" property="creditCapital" jdbcType="VARCHAR" />
		<result column="credit_capital_assigned" property="creditCapitalAssigned" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" jdbcType="VARCHAR" />
	</resultMap>
	<select id="getHjhDebtCreditInfoCustomize" resultMap="hjhDebtCreditCustomizeVO">
		SELECT
			dc.credit_capital,
			dc.credit_capital_assigned,
			dc.borrow_nid,
			dc.plan_nid,
			dc.plan_order_id,
			dc.credit_nid,
			dc.credit_status,
			dct.assign_order_id,
			dct.user_id,
			DATE_FORMAT(dct.create_time, '%Y-%m-%d') AS create_time
		FROM
			ht_hjh_debt_credit dc
		LEFT JOIN ht_hjh_debt_credit_tender dct ON dc.credit_nid = dct.credit_nid
		WHERE
			dc.credit_capital != dc.credit_capital_assigned
		AND dc.credit_capital_assigned != 0.00
		AND dc.repay_status = 0
		AND dc.credit_status != 2
		<!-- 测试用，要删除的-->
		LIMIT 0,3
	</select>
	<!--查找未还款的债权信息 add by nxl-->
	<resultMap id="borrowTenderCustomizeVO" type="com.hyjf.am.vo.trade.borrow.BorrowTenderCustomizeVO">
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="plan_nid" property="planNid" jdbcType="VARCHAR" />
		<result column="accede_order_id" property="accedeOrderId" jdbcType="VARCHAR" />
		<result column="nid" property="nid" jdbcType="VARCHAR" />
		<result column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" jdbcType="VARCHAR" />
	</resultMap>
	<select id="getBorrowTenderInfoCustomize" resultMap="borrowTenderCustomizeVO">
		SELECT
			hb.borrow_nid,
			hbt.accede_order_id,
			hha.plan_nid,
			hbt.user_id,
			hbt.nid,
		DATE_FORMAT(hbt.create_time,'%Y-%m-%d') as create_time
		FROM
			ht_borrow hb
		LEFT JOIN ht_borrow_tender hbt ON hb.borrow_nid = hbt.borrow_nid
		LEFT JOIN ht_hjh_accede hha ON hbt.accede_order_id = hha.accede_order_id
		WHERE
			hb.`status` IN (2, 3, 4)
		AND hha.accede_order_id != ''
		AND hha.plan_nid != ''
		<!-- 测试用，要删除的-->
		LIMIT 0,3
	</select>
	<!--应急中心二期，历史数据上报，上报智投承接信息 end add by nxl-->
</mapper>