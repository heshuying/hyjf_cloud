<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.AssetManageCustomizeMapper">

	<!-- 近期回款列表 -->
	<resultMap id="recentPaymentMap" type="com.hyjf.am.trade.dao.model.customize.RecentPaymentListCustomize">
		<result column="project_name" property="projectName" />
		<result column="borrow_apr" property="borrowApr" />
		<result column="invest_date" property="investDate" />
		<result column="total_wait" property="totalWait" />
		<result column="type" property="type" />
		<result column="coupon_type" property="couponType" />
		<result column="projectNid" property="projectNid" />
		<!--add by nxl 智投服务 添加退出中和是否是计划标识-->
		<result column="exit_flg" property="exitType" />
		<result column="hjh_flg"  property="hjhType" />
	</resultMap>
	<select id="selectRecentPaymentList" resultMap="recentPaymentMap" parameterType="java.util.Map">


		SELECT t.* FROM (
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time as orderby_invest_date,
		CASE
		WHEN hbc.credit_capital_assigned IS NOT NULL THEN 1
		ELSE 0 END type,
		0 coupon_type,
		IF(borrow.`status` = 8,8,0) as exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		0 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		IFNULL(rec.recover_capital_wait,ten.account)+
		IFNULL( rec.recover_interest_wait, 0 )-
		(SELECT IFNULL(SUM(ct.assign_interest - ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		)-
		(SELECT IFNULL(SUM(ct.assign_capital - ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		) total_wait
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover rec
		ON ten.nid = rec.nid
		AND rec.recover_capital > rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = ten.borrow_nid
		LEFT JOIN (SELECT hbc.tender_nid,
		MIN(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
        (borrow.`status` = 4
        <!-- 增加逾期中状态值 add by hesy 2019-04-03-->
        OR borrow.`status` = 8)
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		2 AS type,
		0 coupon_type,
        IF(borrow.`status` = 8,8,0) AS exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		0 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		(ten.assign_capital+ten.assign_interest) total_wait
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = ten.bid_nid
		WHERE ten.user_id= #{userId}
		AND (borrow.`status` = 4
        <!-- 增加逾期中状态值 add by hesy 2019-04-03-->
        OR borrow.`status` = 8)
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, hb.`borrow_nid`) AS project_name,
		hb.borrow_nid AS projectNid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hb.borrow_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(MAX(hcr.recover_time), '%Y-%m-%d' ) AS recover_time,
		MAX(hcr.recover_time),
		3 type,
		hcc.coupon_type coupon_type,
        IF(hb.`status` = 8,8,0) AS exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		0 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		IFNULL(SUM(hcr.recover_account),0) total_wait
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=0
		AND IFNULL(SUM(hcr.recover_account),0)>0
		UNION ALL
		SELECT
		IFNULL(borrowInfo.project_name, borrow.`borrow_nid`) AS project_name,
		borrow.borrow_nid AS projectNid,
		CONCAT(hiii.borrow_extra_yield, '%') borrow_apr,

		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		4 AS type,
		0 coupon_type,
        IF(borrow.`status` = 8,8,0) AS exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		0 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		hiii.repay_interest_wait AS total_wait
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = hiii.borrow_nid
		INNER JOIN (select * from ht_increase_interest_loan where user_id=#{userId}
		) hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE (borrow.`status` = 4
        <!-- 增加逾期中状态值 add by hesy 2019-04-03-->
        OR borrow.`status` = 8)
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		hhp.plan_name,
		<!-- hhp.plan_nid AS projectNid, -->
		hhp.plan_name AS projectNid,
		CONCAT(hha.expect_apr, '%') borrow_apr,
		IF(IFNULL(hha.quit_time,0)=0,'--',FROM_UNIXTIME(hha.quit_time, '%Y-%m-%d' )) AS quit_time,
		hha.last_payment_time,
		5 AS type,
		0 coupon_type,
		0 as exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		1 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		hha.wait_total wait_total
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp
		ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status=3
		AND hha.user_id=#{userId}
		<!-- add by nxl 智投服务 添加推出中的计划 start-->
		UNION ALL SELECT
		hhp.plan_name,
		hhp.plan_name AS projectNid,
		CONCAT(hha.expect_apr, '%') borrow_apr,
		IF(IFNULL(hha.quit_time,0)=0,'--',FROM_UNIXTIME(hha.quit_time, '%Y-%m-%d' )) AS quit_time,
		hha.last_payment_time,
		5 AS type,
		0 coupon_type,
		1 as exit_flg,<!-- add by nxl 智投服务,添加退出中标识 1 :退出中-->
		1 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		hha.wait_total wait_total
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp
		ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status= 5
		AND hha.user_id=#{userId}
		<!-- add by nxl 智投服务 添加推出中的计划 end-->
		UNION ALL
		SELECT
		hhp.plan_name AS project_name,
		<!--hbtc.borrow_nid AS projectNid,-->
		<!--mod by nxl 智投服务:修改计划显示计划编号->计划名称-->
		hhp.plan_name AS projectNid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hhp.expect_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(hcr.recover_time, '%Y-%m-%d' ) AS recover_time,
		hcr.recover_time,
		3 type,
		hcc.coupon_type coupon_type,
		0 as exit_flg,<!-- add by nxl 智投服务,添加退出中标识-->
		1 as hjh_flg,<!-- add by nxl 智投服务,添加计划标识-->
		IFNULL(hcr.recover_account,0) total_wait
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hcr.recover_status=0
		) t
		ORDER BY t.orderby_invest_date,t.type
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>


	<!-- 资金管理用户当前持有债权列表 -->
	<resultMap id="currentHoldObligatoryRightMap" type="com.hyjf.am.trade.dao.model.customize.CurrentHoldObligatoryRightListCustomize">
		<result column="project_name" property="projectName" />
		<result column="borrow_nid" property="borrowNid" />
		<result column="borrow_period" property="borrowPeriod" />
		<result column="borrow_style" property="borrowStyle" />
		<result column="borrow_class" property="borrowClass" />
		<result column="project_type" property="projectType" />
		<result column="borrow_apr" property="borrowApr" />
		<result column="ten_user_id" property="tenUserId" />
		<result column="nid" property="nid" />
		<result column="addtime" property="addtime" />
		<result column="invest_date" property="investDate" />
		<result column="capital" property="capital" />
		<result column="type" property="type" />
		<result column="DATA" property="data" />
		<result column="coupon_type" property="couponType" />
		<result column="total_wait" property="totalWait" />
		<result column="credit_nid" property="creditNid" />
		<result column="credit_tender_nid" property="creditTenderNid" />

		<result column="creditUserId" property="creditUserId" />
		<!-- 产品加息收益率 -->
		<result column="borrow_extra_yield" property="borrowExtraYield" jdbcType="VARCHAR" />
	</resultMap>

	<select id="selectCurrentHoldObligatoryRightList" resultMap="currentHoldObligatoryRightMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		1 AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrowInfo.project_name, borrowInfo.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		ten.user_id AS ten_user_id,
		ten.nid nid,
		DATE_FORMAT( ten.create_time, '%Y-%m-%d' ) AS addtime,
		ten.create_time as orderby_addtime,
		IFNULL(FROM_UNIXTIME( IF(borrow.repay_last_time='',NULL,borrow.repay_last_time), '%Y-%m-%d' ),'--') AS invest_date,
		borrow.repay_last_time as orderby_invest_date,
		(ten.account-(
		SELECT IFNULL(SUM(ct.assign_capital),0)
		FROM ht_credit_tender ct
		WHERE ct.user_id = #{userId} AND rec.nid = ct.credit_tender_nid)) AS capital,
		CASE
		WHEN hbc.credit_capital_assigned IS NOT NULL THEN 1
		ELSE 0 END type,
		CASE
		WHEN  cast(borrow.`status` AS CHAR)=8 THEN '逾期中'
		WHEN cast(borrow.`status` AS CHAR)<![CDATA[<>]]>4 THEN '出借中'
		ELSE
		CASE
		WHEN cast(hbc.credit_status AS CHAR)=0 THEN '转让中'
		WHEN cast(hbc.credit_status AS CHAR)=1 THEN '部分债转'
		ELSE '现金出借' END
		END AS DATA,
		0 coupon_type,
		IF(borrow.repay_last_time='','--',
		IFNULL(rec.recover_capital_wait,ten.account)+
		IFNULL( rec.recover_interest_wait, 0 )-
		(SELECT IFNULL(SUM(ct.assign_interest - ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE ct.user_id = #{userId} AND rec.nid = ct.credit_tender_nid
		)-
		(SELECT IFNULL(SUM(ct.assign_capital - ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE ct.user_id = #{userId} AND rec.nid = ct.credit_tender_nid
		)- (
		SELECT
		IFNULL(SUM(rp.charge_interest) ,0)
		FROM
		ht_credit_repay rp
		WHERE
		rp.user_id = #{userId} AND
		rec.nid = rp.credit_tender_nid
		and rp.status = 1
		)
		) total_wait,
		'' credit_nid,
		'' credit_tender_nid,
		case when borrowInfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',borrowInfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover rec
		ON ten.nid = rec.nid
		AND rec.recover_capital <![CDATA[>]]> rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = borrow.borrow_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN (SELECT hbcc.tender_nid,
		SUM(hbcc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbcc.credit_status) credit_status FROM ht_borrow_credit hbcc
		WHERE hbcc.credit_user_id = #{userId}
		GROUP BY hbcc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		(
		borrow.`status` = 2
		OR borrow.`status` = 3
		OR borrow.`status` = 4
		<!-- 增加逾期中状态值 add by hesy 2019-04-03-->
		OR borrow.`status` = 8
		)
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL

		UNION ALL

		SELECT
		ten.credit_user_id AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrowInfo.project_name, borrowInfo.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		ten.user_id AS ten_user_id,
		ten.assign_nid nid,
		DATE_FORMAT( ten.create_time, '%Y-%m-%d' ) AS addtime,
		ten.create_time as orderby_addtime,
		IFNULL(FROM_UNIXTIME(IF(borrow.repay_last_time='',NULL,borrow.repay_last_time),'%Y-%m-%d'),'--') AS invest_date,
		borrow.repay_last_time,
		ten.assign_capital AS capital,
		2 AS type,
		'承接债转' DATA,
		0 coupon_type,
		(ten.assign_capital+ten.assign_interest
		-(
		SELECT
		IFNULL(sum(hdcrp.assign_interest) , 0)
		FROM
		ht_credit_repay hdcrp
		WHERE
		hdcrp.user_id =#{userId} AND
		hdcrp.assign_nid = ten.assign_nid
		AND hdcrp.`status` = 1
		)
		) total_wait,
		ten.credit_nid credit_nid,
		ten.credit_tender_nid credit_tender_nid,
		case when borrowInfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',borrowInfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = borrow.borrow_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		WHERE ten.user_id= #{userId}
		AND (borrow.`status` = 4
		<!-- 增加逾期中状态值 add by hesy 2019-04-03-->
		OR borrow.`status` = 8)
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL


		UNION ALL
		SELECT

		1 AS creditUserId,

		hb.borrow_nid,
		IFNULL(borrowInfo.project_name, borrowInfo.`name`) AS project_name,
		CASE
		WHEN hb.borrow_style = 'endday' THEN
		CONCAT(hb.borrow_period, '天')
		ELSE
		CONCAT(
		hb.borrow_period,
		'个月'
		)
		END borrow_period,
		hb.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		hb.project_type project_type,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hb.borrow_apr, '%')
		END
		borrow_apr,
		hbtc.user_id AS ten_user_id,
		hbtc.nid nid,
		DATE_FORMAT( hbtc.create_time, '%Y-%m-%d' ) AS addtime,
		hbtc.create_time as orderby_addtime,
		IFNULL(FROM_UNIXTIME( IF(MAX(hcr.recover_time)='',NULL,MAX(hcr.recover_time)), '%Y-%m-%d' ),'--') AS recover_time,
		MAX(hcr.recover_time),
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS capital,
		3 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元体验金')
		WHEN 2 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'%加息券')
		WHEN 3 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type,
		IFNULL(SUM(hcr.recover_account)-SUM(hcr.recover_account_yes),0) total_wait,
		'' credit_nid,
		'' credit_tender_nid,
		case when borrowInfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',borrowInfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hb.project_type
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=0
		AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0

		UNION ALL

		SELECT

		1 AS creditUserId,

		borrow.borrow_nid,
		IFNULL(borrowInfo.project_name, borrowInfo.`name`) AS project_name,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrow.project_type project_type,
		CONCAT(hiii.borrow_extra_yield, '%') borrow_apr,
		hiii.user_id AS ten_user_id,
		hiii.order_id nid,
		DATE_FORMAT( hiii.create_time, '%Y-%m-%d' ) AS addtime,
		hiii.create_time,
		IFNULL(FROM_UNIXTIME( IF(borrow.repay_last_time='',NULL,borrow.repay_last_time), '%Y-%m-%d' ),'--') AS invest_date,
		borrow.repay_last_time,
		hiii.account AS capital,
		4 AS type,
		CONCAT('加息',FORMAT(hiii.borrow_extra_yield, 2),'%')  AS DATA,
		0 coupon_type,
		IF(borrow.`status` = 4 OR borrow.`status` = 5,hiii.repay_interest_wait,'--') AS total_wait,
		'' credit_nid,
		'' credit_tender_nid,
		case when borrowInfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',borrowInfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN ht_borrow_info borrowInfo ON borrowInfo.borrow_nid = borrow.borrow_nid
		INNER JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE
		(
		borrow.`status` = 2
		OR borrow.`status` = 3
		OR borrow.`status` = 4
		<!-- 增加逾期中状态值 add by hesy 2019-04-03-->
		OR borrow.`status` = 8
		OR(
		borrow.`status` = 5
		AND hiil.repay_status = 0
		)
		)
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL

		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
			ORDER BY t.orderby_addtime desc,t.type,t.capital
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.capital desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.capital asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_addtime desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_addtime asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_invest_date desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_invest_date asc
			</if>
		</if>
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>


	<select id="selectCurrentHoldObligatoryRightListTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT
			ten.nid nid
			FROM
				ht_borrow_tender ten
            LEFT JOIN ht_borrow_recover rec
                ON ten.nid = rec.nid  AND rec.recover_capital <![CDATA[>]]> rec.credit_amount AND rec.recover_account_wait> 0
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
			INNER JOIN ht_borrow_info hbi ON borrow.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			LEFT JOIN (SELECT hbc.tender_nid,
							SUM(hbc.credit_capital_assigned) credit_capital_assigned,
							MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
						GROUP BY hbc.tender_nid
					) hbc ON ten.nid=hbc.tender_nid
			WHERE
				(
					borrow.`status` = 2
					OR borrow.`status` = 3
					OR borrow.`status` = 4
					OR borrow.`status` = 8
				)
			AND ten.user_id= #{userId}
			AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
				ten.assign_nid nid
			FROM
				ht_credit_tender ten
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
			INNER JOIN ht_borrow_info hbi ON borrow.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			WHERE ten.user_id= #{userId}
			AND (borrow.`status` = 4 OR borrow.`status` = 8)
			AND ten.assign_interest>0
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
			hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
			INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
			INNER JOIN ht_borrow_info hbi ON hb.borrow_nid = hbi.borrow_nid
			LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
			INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
			INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
			INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			WHERE hbtc.user_id= #{userId}
			AND hb.plan_nid IS NULL
            GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=0
               AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0
			UNION ALL
			SELECT
			hiii.order_id nid
			FROM
				ht_increase_interest_invest hiii
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
			INNER JOIN ht_borrow_info hbi ON borrow.borrow_nid = hbi.borrow_nid
			INNER JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id=hiii.order_id
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hbi.project_type
			LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
			WHERE
				(
					borrow.`status` = 2
					OR borrow.`status` = 3
					OR borrow.`status` = 4
					OR borrow.`status` = 8
				)
			AND hiii.user_id=#{userId}
			AND borrow.plan_nid IS NULL
		) t
	</select>

	<select id="selectRepaymentListTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT
				hbr.nid nid
			FROM
				ht_borrow_recover hbr
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hbr.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
			LEFT JOIN (SELECT hbc.tender_nid,
								MIN(hbc.credit_capital_assigned) credit_capital_assigned,
								MIN(hbc.credit_capital) credit_capital,
								MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
						GROUP BY hbc.tender_nid ) hbc ON hbr.nid = hbc.tender_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND hbr.recover_status = 1
			AND IFNULL(hbc.credit_capital,hbt.account) > IFNULL(hbc.credit_capital_assigned,0)
			AND hbr.user_id= #{userId}
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT

				hct.assign_nid nid
			FROM
				ht_credit_tender hct
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hct.bid_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_tender hbt ON hct.credit_tender_nid=hbt.nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND hct.assign_interest<![CDATA[>]]>0
			AND hct.user_id= #{userId}
			AND borrow.plan_nid IS NULL
			UNION ALL
			SELECT
				hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
			INNER JOIN ht_borrow borrow ON hbtc.borrow_nid = borrow.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
			INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
			INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
			INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE hbtc.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=1
			UNION ALL
			SELECT
				hiil.invest_order_id nid
			FROM
				ht_increase_interest_loan hiil
			INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiil.borrow_nid
			INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
			INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
			WHERE borrow.`status` = 5
			AND hiil.user_id= #{userId}
			AND borrow.plan_nid IS NULL
			GROUP BY hiil.invest_order_id
		) t
	</select>


	<!--web 端,已回款总数 -->
	<select id="selectRepaymentListTotalWeb" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT count(1) FROM (
            SELECT
              hbr.nid nid
            FROM
              ht_borrow_recover hbr
            INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hbr.borrow_nid
            INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
            LEFT JOIN (
                SELECT
                hbc.tender_nid,
                MIN(hbc.credit_capital_assigned) credit_capital_assigned,
                MIN(hbc.credit_capital) credit_capital,
                MIN(hbc.credit_status) credit_status
                FROM ht_borrow_credit hbc
                GROUP BY hbc.tender_nid
            ) hbc ON hbr.nid = hbc.tender_nid
            INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
            WHERE borrow.`status` = 5
            AND hbr.recover_status = 1
            AND IFNULL(hbc.credit_capital,hbt.account) > IFNULL(hbc.credit_capital_assigned,0)
            AND hbr.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            UNION ALL
            SELECT
              hct.assign_nid nid
            FROM
              ht_credit_tender hct
            INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hct.bid_nid
            INNER JOIN ht_borrow_tender hbt ON hct.credit_tender_nid=hbt.nid
            INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
            WHERE borrow.`status` = 5
            AND hct.assign_interest<![CDATA[>]]>0
            AND hct.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            UNION ALL
            SELECT
              hbtc.nid nid
            FROM
              ht_borrow_tender_cpn hbtc
            INNER JOIN ht_borrow borrow ON hbtc.borrow_nid = borrow.borrow_nid
            LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
            INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
            INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
            INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
            INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
            WHERE hbtc.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=1
            UNION ALL
            SELECT
              hiil.invest_order_id nid
            FROM
              ht_increase_interest_loan hiil
            INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiil.borrow_nid
            INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
            INNER JOIN (
                SELECT
                *
                FROM
                ht_increase_interest_loan_detail
                WHERE
                user_id = #{userId}
            ) hiild ON hiild.invest_order_id = hiil.invest_order_id
            WHERE borrow.`status` = 5
            AND hiil.user_id= #{userId}
            AND borrow.plan_nid IS NULL
            AND CASE
                WHEN borrow.borrow_style = 'end'
                OR borrow.borrow_style = 'endday' THEN
                hiil.repay_status = 1
                ELSE
                hiild.repay_status = 1
            END
            GROUP BY hiil.invest_order_id
		) t
	</select>

	<!-- 获取转让记录列表资源总数 -->
	<select id="countCreditRecordTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT
		COUNT(credit_nid) AS total
		FROM
		ht_borrow_credit
		<where>
			<if test="userId != null and userId != '' and userId != 0">
				AND credit_user_id = #{userId}
			</if>
		</where>
	</select>

	<!-- 资金管理用户已回款债权列表 -->
	<resultMap id="repaymentMap" type="com.hyjf.am.trade.dao.model.customize.RepayMentListCustomize">
		<result column="borrow_nid" property="borrowNid" />
		<result column="borrow_period" property="borrowPeriod" />
		<result column="borrow_style" property="borrowStyle" />
		<result column="borrow_class" property="borrowClass" />
		<result column="project_type" property="projectType" />
		<result column="borrow_apr" property="borrowApr" />
		<result column="ten_user_id" property="tenUserId" />
		<result column="nid" property="nid" />
		<result column="account" property="account" />
		<result column="recover_account_all" property="recoverAccountAll" />
		<result column="recover_account_interest" property="recoverAccountInterest" />
		<result column="repay_orddate" property="repayOrddate" />
		<result column="type" property="type" />
		<result column="DATA" property="data" />
		<result column="coupon_type" property="couponType" />
	</resultMap>

	<select id="selectRepaymentList" resultMap="repaymentMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		hbr.user_id AS ten_user_id,
		hbr.nid nid,
		hbr.recover_capital_yes-(
		SELECT IFNULL(SUM(ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid) account,
		hbr.recover_account_yes-
		(SELECT IFNULL(SUM(ct.assign_repay_account),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid
		) recover_account_all,
		hbr.recover_interest_yes -
		(SELECT IFNULL(SUM(ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE hbr.nid = ct.credit_tender_nid
		) recover_account_interest,
		FROM_UNIXTIME( hbr.recover_yestime, '%Y-%m-%d' ) repay_orddate,
		hbr.recover_yestime orderby_repay_orddate,
		CASE
		WHEN hbr.credit_amount > 0 THEN 1
		ELSE 0
		END type,
		CASE
		WHEN hbr.credit_amount > 0 THEN
		'部分债转'
		ELSE
		'现金出借'
		END AS DATA,
		0 coupon_type,
		hbt.account groupaccount
		FROM
		ht_borrow_recover hbr
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hbr.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		LEFT JOIN ht_borrow_credit hbc ON hbr.nid = hbc.tender_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE borrow.`status` = 5
		AND hbr.recover_status = 1
		AND hbr.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		GROUP BY hbr.nid
		HAVING IFNULL(MIN(hbc.credit_capital),hbt.account) > IFNULL(MIN(hbc.credit_capital_assigned),0)
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		hct.user_id AS ten_user_id,
		hct.assign_nid nid,
		hct.assign_repay_capital AS capital,
		hct.assign_repay_account AS capital_paid,
		hct.assign_repay_interest AS assign_repay_interest,
		FROM_UNIXTIME( hct.assign_repay_yes_time, '%Y-%m-%d' ),
		hct.assign_repay_yes_time orderby_repay_orddate,
		2 AS type,
		'承接债转' DATA,
		0 coupon_type,
		'' groupaccount
		FROM
		ht_credit_tender hct
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hct.bid_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_tender hbt ON hct.credit_tender_nid=hbt.nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE borrow.`status` = 5
		AND hct.assign_interest<![CDATA[>]]>0
		AND hct.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE CONCAT(borrow.borrow_apr, '%')
		END borrow_apr,
		hbtc.user_id AS ten_user_id,
		hbtc.nid nid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS capital,
		hbtc.recover_account_yes,
		hbtc.recover_account_interest_yes,

		FROM_UNIXTIME( MAX(hcr.recover_yestime), '%Y-%m-%d' ),
		MAX(hcr.recover_yestime) orderby_repay_orddate,
		3 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元体验金')
		WHEN 2 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'%加息券')
		WHEN 3 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type,
		'' groupaccount
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow borrow ON hbtc.borrow_nid = borrow.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		WHERE hbtc.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=1
		UNION ALL
		SELECT
		borrow.borrow_nid,
		CASE
		WHEN borrow.borrow_style = 'endday' THEN
		CONCAT(borrow.borrow_period, '天')
		ELSE
		CONCAT(borrow.borrow_period,'个月')
		END borrow_period,
		borrow.borrow_style borrow_style,
		hydbpt.borrow_class borrow_class,
		borrowinfo.project_type project_type,
		CONCAT(hiil.borrow_extra_yield, '%') borrow_apr,
		hiil.user_id AS ten_user_id,
		hiil.invest_order_id nid,
		hiil.invest_account account,
		hiil.repay_interest_yes recover_account_all,
		CASE
		WHEN borrow.borrow_style = 'end'
		OR borrow.borrow_style = 'endday' THEN
		hiil.repay_interest_yes
		ELSE
		hiild.repay_interest_yes
		END AS recover_account_interest ,
		CASE
		WHEN borrow.borrow_style = 'end'
		OR borrow.borrow_style = 'endday' THEN
		FROM_UNIXTIME(
		hiil.repay_action_time ,
		'%Y-%m-%d'
		)
		ELSE
		FROM_UNIXTIME(
		hiild.repay_action_time ,
		'%Y-%m-%d'
		)
		END AS repay_orddate ,
		CASE
		WHEN borrow.borrow_style = 'end'
		OR borrow.borrow_style = 'endday' THEN
		hiil.repay_action_time
		ELSE
		hiild.repay_action_time
		END AS orderby_repay_orddate ,
		4 type,
		CONCAT('加息',FORMAT(hiil.borrow_extra_yield, 2),'%') AS DATA,
		0 coupon_type,
		'' groupaccount
		FROM
		ht_increase_interest_loan hiil
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiil.borrow_nid
		INNER JOIN ht_borrow_info borrowinfo ON borrow.borrow_nid = borrowinfo.borrow_nid
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrowinfo.project_type
		LEFT JOIN(
		SELECT
		*
		FROM
		ht_increase_interest_loan_detail
		WHERE
		user_id = #{userId}
		) hiild ON hiild.invest_order_id = hiil.invest_order_id
		WHERE borrow.`status` = 5
		AND hiil.user_id= #{userId}
		AND borrow.plan_nid IS NULL
		AND
		CASE
		WHEN borrow.borrow_style = 'end'
		OR borrow.borrow_style = 'endday' THEN
		hiil.repay_status = 1
		ELSE
		hiild.repay_status = 1
		END
		GROUP BY
		hiild.invest_order_id
		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
			ORDER BY t.orderby_repay_orddate desc,t.type,t.account
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.account desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.account asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.recover_account_interest desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.recover_account_interest asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_repay_orddate desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_repay_orddate asc
			</if>
		</if>

		<if test="limitStart >= 0" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>
	<resultMap id="CreditBaseResultMap" type="com.hyjf.am.trade.dao.model.customize.TenderCreditDetailCustomize" >
		<id column="credit_id" property="creditId" />
		<result column="credit_nid" property="creditNid" />
		<result column="credit_user_id" property="creditUserId" />
		<result column="bid_nid" property="bidNid" />
		<result column="bid_apr" property="bidApr" />
		<result column="bid_name" property="bidName" />
		<result column="borrow_style" property="borrowStyle" />
		<result column="borrow_style_name" property="borrowStyleName" />
		<result column="tender_nid" property="tenderNid" />
		<result column="credit_status" property="creditStatus" />
		<result column="credit_order" property="creditOrder" />
		<result column="credit_period" property="creditPeriod" />
		<result column="credit_term" property="creditTerm" />
		<result column="credit_capital" property="creditCapital" />
		<result column="credit_account" property="creditAccount" />
		<result column="credit_interest" property="creditInterest" />
		<result column="credit_interest_advance" property="creditInterestAdvance" />
		<result column="credit_discount" property="creditDiscount" />
		<result column="credit_income" property="creditIncome" />
		<result column="credit_fee" property="creditFee" />
		<result column="credit_price" property="creditPrice" />
		<result column="credit_capital_assigned" property="creditCapitalAssigned" />
		<result column="credit_interest_assigned" property="creditInterestAssigned" />
		<result column="credit_repay_account" property="creditRepayAccount" />
		<result column="credit_repay_capital" property="creditRepayCapital" />
		<result column="credit_repay_interest" property="creditRepayInterest" />
		<result column="credit_repay_end_time" property="creditRepayEndTime" />
		<result column="credit_repay_last_time" property="creditRepayLastTime" />
		<result column="credit_repay_next_time" property="creditRepayNextTime" />
		<result column="credit_repay_yes_time" property="creditRepayYesTime" />
		<result column="create_date" property="createDate" />
		<result column="add_time" property="addTime" />
		<result column="add_time_int" property="addTimeInt" />
		<result column="end_time" property="endTime" />
		<result column="assign_time" property="assignTime" />
		<result column="assign_num" property="assignNum" />
		<result column="recover_period" property="recoverPeriod" />
		<result column="credit_inProgress" property="creditInProgress" />
		<result column="tenderTime" property="tenderTime" />
		<result column="tender_period" property="tenderPeriod" />
		<result column="last_days" property="lastDays" />
		<result column="receivedAccount" property="receivedAccount" />
		<result column="project_name" property="projectName" />
	</resultMap>
	<!-- 获取转让记录列表资源 -->
	<select id="selectCreditRecordList" resultMap="CreditBaseResultMap" parameterType="java.util.Map">
		SELECT
		<!--项目编号  -->
		hb.borrow_nid AS bid_nid,
		<!-- 原始转让本金 -->
		hbc.credit_capital,
		<!-- 折让比例 -->
		hbc.credit_discount,
		<!-- 债转时间 -->
		DATE_FORMAT(hbc.create_time,'%Y-%m-%d %H:%i') AS add_time,
		<!-- 债转时间 -->
		hbc.create_time AS add_time_int,
		<!-- 已转让金额 -->
		hbc.credit_capital_assigned,
		<!-- 累计收到金额 -->
		(
		SELECT
		IFNULL(SUM(hct.assign_pay - hct.credit_fee),0)
		FROM
		ht_credit_tender hct
		WHERE
		hct.credit_tender_nid = hbc.tender_nid
		AND hbc.credit_nid = hct.credit_nid
		) AS receivedAccount,
		DATE_FORMAT(hbt.create_time, '%Y-%m-%d %H:%i:%s') AS tenderTime,
		(DATEDIFF(
		FROM_UNIXTIME(
		unix_timestamp(now()),
		'%Y-%m-%d 00:00:00'
		),
		FROM_UNIXTIME(hb.recover_last_time, '%Y-%m-%d 00:00:00')
		)) AS tender_period,
		(DATEDIFF(
		FROM_UNIXTIME(
		CAST(hb.repay_last_time AS SIGNED),
		'%Y-%m-%d 00:00:00'
		),
		FROM_UNIXTIME(unix_timestamp(now()), '%Y-%m-%d 00:00:00')
		)) AS last_days,
		CASE WHEN credit_capital>credit_capital_assigned AND TRUNCATE(credit_capital_assigned/credit_capital*100,2) = 100.00
		THEN 99 ELSE TRUNCATE(credit_capital_assigned/credit_capital*100,2) END AS credit_inProgress,
		hbc.credit_nid,
		hbc.credit_status,
		hbc.credit_term
		FROM ht_borrow_credit hbc
		INNER JOIN ht_borrow hb ON hbc.bid_nid = hb.borrow_nid
		INNER JOIN ht_borrow_style hbs ON hb.borrow_style = hbs.nid
		LEFT JOIN ht_borrow_tender hbt ON hbc.bid_nid = hbt.borrow_nid AND hbc.tender_nid = hbt.nid

		<where>
			<if test="userId != null and userId != '' and userId != 0">
				AND hbc.credit_user_id = #{userId}
			</if>
		</where>
		order by hbc.credit_status, hbc.create_time desc
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>

	<!-- 资金管理用户当前持有计划列表 -->
	<resultMap id="currentHoldPlanMap" type="com.hyjf.am.trade.dao.model.customize.CurrentHoldPlanListCustomize">
		<result column="debt_plan_nid" property="debtPlanNid" />
		<result column="accede_order_id" property="accedeOrderId" />
		<result column="expect_apr" property="expectApr" />
		<result column="debt_lock_period" property="debtLockPeriod" />
		<result column="user_id" property="userId" />
		<result column="accede_account" property="accedeAccount" />
		<result column="repay_account_wait" property="repayAccountWait" />
		<result column="create_time" property="createTime" />
		<result column="liquidate_should_time" property="liquidateShouldTime" />
		<result column="type" property="type" />
		<result column="DATA" property="data" />
		<result column="coupon_type" property="couponType" />
		<!-- add by nxl 智投服务 加入参考回报-->
		<result column="reference_return" property="referenceReturn" />
	</resultMap>
	<select id="selectCurrentHoldPlanList" resultMap="currentHoldPlanMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		hdp.debt_plan_nid  debt_plan_nid,
		hdpa.accede_order_id accede_order_id,
		CONCAT(hdp.expect_apr, '%') expect_apr,
		CONCAT(hdp.debt_lock_period,'个月') debt_lock_period,
		hdpa.user_id user_id,
		hdpa.accede_account accede_account,
		<!-- add by nxl 智投服务 加入参考回报 -->
		CASE hdpa.repay_interest_wait
		WHEN 0.00 THEN '--'
		ELSE hdpa.repay_interest_wait end AS reference_return,
		hdpa.repay_interest_wait repay_account_wait,
		IFNULL(DATE_FORMAT( hdpa.create_time, '%Y-%m-%d' ),'--') AS create_time,
		hdpa.create_time orderby_create_time,
		IFNULL(FROM_UNIXTIME( hdp.liquidate_should_time, '%Y-%m-%d' ),'--') AS liquidate_should_time,
		hdp.liquidate_should_time orderby_liquidate_should_time,
		0 type,
		CASE
		WHEN hdp.debt_plan_status = 4
		<!-- mod by nxl 智投服务修改 出借中->智能投标中-->
		<!--THEN '出借中'-->
		THEN '智能投标中'
		ELSE '现金出借'
		END AS DATA,
		0 coupon_type
		FROM ht_debt_plan_accede hdpa
		INNER JOIN ht_debt_plan hdp ON hdpa.plan_nid=hdp.debt_plan_nid
		WHERE
		hdp.debt_plan_status <![CDATA[<>]]>11
		AND hdp.debt_plan_status <![CDATA[<>]]>12
		AND hdpa.user_id=#{userId}

		UNION ALL
		SELECT
		hhp.plan_name plan_name,
		hha.accede_order_id accede_order_id,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS debt_lock_period,
		hha.user_id user_id,
		hha.accede_account accede_account,
		<!-- add by nxl 智投服务 加入参考回报 -->
		CASE hha.wait_interest
		WHEN 0.00 THEN '--'
		ELSE hha.wait_interest end AS reference_return,
		IF(hha.wait_interest=0,'--',hha.wait_interest) wait_interest,
		IFNULL(DATE_FORMAT( hha.create_time, '%Y-%m-%d' ),'--') AS add_time,
		hha.create_time orderby_add_time,
		IFNULL(FROM_UNIXTIME( IF(hha.quit_time=0,NULL,hha.quit_time), '%Y-%m-%d' ),'--') AS quit_time,
		hha.quit_time orderby_last_payment_time,
		1 type,
		CASE
		WHEN (hha.order_status =0 or hha.order_status =2 or hha.order_status =99 )
		<!-- mod by nxl 智投服务修改 出借中->智能投标中-->
		<!--THEN '出借中'-->
		THEN '智能投标中'
		ELSE '现金出借'
		END AS DATA,
		0 coupon_type
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
		WHERE
		hha.order_status <![CDATA[<>]]>7
		AND hha.user_id=#{userId}
		UNION ALL
		SELECT
		hhp.plan_name plan_name,
		hbtc.nid nid,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS debt_lock_period,
		hbtc.user_id user_id,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS accede_account,
		<!-- add by nxl 智投服务 加入参考回报  -->
		case IFNULL(SUM(hcr.recover_account)-SUM(hcr.recover_account_yes),0)  WHEN 0.00 THEN '--'
		ELSE IFNULL(SUM(hcr.recover_account)-SUM(hcr.recover_account_yes),0) END AS reference_return,
		IFNULL(SUM(hcr.recover_account)-SUM(hcr.recover_account_yes),0) AS wait_total,
		DATE_FORMAT( hbtc.create_time, '%Y-%m-%d' ) AS addtime,
		hbtc.create_time orderby_add_time,
		IFNULL(FROM_UNIXTIME( IF(MAX(hcr.recover_time)='',NULL,MAX(hcr.recover_time)), '%Y-%m-%d' ),'--') AS recover_time,
		hcr.recover_time orderby_quit_time,
		2 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元体验金')
		WHEN 2 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'%加息券')
		WHEN 3 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=0
		AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0
		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
			ORDER BY t.orderby_create_time desc,t.type,t.accede_account
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.accede_account desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.accede_account asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_create_time desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_create_time asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_liquidate_should_time desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_liquidate_should_time asc
			</if>
		</if>

		<if test="limitStart >= 0" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>


	<select id="countCurrentHoldPlanTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT

				hdpa.accede_order_id accede_order_id
			FROM ht_debt_plan_accede hdpa
			INNER JOIN ht_debt_plan hdp ON hdpa.plan_nid=hdp.debt_plan_nid
			WHERE
			hdp.debt_plan_status <![CDATA[<>]]>11
			AND hdp.debt_plan_status <![CDATA[<>]]>12
			AND hdpa.user_id=#{userId}
			UNION ALL
			SELECT
				hha.accede_order_id accede_order_id
			FROM ht_hjh_accede hha
			LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
			WHERE
			hha.order_status <![CDATA[<>]]>7
			AND hha.user_id=#{userId}
			UNION ALL
			SELECT
				hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
				INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
				LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
				INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
				INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
				INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			WHERE hbtc.user_id= #{userId}
			GROUP BY hbtc.nid
			HAVING MIN(hcr.recover_status)=0
               AND IFNULL((SUM(hcr.recover_account)-SUM(hcr.recover_account_yes)),0)<![CDATA[>]]>0
		) t
	</select>


	<!-- 资金管理用户已回款计划列表 -->
	<resultMap id="repayMentPlanMap" type="com.hyjf.am.trade.dao.model.customize.RepayMentPlanListCustomize">
		<result column="debt_plan_nid" property="debtPlanNid" />
		<result column="accede_order_id" property="accedeOrderId" />
		<result column="expect_apr" property="expectApr" />
		<result column="debt_lock_period" property="debtLockPeriod" />
		<result column="user_id" property="userId" />
		<result column="accede_account" property="accedeAccount" />
		<result column="repay_account_yes" property="repayAccountYes" />
		<result column="repay_interest_yes" property="repayInterestYes" />
		<result column="liquidate_fact_time" property="liquidateFactTime" />
		<result column="type" property="type" />
		<result column="DATA" property="data" />
		<result column="coupon_type" property="couponType" />
	</resultMap>
	<select id="selectRepayMentPlanList" resultMap="repayMentPlanMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		hdp.debt_plan_nid  debt_plan_nid,
		hdpa.accede_order_id accede_order_id,
		CONCAT(hdp.expect_apr, '%') expect_apr,
		CONCAT(hdp.debt_lock_period,'个月') debt_lock_period,
		hdpa.user_id user_id,
		hdpa.accede_account accede_account,
		hdpa.repay_account_yes repay_account_yes,
		hdpa.repay_interest_yes repay_interest_yes,
		FROM_UNIXTIME(hdp.liquidate_fact_time, '%Y-%m-%d' ) liquidate_fact_time,
		hdp.liquidate_fact_time orderby_liquidate_fact_time,
		0 type,
		'现金出借' DATA,
		0 coupon_type
		FROM ht_debt_plan_accede hdpa
		INNER JOIN ht_debt_plan hdp ON hdpa.plan_nid=hdp.debt_plan_nid
		WHERE
		hdp.debt_plan_status =11
		AND hdpa.user_id=#{userId}
		UNION ALL
		SELECT
		hhp.plan_name plan_name,
		hha.accede_order_id accede_order_id,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS debt_lock_period,
		hha.user_id user_id,
		hha.accede_account accede_account,
		hha.received_total received_total,
		hha.received_interest received_interest,
		IF(hha.acctual_payment_time=NULL OR hha.acctual_payment_time=0 OR hha.acctual_payment_time='',
		'--',FROM_UNIXTIME( hha.acctual_payment_time, '%Y-%m-%d' )) AS quit_time,
		hha.acctual_payment_time orderby_quit_time,
		1 type,
		'现金出借' AS DATA,
		0 coupon_type
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
		WHERE
		hha.order_status = 7
		AND hha.user_id=#{userId}
		UNION ALL
		SELECT
		hhp.plan_name plan_name,
		hbtc.nid nid,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS debt_lock_period,
		hbtc.user_id user_id,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS accede_account,
		hbtc.recover_account_yes,
		hbtc.recover_account_interest_yes AS repay_interest_yes,
		FROM_UNIXTIME(MAX(hcr.recover_yestime), '%Y-%m-%d' ),
		MAX(hcr.recover_yestime) orderby_repay_orddate,
		2 type,
		CASE hcc.coupon_type
		WHEN 1 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元体验金')
		WHEN 2 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'%加息券')
		WHEN 3 THEN CONCAT(IF(Left(RIGHT(hcc.coupon_quota,3),1)='.' AND RIGHT(RIGHT(hcc.coupon_quota,3),1)!='0',FORMAT(hcc.coupon_quota, 2),FORMAT(hcc.coupon_quota, 1)),'元代金券')
		END AS DATA,
		hcc.coupon_type coupon_type
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE  hbtc.user_id=#{userId}
		GROUP BY hbtc.nid
		HAVING MIN(hcr.recover_status)=1
		) t
		<if test="orderByFlag ==null||orderByFlag==''" >
            ORDER BY t.liquidate_fact_time desc,t.accede_order_id asc
		</if>
		<if test="orderByFlag == 1" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.accede_account desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.accede_account asc
			</if>
		</if>
		<if test="orderByFlag == 2" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.repay_interest_yes desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.repay_interest_yes asc
			</if>
		</if>
		<if test="orderByFlag == 3" >
			<if test="sortBy == 'DESC'" >
				ORDER BY t.orderby_liquidate_fact_time desc
			</if>
			<if test="sortBy == 'ASC'" >
				ORDER BY t.orderby_liquidate_fact_time asc
			</if>
		</if>

		<if test="limitStart >= 0" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>

	<select id="countRepayMentPlanTotal" resultType="java.lang.Integer" parameterType="java.util.Map">
	    SELECT count(1) FROM (
			SELECT
				hdpa.accede_order_id accede_order_id
			FROM ht_debt_plan_accede hdpa
			INNER JOIN ht_debt_plan hdp ON hdpa.plan_nid=hdp.debt_plan_nid
			WHERE
			hdp.debt_plan_status =11
			AND hdpa.user_id=#{userId}
			UNION ALL
			SELECT
				hha.accede_order_id accede_order_id
			FROM ht_hjh_accede hha
			LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
			WHERE
			hha.order_status = 7
			AND hha.user_id=#{userId}
			UNION ALL
			SELECT
				hbtc.nid nid
			FROM
				ht_borrow_tender_cpn hbtc
				INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
				LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
				INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
				INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
				INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
			WHERE  hbtc.user_id=#{userId}
			GROUP BY hbtc.nid
            HAVING MIN(hcr.recover_status)=1
		) t
	</select>


	<resultMap id="AlreadyRepayListMap" type="com.hyjf.am.trade.dao.model.customize.WechatRepayMentListCustomize">
		<id column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
		<result column="borrow_name" property="borrowName" jdbcType="VARCHAR" />
		<result column="interest" property="interest" jdbcType="VARCHAR" />
		<result column="account" property="account" jdbcType="VARCHAR" />
		<result column="borrow_apr" property="borrowApr" jdbcType="VARCHAR" />
		<result column="borrow_schedule" property="borrowSchedule" jdbcType="VARCHAR" />
		<result column="borrow_url" property="borrowUrl" jdbcType="VARCHAR" />
		<result column="label" property="label" jdbcType="VARCHAR" />
		<result column="invest_type" property="investType" jdbcType="VARCHAR" />
		<result column="project_type" property="projectType" jdbcType="VARCHAR" />
		<result column="recover_time_sort" property="recoverTime" jdbcType="VARCHAR" />
		<result column="order_id" property="orderId" jdbcType="VARCHAR" />
		<result column="period" property="period" jdbcType="VARCHAR" />
		<result column="coupon_type" property="couponType" jdbcType="VARCHAR" />
		<!-- 产品加息收益率 -->
		<result column="borrow_extra_yield" property="borrowExtraYield" jdbcType="VARCHAR" />
	</resultMap>



	<select id="selectWechatRepaymentList" resultMap="AlreadyRepayListMap" parameterType="Map">
		SELECT
		hydb.borrow_nid,
		case when hydb.project_type=13 then
		hydb.borrow_nid
		else
		hydb.borrow_nid
		end AS borrow_name,
		hydb.borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hydbr.recover_capital, 4),
		1,
		LENGTH(
		FORMAT(hydbr.recover_capital, 4)
		) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		hydbr.recover_interest_yes,
		4
		),
		1,
		LENGTH(
		FORMAT(
		hydbr.recover_interest_yes,
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		CONCAT(#{host},'?borrowNid=',hydb.borrow_nid,'&amp;tenderNid=',hydbr.nid) AS borrow_url,
		'' label,
		'' as coupon_type,
		hydbr.recover_yestime AS recover_time_sort,
		'1' AS invest_type,
		hydbpt.borrow_class project_type,
		hydbr.nid as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_borrow_recover hydbr
		INNER JOIN ht_borrow hydb ON hydbr.borrow_nid = hydb.borrow_nid
		INNER JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		WHERE
		(hydbpt.borrow_project_type ='HZT' OR hydbpt.borrow_project_type ='HXF')
		AND hydbr.user_id = #{userId,jdbcType=INTEGER}
		AND hydbr.recover_status = 1
		AND hydb.plan_nid IS NULL

		UNION ALL
		SELECT
		DISTINCT
		hct.bid_nid AS borrow_nid,
		hct.bid_nid AS borrow_name,
		hydb.borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		FORMAT(hct.assign_capital,2) AS account,
		'' AS interest,
		'' AS borrow_schedule,
		'' AS borrow_url,
		'' AS label,
		'' as coupon_type,
		hct.assign_repay_yes_time AS recover_time_sort,
		'' AS invest_type,
		'HZR' AS project_type,
		hct.assign_nid AS order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_credit_tender hct
		INNER JOIN ht_borrow hydb ON hydb.borrow_nid = hct.bid_nid
		INNER JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		WHERE hct.user_id = #{userId}
		AND hct.status = 1

		UNION ALL
		SELECT
		hydb.borrow_nid,
		hydb.borrow_nid AS borrow_name,
		CASE
		WHEN hcc.coupon_type IS NOT NULL
		AND hcc.coupon_type = 2 THEN
		hcc.coupon_quota
		ELSE
		hydb.borrow_apr
		END borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hbt.account, 4),
		1,
		LENGTH(FORMAT(hbt.account, 4)) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		SUM(hcr.recover_account_yes),
		4
		),
		1,
		LENGTH(
		FORMAT(
		SUM(hcr.recover_account_yes),
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		<!-- 优惠券详情URL -->
		CONCAT(#{host},'?couponCode=',hcu.coupon_user_code) AS borrow_url,
		CASE
		WHEN hcc.coupon_type = 1 THEN
		'体验金'
		WHEN hcc.coupon_type = 2 THEN
		'加息券'
		WHEN hcc.coupon_type = 3 THEN
		'代金券'
		ELSE
		''
		END label,
		hcc.coupon_type	as coupon_type,
		MAX(hcr.recover_yestime) AS recover_time_sort,
		'2' AS invest_type,
		hydbpt.borrow_class project_type,
		hcr.tender_id as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_coupon_recover hcr
		INNER JOIN ht_borrow_tender_cpn hbt ON hcr.tender_id = hbt.nid
		INNER JOIN ht_borrow hydb ON hbt.borrow_nid = hydb.borrow_nid
		INNER JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_coupon_tender hct ON hct.order_id = hbt.nid
		LEFT JOIN ht_coupon_user hcu ON hcu.id = hct.coupon_grant_id
		LEFT JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE
		(
		hydbpt.borrow_project_type = 'HZT'
		OR hydbpt.borrow_project_type = 'HXF'
		)
		AND hbt.user_id = #{userId,jdbcType=INTEGER}
		AND hcr.recover_status = 1
		AND hcr.received_flg = 5
		AND NOT EXISTS (
		SELECT
		hcr2.id
		FROM
		ht_coupon_recover hcr2
		INNER JOIN ht_borrow_tender_cpn hbt2 ON hcr2.tender_id = hbt2.nid
		WHERE
		hbt2.borrow_nid = hydb.borrow_nid
		AND hcr2.tender_id = hcr.tender_id
		AND hcr2.received_flg <![CDATA[<>]]> 5
		)
		GROUP BY
		hcr.tender_id

		UNION ALL
		SELECT
		hydb.borrow_nid,
		case when hydb.project_type=13 then
		hydb.borrow_nid
		else
		hydb.borrow_nid
		end AS borrow_name,
		hydbinfo.borrow_extra_yield AS borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hiil.invest_account, 4),
		1,
		LENGTH(FORMAT(hiil.invest_account, 4)) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		hiil.loan_interest,
		4
		),
		1,
		LENGTH(
		FORMAT(
		hiil.loan_interest,
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		CONCAT(#{host},'?borrowNid=',hydb.borrow_nid,'&amp;tenderNid=',hiii.tender_nid,'&amp;investType=3') AS borrow_url,
		CONCAT('加息',FORMAT(hiii.borrow_extra_yield, 2),'%') label,
		'4' as coupon_type,
		hiil.repay_action_time AS recover_time_sort,
		'3' AS invest_type,
		hydbpt.borrow_class project_type,
		hiii.tender_nid as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
		borrow_extra_yield
		FROM
		ht_borrow hydb
		INNER JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_increase_interest_invest hiii ON hiii.borrow_nid = hydb.borrow_nid
		LEFT JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id = hiii.order_id
		WHERE
		hiil.user_id = #{userId,jdbcType=INTEGER}
		AND hiil.repay_status = 1
		GROUP BY
		hiil.invest_order_id
		ORDER BY
		recover_time_sort DESC
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>
	<sql id="Where_Clause_Already_Repay_List">
		<where>
			(hydbpt.borrow_project_type ='HZT' OR hydbpt.borrow_project_type ='HXF')
			AND hydbr.user_id = #{userId,jdbcType=INTEGER}
			AND hydbr.recover_status = 1
			AND hydb.plan_nid IS NULL
		</where>
	</sql>


	<resultMap id="WechatTenderCreditListMap" type="com.hyjf.am.trade.dao.model.customize.WechatTenderCreditListCustomize">
		<id column="creditNid" property="creditNid" jdbcType="VARCHAR" />
		<result column="creditTime" property="creditTime" jdbcType="VARCHAR" />
		<result column="creditCapital" property="creditCapital" jdbcType="VARCHAR" />
		<result column="creditCapitalAssigned" property="creditCapitalAssigned" jdbcType="VARCHAR" />
		<result column="realCreditNid" property="realCreditNid" jdbcType="VARCHAR" />
		<result column="creditStatusDesc" property="creditStatusDesc" jdbcType="VARCHAR" />
		<result column="creditRecordInfoUrl" property="creditRecordInfoUrl" jdbcType="VARCHAR" />

	</resultMap>

	<select id="selectWechatCreditRecordList" resultMap="WechatTenderCreditListMap" parameterType="Map">
		SELECT
		<!-- 债转编号 -->
		hbc.bid_nid AS creditNid,
		<!-- 债转时间 -->
		DATE_FORMAT( hbc.create_time, '%Y-%m-%d %H:%i' ) AS creditTime,
		<!-- 债权本金 -->
		FORMAT(hbc.credit_capital,2) AS creditCapital,
		<!-- 已认购金额 -->
		FORMAT(hbc.credit_capital_assigned,2) AS creditCapitalAssigned,

		<!-- 债转状态 -->
		CASE WHEN hbc.credit_status = 0 THEN '转让中'
		WHEN hbc.credit_status = 1 THEN CONCAT(TRUNCATE(hbc.credit_capital_assigned/hbc.credit_capital,2)*100,'%')
		WHEN hbc.credit_status = 2 THEN '已还款'
		END
		AS creditStatus,

		hbc.credit_nid AS realCreditNid,

		<!-- 债转状态2 -->
		CASE WHEN hbc.credit_status = 0 THEN '转让中'
		WHEN hbc.credit_capital_assigned = hbc.credit_capital THEN '已完成'
		else '已结束'
		END
		AS creditStatusDesc,
		CASE WHEN hbc.credit_status = 0 THEN 0
		ELSE 1
		END
		AS orderByCreditStatus,
		<!-- 债转详情URL -->
		CONCAT(#{host},'?creditNid=',hbc.credit_nid,'&amp;sign=',#{sign}) AS creditRecordInfoUrl
		FROM
		ht_borrow_credit hbc
		<where>
			<if test="userId != null and userId != ''">
				AND hbc.credit_user_id = #{userId}
			</if>
			<!-- 转让中列表 -->
			<if test="status != null and status !=''">
				<!-- 转让中 -->
				AND hbc.credit_status = #{status}
			</if>
			<if test="successStatus != null and successStatus !=''">
				<!-- 转让成功-->
				AND hbc.credit_status != #{successStatus}
			</if>
			<if test="creditCapitalAssigned != null and creditCapitalAssigned != '' ">
				<!-- 并且认购金额>0 -->
				AND hbc.credit_capital_assigned <![CDATA[>]]> #{creditCapitalAssigned}
			</if>
		</where>
		ORDER BY orderByCreditStatus ASC , creditTime DESC
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>

	<resultMap id="AppAlreadyRepayListMap" type="com.hyjf.am.trade.dao.model.customize.AppAlreadyRepayListCustomize">
		<id column="borrow_nid" property="borrowNid" jdbcType="VARCHAR" />
		<result column="borrow_name" property="borrowName" jdbcType="VARCHAR" />
		<result column="interest" property="interest" jdbcType="VARCHAR" />
		<result column="account" property="account" jdbcType="VARCHAR" />
		<result column="borrow_apr" property="borrowApr" jdbcType="VARCHAR" />
		<result column="borrow_schedule" property="borrowSchedule" jdbcType="VARCHAR" />
		<result column="borrow_url" property="borrowUrl" jdbcType="VARCHAR" />
		<result column="label" property="label" jdbcType="VARCHAR" />
		<result column="invest_type" property="investType" jdbcType="VARCHAR" />
		<result column="project_type" property="projectType" jdbcType="VARCHAR" />
		<result column="recover_time_sort" property="recoverTime" jdbcType="VARCHAR" />
		<result column="order_id" property="orderId" jdbcType="VARCHAR" />
		<result column="period" property="period" jdbcType="VARCHAR" />
		<result column="coupon_type" property="couponType" jdbcType="VARCHAR" />
		<result column="borrow_extra_yield" property="borrowExtraYield" jdbcType="VARCHAR" />
	</resultMap>
	<select id="selectAppAlreadyRepayList" resultMap="AppAlreadyRepayListMap" parameterType="Map">
		SELECT
		hydb.borrow_nid,
		case when hydb.project_type=13 then
		hydb.borrow_nid
		else
		hydb.borrow_nid
		end AS borrow_name,
		hydb.borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hydbr.recover_capital, 4),
		1,
		LENGTH(
		FORMAT(hydbr.recover_capital, 4)
		) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		hydbr.recover_interest_yes,
		4
		),
		1,
		LENGTH(
		FORMAT(
		hydbr.recover_interest_yes,
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		CONCAT(#{host},'?borrowNid=',hydb.borrow_nid,'&amp;tenderNid=',hydbr.nid) AS borrow_url,
		'' label,
		'' as coupon_type,
		hydbr.recover_yestime AS recover_time_sort,
		'1' AS invest_type,
		hydbpt.borrow_class project_type,
		hydbr.nid as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
        borrow_extra_yield
		FROM
		ht_borrow_recover hydbr
		INNER JOIN ht_borrow hydb ON hydbr.borrow_nid = hydb.borrow_nid
        LEFT JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		WHERE
		(hydbpt.borrow_project_type ='HZT' OR hydbpt.borrow_project_type ='HXF')
		AND hydbr.user_id = #{userId,jdbcType=INTEGER}
		AND hydbr.recover_status = 1
		AND hydb.plan_nid IS NULL

		UNION ALL
		SELECT
		DISTINCT
		hct.bid_nid AS borrow_nid,
		hct.bid_nid AS borrow_name,
		hydb.borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		FORMAT(hct.assign_capital,2) AS account,
		'' AS interest,
		'' AS borrow_schedule,
		'' AS borrow_url,
		'' AS label,
		'' as coupon_type,
		hct.assign_repay_yes_time AS recover_time_sort,
		'' AS invest_type,
		'HZR' AS project_type,
		hct.assign_nid AS order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
        borrow_extra_yield
		FROM
		ht_credit_tender hct
		INNER JOIN ht_borrow hydb ON hydb.borrow_nid = hct.bid_nid
        LEFT JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		WHERE hct.user_id = #{userId}
		AND hct.status = 1

		UNION ALL
		SELECT
		hydb.borrow_nid,
		hydb.borrow_nid AS borrow_name,
		CASE
		WHEN hcc.coupon_type IS NOT NULL
		AND hcc.coupon_type = 2 THEN
		hcc.coupon_quota
		ELSE
		hydb.borrow_apr
		END borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hbt.account, 4),
		1,
		LENGTH(FORMAT(hbt.account, 4)) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		SUM(hcr.recover_account_yes),
		4
		),
		1,
		LENGTH(
		FORMAT(
		SUM(hcr.recover_account_yes),
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		<!-- 优惠券详情URL -->
		CONCAT(#{host},'?couponCode=',hcu.coupon_user_code) AS borrow_url,
		CASE
		WHEN hcc.coupon_type = 1 THEN
		'体验金'
		WHEN hcc.coupon_type = 2 THEN
		'加息券'
		WHEN hcc.coupon_type = 3 THEN
		'代金券'
		ELSE
		''
		END label,
		hcc.coupon_type	as coupon_type,
		MAX(hcr.recover_yestime) AS recover_time_sort,
		'2' AS invest_type,
		hydbpt.borrow_class project_type,
		hcr.tender_id as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
        borrow_extra_yield
		FROM
		ht_coupon_recover hcr
		INNER JOIN ht_borrow_tender_cpn hbt ON hcr.tender_id = hbt.nid
		INNER JOIN ht_borrow hydb ON hbt.borrow_nid = hydb.borrow_nid
        LEFT JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_coupon_tender hct ON hct.order_id = hbt.nid
		LEFT JOIN ht_coupon_user hcu ON hcu.id = hct.coupon_grant_id
		LEFT JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE
		(
		hydbpt.borrow_project_type = 'HZT'
		OR hydbpt.borrow_project_type = 'HXF'
		)
		AND hbt.user_id = #{userId,jdbcType=INTEGER}
		AND hcr.recover_status = 1
		AND hcr.received_flg = 5
		AND NOT EXISTS (
		SELECT
		hcr2.id
		FROM
		ht_coupon_recover hcr2
		INNER JOIN ht_borrow_tender_cpn hbt2 ON hcr2.tender_id = hbt2.nid
		WHERE
		hbt2.borrow_nid = hydb.borrow_nid
		AND hcr2.tender_id = hcr.tender_id
		AND hcr2.received_flg <![CDATA[<>]]> 5
		)
		GROUP BY
		hcr.tender_id

		UNION ALL
		SELECT
		hydb.borrow_nid,
		case when hydb.project_type=13 then
		hydb.borrow_nid
		else
		hydb.borrow_nid
		end AS borrow_name,
		hydbinfo.borrow_extra_yield AS borrow_apr,
		CASE
		WHEN hydb.borrow_style = 'endday'
		THEN CONCAT(hydb.borrow_period, '天')
		ELSE
		CONCAT(hydb.borrow_period,'个月')
		END AS period,
		SUBSTRING(
		FORMAT(hiil.invest_account, 4),
		1,
		LENGTH(FORMAT(hiil.invest_account, 4)) - 2
		) AS account,
		SUBSTRING(
		FORMAT(
		hiil.loan_interest,
		4
		),
		1,
		LENGTH(
		FORMAT(
		hiil.loan_interest,
		4
		)
		) - 2
		) AS interest,
		hydb.borrow_account_scale AS borrow_schedule,
		CONCAT(#{host},'?borrowNid=',hydb.borrow_nid,'&amp;tenderNid=',hiii.tender_nid,'&amp;investType=3') AS borrow_url,
		CONCAT('加息',FORMAT(hiii.borrow_extra_yield, 2),'%') label,
		'4' as coupon_type,
		hiil.repay_action_time AS recover_time_sort,
		'3' AS invest_type,
		hydbpt.borrow_class project_type,
		hiii.tender_nid as order_id,
		case when hydbinfo.borrow_extra_yield=0 then
		''
		else
		CONCAT('加息',hydbinfo.borrow_extra_yield, '%')
		end
        borrow_extra_yield
		FROM
		ht_borrow hydb
		INNER JOIN ht_borrow_info hydbinfo ON hydb.borrow_nid = hydbinfo.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_increase_interest_invest hiii ON hiii.borrow_nid = hydb.borrow_nid
		LEFT JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id = hiii.order_id
		WHERE
		hiil.user_id = #{userId,jdbcType=INTEGER}
		AND hiil.repay_status = 1
		GROUP BY
		hiil.invest_order_id
		ORDER BY
		recover_time_sort DESC
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>

	<select id="countAlreadyRepayListRecordTotal" resultType="java.lang.Integer" parameterType="Map">
		SELECT
		count(id) AS total
		FROM
		(
		SELECT
		hydbr.id
		FROM
		ht_borrow_recover hydbr
		INNER JOIN ht_borrow hydb ON hydbr.borrow_nid = hydb.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		WHERE
		(
		hydbpt.borrow_project_type = 'HZT'
		OR hydbpt.borrow_project_type = 'HXF'
		)
		AND hydbr.user_id = #{userId}
		AND hydbr.recover_status = 1
		AND hydb.plan_nid IS NULL
		UNION ALL
		SELECT
		hct.assign_id
		FROM
		ht_credit_tender hct
		INNER JOIN ht_borrow hydb ON hydb.borrow_nid = hct.bid_nid
		WHERE
		hct.user_id = #{userId}
		AND hct. STATUS = 1
		UNION ALL
		SELECT
		hcr.id
		FROM
		ht_coupon_recover hcr
		INNER JOIN ht_borrow_tender_cpn hbt ON hcr.tender_id = hbt.nid
		INNER JOIN ht_borrow hydb ON hbt.borrow_nid = hydb.borrow_nid
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_coupon_tender hct ON hct.order_id = hbt.nid
		LEFT JOIN ht_coupon_user hcu ON hcu.id = hct.coupon_grant_id
		LEFT JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE
		(
		hydbpt.borrow_project_type = 'HZT'
		OR hydbpt.borrow_project_type = 'HXF'
		)
		AND hbt.user_id = #{userId}
		AND hcr.recover_status = 1
		AND hcr.received_flg = 5
		AND NOT EXISTS (
		SELECT
		hcr2.id
		FROM
		ht_coupon_recover hcr2
		INNER JOIN ht_borrow_tender_cpn hbt2 ON hcr2.tender_id = hbt2.nid
		WHERE
		hbt2.borrow_nid = hydb.borrow_nid
		AND hcr2.tender_id = hcr.tender_id
		AND hcr2.received_flg <![CDATA[<>]]> 5
		)
		GROUP BY
		hcr.tender_id
		UNION ALL
		SELECT
		hiil.id
		FROM
		ht_borrow hydb
		LEFT JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = hydb.project_type
		LEFT JOIN ht_increase_interest_invest hiii ON hiii.borrow_nid = hydb.borrow_nid
		LEFT JOIN ht_increase_interest_loan hiil ON hiil.invest_order_id = hiii.order_id
		WHERE
		hiil.user_id = #{userId}
		AND hiil.repay_status = 1
		GROUP BY
		hiil.invest_order_id
		) AS tabeltemp
	</select>

	<!-- 获取用户转让记录列表 -->
	<select id="searchAppCreditRecordList" resultType="com.hyjf.am.trade.dao.model.customize.AppTenderCreditRecordListCustomize" parameterType="com.hyjf.am.resquest.trade.AssetManageBeanRequest">
		SELECT
		<!-- 债转编号 -->
		hbc.bid_nid AS creditNid,
		<!-- 债转时间 -->
		DATE_FORMAT( hbc.create_time, '%Y-%m-%d %H:%i' ) AS creditTime,
		<!-- 债权本金 -->
		FORMAT(hbc.credit_capital,2) AS creditCapital,
		<!-- 已认购金额 -->
		FORMAT(hbc.credit_capital_assigned,2) AS creditCapitalAssigned,

		<!-- 债转状态 -->
		CASE WHEN hbc.credit_status = 0 THEN '转让中'
		WHEN hbc.credit_status = 1 THEN CONCAT(TRUNCATE(hbc.credit_capital_assigned/hbc.credit_capital,2)*100,'%')
		WHEN hbc.credit_status = 2 THEN '已还款'
		END
		AS creditStatus,

		hbc.credit_nid AS realCreditNid,

		<!-- 债转状态2 -->
		CASE WHEN hbc.credit_status = 0 THEN '转让中'
		WHEN hbc.credit_capital_assigned = hbc.credit_capital THEN '已完成'
		else '已结束'
		END
		AS creditStatusDesc,
		hbc.credit_status  orderByCreditStatus,
		<!-- 债转详情URL -->
		CONCAT(#{host},'?creditNid=',hbc.credit_nid,'&amp;sign=',#{sign}) AS creditRecordInfoUrl
		FROM
		ht_borrow_credit hbc
		<where>
			<if test="userId != null and userId != ''">
				AND hbc.credit_user_id = #{userId}
			</if>
			<!-- 转让中列表 -->
			<if test="status != null and status !=''">
				<!-- 转让中 -->
				AND hbc.credit_status = #{status}
			</if>
			<if test="successStatus != null and successStatus !=''">
				<!-- 转让成功-->
				AND hbc.credit_status != #{successStatus}
			</if>
			<if test="creditCapitalAssigned != null and creditCapitalAssigned != '' ">
				<!-- 并且认购金额>0 -->
				AND hbc.credit_capital_assigned <![CDATA[>]]> #{creditCapitalAssigned}
			</if>
		</where>
		ORDER BY hbc.credit_status ASC , hbc.create_time DESC
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>


	<!-- 获取可转让的出借列表 -->
	<select id="selectTenderToCreditListCount" resultType="java.lang.Integer" parameterType="com.hyjf.am.resquest.trade.AssetManageBeanRequest">
		SELECT
		count(*)
		FROM
		ht_borrow_recover hbr
		LEFT JOIN ht_borrow_tender ht ON ht.borrow_nid = hbr.borrow_nid AND ht.nid = hbr.nid
		LEFT JOIN ht_borrow hb ON hbr.borrow_nid = hb.borrow_nid
		INNER JOIN ht_borrow_info hbinfo ON hbinfo.borrow_nid = hb.borrow_nid
		<include refid="TenderToCredit_Where_Clause" />
	</select>
	<!-- 获取可转让的出借查询条件 -->
	<sql id="TenderToCredit_Where_Clause">
		<where>
			<if test="borrowNid != null and borrowNid != ''">
				AND hbr.borrow_nid = #{borrowNid}
			</if>
			<if test="tenderNid != null and tenderNid != ''">
				AND hbr.nid = #{tenderNid}
			</if>
			AND	hbr.recover_status = 0
			AND hb.project_type != 8
			AND hb.project_type != 13
			AND hb.repay_last_time <![CDATA[>=]]> (#{nowTime} + 24 * 3600 * 30)
			AND hb.borrow_style != 'month'
			AND hb.borrow_style != 'principal'
			AND hb.plan_nid IS NULL
			AND hbinfo.inst_code = 10000000
			AND hbr.advance_status != 3
			AND hbr.delay_days = 0
			AND hbr.credit_time <![CDATA[<=]]> (#{nowTime} - 3600 * 24 * 3)
			AND hbr.recover_capital <![CDATA[>=]]> 1000
			AND (hbr.recover_capital-credit_amount) <![CDATA[>=]]> 1000
			AND hbr.create_time <![CDATA[<=]]> date_sub(#{nowDate}, INTERVAL 30 DAY)
			AND hbr.recover_time <![CDATA[>=]]> (#{nowTime} + 24 * 3600 * 3)
			AND CAST(IFNULL(hbr.repay_orddate,0) AS SIGNED)  <![CDATA[<]]> FROM_UNIXTIME((#{nowTime} - 24 * 3600 * 3),'%Y%m%d')
			AND hbr.user_id = #{userId}
			<!-- 分期标提前还款该月不允许债转 -->
			AND (
			CASE
			WHEN hb.borrow_style = 'endmonth' THEN
			(
			SELECT
			hbrp.recover_status AS recoverPlanStatus
			FROM
			ht_borrow_recover_plan hbrp
			WHERE
			hbrp.borrow_nid = hbr.borrow_nid
			AND hbrp.tender_id = hbr.tender_id
			AND hbrp.recover_period = (
			hb.borrow_period - hbr.recover_period + 1
			)
			)
			ELSE
			(hbr.recover_status)
			END
			)<![CDATA[<>]]>1
		</where>
	</sql>


	<select id="countAppMyPlan" resultType="java.lang.Integer" parameterType="com.hyjf.am.resquest.trade.AssetManageBeanRequest">
		SELECT count(1) FROM (
		SELECT
		hha.id
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
		WHERE hha.user_id=#{userId}

		<choose>
			<when test="type == 1">
				AND hha.order_status <![CDATA[<>]]>7
			</when>
			<when test="type == 2">
				AND hha.order_status = 7
			</when>
		</choose>



		UNION ALL
		SELECT
		hbtc.id
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		<choose>
			<when test="type == 1">
				AND hcr.recover_status=0
			</when>
			<when test="type == 2">
				AND hcr.recover_status=1
			</when>
		</choose>
		) t

	</select>



	<!-- app 我的计划列表 -->
	<resultMap id="appMyPlanMap" type="com.hyjf.am.trade.dao.model.customize.AppMyPlanCustomize">
		<result column="plan_nid" property="borrowNid" />
		<result column="plan_name" property="borrowName" />
		<result column="order_id" property="orderId" />
		<result column="expect_apr" property="expectApr" />
		<result column="lock_period" property="lockPeriod" />
		<result column="user_id" property="userId" />
		<result column="account" property="account" />
		<result column="accede_account" property="accedeAmount" />
		<result column="repay_account_wait" property="interest" />
		<result column="received_interest" property="receivedInterest" />
		<result column="last_payment_time" property="recoverTime" />
		<result column="statusName" property="statusName" />
		<result column="coupon_type" property="label" />
		<result column="coupon_code" property="couponCode" />
		<result column="coupon_amount" property="couponAmount" />
		<result column="coupon_profit_time" property="couponProfitTime" />
		<result column="borrow_url" property="borrowUrl" />
		<result column="type" property="type" />
		<result column="label" property="label" />
		<result column="create_time" property="createTime" />
		<result column="repay_time" property="repayTime" />
	</resultMap>
	<select id="selectAppMyPlanList" resultMap="appMyPlanMap" parameterType="java.util.Map">
		SELECT t.* FROM (
		SELECT
		hhp.plan_name plan_name,
		hha.plan_nid plan_nid,
		hha.accede_order_id order_id,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS lock_period,
		hha.user_id user_id,
		hha.accede_account account,
		hha.accede_account accede_account,

		<choose>
			<when test="type == 1">
				IF(hha.wait_total=0,'--',hha.wait_total) repay_account_wait,
				IF(hha.wait_total=0,'--',hha.wait_total) received_interest,
				IFNULL(FROM_UNIXTIME( IF(hha.last_payment_time=0,NULL,hha.last_payment_time), '%Y-%m-%d' ),'--') AS last_payment_time,

			</when>
			<when test="type == 2">
				hha.received_total repay_account_wait,
				hha.received_interest received_interest,
				IF(hha.acctual_payment_time=NULL OR hha.acctual_payment_time=0 OR hha.acctual_payment_time='',
				'--',FROM_UNIXTIME( hha.acctual_payment_time, '%Y-%m-%d' )) AS last_payment_time,
			</when>
		</choose>

		DATE_FORMAT(hha.create_time,'%Y-%m-%d') as create_time,
		hha.create_time as order_by_addtime,

		CASE
		WHEN (hha.order_status =0 or hha.order_status =2 or hha.order_status =99 ) THEN '出借中'
		ELSE ''
		END AS statusName,
		0 coupon_type,
		hha.acctual_payment_time orderby_quit_time,
		'' coupon_code,
		'' coupon_amount,
		'' coupon_profit_time,
		'' AS borrow_url,
		#{type} as type,
		'0' as label
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
		WHERE hha.user_id=#{userId}

		<choose>
			<when test="type == 1">
				AND hha.order_status <![CDATA[<>]]>7
			</when>
			<when test="type == 2">
				AND hha.order_status = 7
			</when>
		</choose>



		UNION ALL
		SELECT
		hhp.plan_name plan_name,
		hbtc.borrow_nid plan_nid,
		hbtc.nid order_id,
		CONCAT(hhp.expect_apr, '%') expect_apr,
		CASE
		WHEN hhp.borrow_style ='endday' THEN CONCAT(hhp.lock_period,'天')
		ELSE CONCAT(hhp.lock_period,'个月')
		END AS lock_period,
		hbtc.user_id user_id,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS account,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		hbtc.account
		ELSE
		hcc.coupon_quota
		END AS accede_account,

		hcr.recover_account repay_account_wait,
		hcr.recover_account received_interest,

		IFNULL(FROM_UNIXTIME( IF(hcr.recover_yestime='',NULL,hcr.recover_yestime), '%Y-%m-%d' ),'--') AS last_payment_time,

		DATE_FORMAT(hbtc.create_time,'%Y-%m-%d') as create_time,
		hbtc.create_time as order_by_addtime,
		'' AS statusName,
		hcc.coupon_type coupon_type,
		hcr.recover_time orderby_quit_time ,
		hcc.coupon_code coupon_code,
		hcc.coupon_quota coupon_amount,
		hcc.coupon_profit_time coupon_profit_time,
		'' AS borrow_url,
		#{type} as type ,
		hcc.coupon_type label
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		<choose>
			<when test="type == 1">
				AND hcr.recover_status=0
			</when>
			<when test="type == 2">
				AND hcr.recover_status=1
			</when>
		</choose>
		) t
		<choose>
			<when test="type == 1">
				ORDER BY t.order_by_addtime desc, t.order_id asc
			</when>
			<when test="type == 2">
				ORDER BY t.last_payment_time desc, t.order_id asc
			</when>
		</choose>
		LIMIT #{limitStart} , #{limitEnd}

	</select>

	<select id="countRepaymentCalendar" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT count(1) FROM (

		SELECT
		ten.nid
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover_plan rec
		ON ten.nid = rec.nid
		AND rec.recover_account > rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow_recover re ON ten.nid = re.nid
		AND re.recover_account > re.credit_amount
		AND re.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		LEFT JOIN (SELECT hbc.tender_nid,
		MIN(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		(borrow.`status` = 4 OR borrow.`status` = 8)
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(IFNULL(rec.recover_time,re.recover_time),'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(IFNULL(rec.recover_time,re.recover_time),'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		ten.credit_tender_nid AS nid
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		WHERE ten.user_id= #{userId}
		AND (borrow.`status` = 4 OR borrow.`status` = 8)
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hbtc.nid
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		AND hcr.recover_status =0
		AND hcr.recover_account >0
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hiii.tender_nid AS nid
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN (select * from ht_increase_interest_loan where user_id=#{userId}
		) hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE (borrow.`status` = 4 OR borrow.`status` = 8)
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hha.accede_order_id AS nid
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status in (3,5)
		AND hha.user_id=#{userId}
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hha.last_payment_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hha.last_payment_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hbtc.nid
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hcr.recover_status=0
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		) t

	</select>

	<!-- app回款日历列表 -->
	<resultMap id="repayCalendarMap" type="com.hyjf.am.trade.dao.model.customize.AppRepayCalendarCustomize">
		<result column="borrow_nid" property="borrowNid" />
		<result column="coupon_name" property="couponName" />
		<result column="total_wait" property="account" />
		<result column="borrow_period" property="period" />
		<result column="invest_date" property="repayTime" />
		<result column="project_name" property="borrowName" />
		<result column="type" property="type" />
		<result column="order_id" property="orderId" />
		<result column="coupon_type" property="couponType" />
		<result column="assign_nid" property="assignNid" />
		<result column="order_status" property="orderStatus"/>
		<result column="borrowStatus" property="borrowStatus"/>
	</resultMap>

	<select id="selectRepaymentCalendar" resultMap="repayCalendarMap" parameterType="java.util.Map">
		SELECT t.* FROM (

		SELECT
		borrow.borrow_nid AS project_name,
		borrow.borrow_nid AS borrow_nid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(IFNULL(rec.recover_time,re.recover_time), '%Y-%m-%d' ) AS invest_date,
		IFNULL(rec.recover_time,re.recover_time) as orderby_invest_date,
		CASE
		WHEN hbc.credit_capital_assigned IS NOT NULL THEN 1
		ELSE 0 END type,
		0 coupon_type,
		IFNULL(rec.recover_capital_wait,ten.account)+
		IFNULL( rec.recover_interest_wait, ten.recover_account_interest )-
		(SELECT IFNULL(SUM(ct.assign_interest - ct.assign_repay_interest),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		)-
		(SELECT IFNULL(SUM(ct.assign_capital - ct.assign_repay_capital),0)
		FROM ht_credit_tender ct
		WHERE rec.nid = ct.credit_tender_nid
		) total_wait,
		'' AS coupon_name,
		CASE WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period, '个月') END borrow_period,
		ten.nid as order_id,
		'' as assign_nid,
		'' as order_status,
		borrow.`status` AS borrowStatus
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover_plan rec
		ON ten.nid = rec.nid
		AND rec.recover_account > rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow_recover re ON ten.nid = re.nid
		AND re.recover_account > re.credit_amount
		AND re.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		LEFT JOIN (SELECT hbc.tender_nid,
		MIN(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		(borrow.`status` = 4 OR borrow.`status` = 8)
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(IFNULL(rec.recover_time,re.recover_time),'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(IFNULL(rec.recover_time,re.recover_time),'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		borrow.borrow_nid AS project_name,
		borrow.borrow_nid AS borrow_nid,
		CONCAT(borrow.borrow_apr, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		2 AS type,
		0 coupon_type,
		(ten.assign_capital+ten.assign_interest) total_wait,
		'承接债转' AS coupon_name,
		CASE WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period, '个月') END borrow_period,
		ten.credit_tender_nid as order_id,
		ten.assign_nid,
		'' as order_status,
		borrow.`status` AS borrowStatus
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		WHERE ten.user_id= #{userId}
		AND (borrow.`status` = 4 OR borrow.`status` = 8)
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hb.borrow_nid AS project_name,
		hb.borrow_nid AS borrow_nid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hb.borrow_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(hcr.recover_time, '%Y-%m-%d' ) AS recover_time,
		hcr.recover_time,
		3 TYPE,
		hcc.coupon_type coupon_type,
		IFNULL(hcr.recover_account,0) total_wait,
		CASE
		WHEN hcc.coupon_type = '1' THEN
		'体验金'
		WHEN hcc.coupon_type = '2' THEN
		'加息券'
		WHEN hcc.coupon_type = '3' THEN
		'代金券'
		END AS coupon_name,
		CASE WHEN hb.borrow_style = 'endday' THEN CONCAT(hb.borrow_period, '天')
		ELSE CONCAT(hb.borrow_period, '个月') END borrow_period,
		hbtc.nid AS order_id,
		'' AS assign_nid,
		'' as order_status,
		hb.`status` AS borrowStatus
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		AND hcr.recover_status =0
		AND hcr.recover_account >0
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>


		UNION ALL
		SELECT
		borrow.borrow_nid AS project_name,
		borrow.borrow_nid AS borrow_nid,
		CONCAT(hiii.borrow_extra_yield, '%') borrow_apr,
		FROM_UNIXTIME(borrow.repay_last_time, '%Y-%m-%d' ) AS invest_date,
		borrow.repay_last_time,
		4 AS type,
		0 coupon_type,
		hiii.repay_interest_wait AS total_wait,
		'项目加息' AS coupon_name,
		CASE WHEN borrow.borrow_style = 'endday' THEN CONCAT(borrow.borrow_period, '天')
		ELSE CONCAT(borrow.borrow_period, '个月') END borrow_period,
		hiii.tender_nid as order_id,
		'' as assign_nid,
		'' as order_status,
		borrow.`status` AS borrowStatus
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN (select * from ht_increase_interest_loan where user_id=#{userId}
		) hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE (borrow.`status` = 4 OR borrow.`status` = 8)
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(borrow.repay_last_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hhp.plan_name,
		<!-- hhp.plan_nid AS borrow_nid, -->
		hhp.plan_name AS borrow_nid,
		CONCAT(hha.expect_apr, '%') borrow_apr,
		IF(IFNULL(hha.quit_time,0)=0,'--',FROM_UNIXTIME(hha.quit_time, '%Y-%m-%d' )) AS quit_time,
		hha.last_payment_time,
		5 AS type,
		0 coupon_type,
		hha.wait_total wait_total,
		'' AS coupon_name,
		CASE WHEN hhp.borrow_style = 'endday' THEN CONCAT(hhp.lock_period, '天')
		ELSE CONCAT(hhp.lock_period, '个月') END borrow_period,
		hha.accede_order_id as order_id,
		'' as assign_nid,
		hha.order_status order_status,
		'' AS borrowStatus
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp
		ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status in (3,5)
		AND hha.user_id=#{userId}
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hha.last_payment_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hha.last_payment_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		UNION ALL
		SELECT
		hhp.plan_name AS project_name,
		hbtc.borrow_nid AS borrow_nid,
		CASE
		WHEN hcc.coupon_type = 2 THEN
		CONCAT(hcc.coupon_quota, '%')
		ELSE
		CONCAT(hhp.expect_apr, '%')
		END
		borrow_apr,
		FROM_UNIXTIME(hcr.recover_time, '%Y-%m-%d' ) AS recover_time,
		hcr.recover_time,
		6 type,
		hcc.coupon_type coupon_type,
		IFNULL(hcr.recover_account,0) total_wait,
		CASE
		WHEN hcc.coupon_type = '1' THEN
		'体验金'
		WHEN hcc.coupon_type = '2' THEN
		'加息券'
		WHEN hcc.coupon_type = '3' THEN
		'代金券'
		END AS coupon_name,
		CASE WHEN hhp.borrow_style = 'endday' THEN CONCAT(hhp.lock_period, '天')
		ELSE CONCAT(hhp.lock_period, '个月') END borrow_period,
		hbtc.nid as order_id,
		'' as assign_nid,
		hha.order_status order_status,
		'' AS borrowStatus
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		left join ht_coupon_real_tender hcrt on hbtc.nid = hcrt.coupon_tender_id
		left join ht_hjh_accede hha ON hcrt.real_tender_id = hha.accede_order_id
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hcr.recover_status=0
		<if test="tradeYear != null and tradeYear != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%Y')  = #{tradeYear,jdbcType=INTEGER}
		</if>
		<if test="tradeMonth != null and tradeMonth != '' ">
			AND FROM_UNIXTIME(hcr.recover_time,'%m')  = #{tradeMonth,jdbcType=INTEGER}
		</if>

		) t
		ORDER BY t.invest_date ASC,t.order_id ASC
		<if test="limitStart != null and limitEnd !=null" >
			LIMIT #{limitStart} , #{limitEnd}
		</if>
	</select>

	<select id="selectNearlyRepaymentTime" resultType="java.lang.Integer" parameterType="java.util.Map">
		SELECT min(t.nearly_date) FROM (

		SELECT
		IFNULL(rec.recover_time,re.recover_time) as nearly_date
		FROM
		ht_borrow_tender ten
		LEFT JOIN ht_borrow_recover_plan rec
		ON ten.nid = rec.nid
		AND rec.recover_account > rec.credit_amount
		AND rec.recover_account_wait> 0
		INNER JOIN ht_borrow_recover re ON ten.nid = re.nid
		AND re.recover_account > re.credit_amount
		AND re.recover_account_wait> 0
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.borrow_nid
		LEFT JOIN (SELECT hbc.tender_nid,
		MIN(hbc.credit_capital_assigned) credit_capital_assigned,
		MIN(hbc.credit_status) credit_status FROM ht_borrow_credit hbc
		GROUP BY hbc.tender_nid
		) hbc ON ten.nid=hbc.tender_nid
		WHERE
		borrow.`status` = 4
		AND ten.user_id= #{userId}
		AND ten.account>IFNULL(hbc.credit_capital_assigned,0)
		AND borrow.plan_nid IS NULL

		UNION ALL
		SELECT
		borrow.repay_last_time as nearly_date
		FROM
		ht_credit_tender ten
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = ten.bid_nid
		WHERE ten.user_id= #{userId}
		AND borrow.`status` = 4
		AND ten.assign_interest>0
		AND borrow.plan_nid IS NULL


		UNION ALL
		SELECT
		MAX(hcr.recover_time)  as nearly_date
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_borrow hb ON hbtc.borrow_nid = hb.borrow_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hb.plan_nid IS NULL
		AND hcr.recover_status =0
		AND hcr.recover_account >0

		UNION ALL
		SELECT
		borrow.repay_last_time as nearly_date
		FROM
		ht_increase_interest_invest hiii
		INNER JOIN ht_borrow borrow ON borrow.borrow_nid = hiii.borrow_nid
		INNER JOIN (select * from ht_increase_interest_loan where user_id=#{userId}
		) hiil ON hiil.invest_order_id=hiii.order_id
		INNER JOIN ht_borrow_project_type hydbpt ON hydbpt.borrow_cd = borrow.project_type
		LEFT JOIN ht_borrow_credit hbc ON hiii.borrow_nid=hbc.tender_nid
		WHERE borrow.`status` = 4
		AND hiii.user_id=#{userId}
		AND borrow.plan_nid IS NULL

		UNION ALL
		SELECT
		hha.last_payment_time
		FROM ht_hjh_accede hha
		LEFT JOIN ht_hjh_plan hhp
		ON hha.plan_nid=hhp.plan_nid
		WHERE hha.order_status=3
		AND hha.user_id=#{userId}

		UNION ALL
		SELECT
		hcr.recover_time as nearly_date
		FROM
		ht_borrow_tender_cpn hbtc
		INNER JOIN ht_hjh_plan hhp ON hbtc.borrow_nid = hhp.plan_nid
		LEFT JOIN ht_coupon_recover hcr ON hbtc.nid=hcr.tender_id
		INNER JOIN ht_coupon_tender hct ON hct.order_id = hbtc.nid
		INNER JOIN ht_coupon_user hcu ON hct.coupon_grant_id = hcu.id
		INNER JOIN ht_coupon_config hcc ON hcu.coupon_code = hcc.coupon_code
		WHERE hbtc.user_id= #{userId}
		AND hcr.recover_status=0
		) t

	</select>

	<!-- 还款计划列表 -->
	<resultMap id="creditorRepayMentPlanMap" type="com.hyjf.am.trade.dao.model.customize.CurrentHoldRepayMentPlanListCustomize">
		<result column="borrow_nid" property="borrowNid" />
		<result column="nid" property="nid" />
		<result column="recover_period" property="recoverPeriod" />
		<result column="recover_account_wait" property="recoverAccountWait" />
		<result column="recover_capital_wait" property="recoverCapitalWait" />
		<result column="recover_interest_wait" property="recoverInterestWait" />
		<result column="recover_account" property="recoverAccount" />
		<result column="recover_time" property="recoverTime" />
		<result column="recover_status" property="recoveStatus" />
	</resultMap>

	<!-- 获取当前持有现金出借不分期还款计划列表 -->
	<select id="realInvestmentRepaymentPlanNoStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hbr.borrow_nid borrow_nid,
			hbr.nid nid,
			hbr.recover_period recover_period,
			hbr.recover_account recover_account_wait,
			hbr.recover_capital recover_capital_wait,
			hbr.recover_interest recover_interest_wait,
			hbr.recover_account_yes recover_account,
			FROM_UNIXTIME(IFNULL(IF((hbr.recover_yestime='' OR hbr.recover_yestime=0),NULL,hbr.recover_yestime),hbr.recover_time), '%Y-%m-%d' ) recover_time,
			<!-- 增加逾期中状态值 modify by hesy 2019-03-26-->
			IF(hbr.recover_status=0,IF(hb.`status`=8,'逾期中','未还款'),'已还款') recover_status
		FROM
			ht_borrow_recover hbr
		INNER JOIN ht_borrow hb ON hb.borrow_nid = hbr.borrow_nid
		WHERE
			hbr.nid=#{nid}
	</select>

	<!-- 还款计划详情 -->
	<resultMap id="creditorRepayMentPlanDetailsMap" type="com.hyjf.am.trade.dao.model.customize.CurrentHoldRepayMentPlanDetailsCustomize">
		<result column="recover_account_wait" property="recoverAccountWait" />
		<result column="recover_capital_wait" property="recoverCapitalWait" />
		<result column="recover_interest_wait" property="recoverInterestWait" />
		<result column="recover_account_yes" property="recoverAccountYes" />
		<result column="createTime" property="createTime" />
		<result column="borrow_nid" property="borrowNid" />
	</resultMap>

	<!-- 获取当前持有现金出借不分期还款计划详情 -->
	<select id="realInvestmentRepaymentPlanNoStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			hbr.recover_account_wait recover_account_wait,
			hbr.recover_capital_wait recover_capital_wait,
			hbr.recover_interest_wait recover_interest_wait,
			hbr.recover_account_yes recover_account_yes,
			DATE_FORMAT( MIN(hbt.create_time), '%Y-%m-%d %H:%i:%s' ) createTime,
			hbr.borrow_nid borrow_nid
		FROM
			ht_borrow_recover hbr
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		WHERE
			hbr.nid = #{nid}
	</select>

	<!-- 获取当前持有现金出借分期还款计划列表 -->
	<select id="realInvestmentRepaymentPlanStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hbr.borrow_nid borrow_nid,
			hbr.nid nid,
			hbr.recover_period recover_period,
			hbr.recover_account recover_account_wait,
			hbr.recover_capital recover_capital_wait,
			hbr.recover_interest recover_interest_wait,
			hbr.recover_account_yes recover_account,
			FROM_UNIXTIME(IFNULL(IF((hbr.recover_yestime='' OR hbr.recover_yestime=0),NULL,hbr.recover_yestime),hbr.recover_time), '%Y-%m-%d' ) recover_time,
			IF(hbr.recover_status=0,IF(hbr.advance_status=3,'逾期中','未还款'),'已还款') recover_status
		FROM
			ht_borrow_recover_plan hbr
		WHERE
			hbr.nid = #{nid}
	</select>

	<!-- 获取当前持有现金出借分期还款计划详情 -->
	<select id="realInvestmentRepaymentPlanStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			hbr.recover_account_wait recover_account_wait,
			hbr.recover_capital_wait recover_capital_wait,
			hbr.recover_interest_wait recover_interest_wait,
			hbr.recover_account_yes recover_account_yes,
			DATE_FORMAT( MIN(hbt.create_time), '%Y-%m-%d %H:%i:%s' ) createTime,
			hbr.borrow_nid borrow_nid
		FROM
			ht_borrow_recover hbr
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		WHERE
			hbr.nid = #{nid}
	</select>

	<!-- 获取当前持有债权转让不分期还款计划列表 -->
	<select id="assignRepaymentPlanNoStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hbrp.borrow_nid borrow_nid,
			hbrp.nid,
			hbrp.recover_account - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_account
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_account_wait,
			hbrp.recover_capital - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_capital
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_capital_wait,
			hbrp.recover_interest - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_interest
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_interest_wait,
			hbrp.recover_account_yes - IFNULL(
				(
					SELECT
						SUM(cr.assign_repay_account)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_account,
			hbrp.recover_period recover_period,
			FROM_UNIXTIME(
				IFNULL(
					IF (
						hbrp.recover_yestime = 0,
						NULL,
						hbrp.recover_yestime
					),
					hbrp.recover_time
				),
				'%Y-%m-%d'
			) recover_time,

			IF (
				hbrp.recover_status = 0,
				IF(hbrp.advance_status=3,'逾期中','未还款'),
				'已还款'
			) recover_status
		FROM
			ht_borrow_recover hbrp
		WHERE
			hbrp.nid=#{nid}
	</select>

	<!-- 获取当前持有债权转让不分期还款计划详情 -->
	<select id="assignRepaymentPlanNoStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			hbr.recover_account_wait - IFNULL((
				SELECT
					SUM(
						ct.assign_account - ct.assign_repay_account
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_account_wait,
			hbr.recover_capital_wait-IFNULL((
				SELECT
					SUM(
						ct.assign_capital - ct.assign_repay_capital
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_capital_wait,
			hbr.recover_interest_wait - IFNULL((
				SELECT
					SUM(
						ct.assign_interest - ct.assign_repay_interest
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_interest_wait,
			hbr.recover_account_yes - IFNULL((
				SELECT
					SUM(
						ct.assign_repay_account
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_account_yes,
			DATE_FORMAT(
				hbt.create_time,
				'%Y-%m-%d %H:%i:%s'
			) createTime,
			hbr.borrow_nid borrow_nid,
		hbr.nid
		FROM
			ht_borrow_recover hbr
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		WHERE
			hbr.nid=#{nid}
	</select>

	<!-- 获取当前持有债权转让分期还款计划列表 -->
	<select id="assignRepaymentPlanStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hbrp.borrow_nid borrow_nid,
			hbrp.nid,
			hbrp.recover_account - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_account
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_account_wait,
			hbrp.recover_capital - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_capital
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_capital_wait,
			hbrp.recover_interest - IFNULL(
				(
					SELECT
						SUM(
							cr.assign_interest
						)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_interest_wait,
			hbrp.recover_account_yes - IFNULL(
				(
					SELECT
						SUM(cr.assign_repay_account)
					FROM
						ht_credit_repay cr
					WHERE
						cr.credit_tender_nid = hbrp.nid
					AND cr.recover_period = hbrp.recover_period
				),
				0
			) recover_account,
			hbrp.recover_period recover_period,
			FROM_UNIXTIME(
				IFNULL(
					IF (
						hbrp.recover_yestime = 0,
						NULL,
						hbrp.recover_yestime
					),
					hbrp.recover_time
				),
				'%Y-%m-%d'
			) recover_time,

		IF (
			hbrp.recover_status = 0,
			IF(hbrp.advance_status=3,'逾期中','未还款'),
			'已还款'
		) recover_status
		FROM
			ht_borrow_recover_plan hbrp
		WHERE
			hbrp.nid=#{nid}
	</select>

	<!-- 获取当前持有债权转让分期还款计划详情 -->
	<select id="assignRepaymentPlanStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			hbr.recover_account_wait - IFNULL((
				SELECT
					SUM(
						ct.assign_account - ct.assign_repay_account
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_account_wait,
			hbr.recover_capital_wait - IFNULL((
				SELECT
					SUM(
						ct.assign_capital - ct.assign_repay_capital
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_capital_wait,
			hbr.recover_interest_wait - IFNULL((
				SELECT
					SUM(
						ct.assign_interest - ct.assign_repay_interest
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_interest_wait,
			hbr.recover_account_yes - IFNULL((
				SELECT
					SUM(
						ct.assign_repay_account
					)
				FROM
					ht_credit_tender ct
				WHERE
					ct.credit_tender_nid = hbr.nid
			),0) recover_account_yes,
			DATE_FORMAT(
				hbt.create_time,
				'%Y-%m-%d %H:%i:%s'
			) createTime,
			hbr.borrow_nid borrow_nid,
		hbr.nid
		FROM
			ht_borrow_recover hbr
		INNER JOIN ht_borrow_tender hbt ON hbr.nid = hbt.nid
		WHERE
			hbr.nid=#{nid}
	</select>

	<!-- 获取当前持有债权转让还款计划列表 -->
	<select id="creditRepaymentPlanList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hcr.credit_nid borrow_nid,
			hcr.assign_nid nid,
			hcr.assign_repay_period recover_period,
			hcr.assign_account recover_account_wait,
			hcr.assign_capital recover_capital_wait,
			hcr.assign_interest recover_interest_wait,
			hcr.assign_repay_account recover_account,
			FROM_UNIXTIME(IF(hcr.assign_repay_yes_time=0,hcr.assign_repay_next_time,hcr.assign_repay_yes_time), '%Y-%m-%d' ) recover_time,
			IF(hcr.status=0,IF(hcr.advance_status=3,'逾期中','未还款'),'已还款') recover_status
		FROM
			ht_credit_repay hcr
		WHERE
			hcr.assign_nid=#{nid}
	</select>

	<!-- 获取当前持有债权转让还款计划详情 -->
	<select id="creditRepaymentPlanDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			hct.assign_account - hct.assign_repay_account recover_account_wait,
			hct.assign_capital - hct.assign_repay_capital recover_capital_wait,
			hct.assign_interest - hct.assign_repay_interest recover_interest_wait,
			hct.assign_repay_account recover_account_yes,
			DATE_FORMAT(
				MIN(hct.create_time),
				'%Y-%m-%d %H:%i:%s'
			) createTime,
			hct.bid_nid borrow_nid
		FROM
			ht_credit_tender hct
		WHERE
			hct.assign_nid = #{nid}
	</select>

	<!-- 获取当前持有优惠券还款计划列表 -->
	<select id="couponRepaymentPlanList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hcr.tender_id nid,
			hcr.recover_period recover_period,
			hcr.recover_account recover_account_wait,
			hcr.recover_capital recover_capital_wait,
			IF(hcr.recover_capital>0,hcr.recover_account-hcr.recover_capital,hcr.recover_interest) recover_interest_wait,
			hcr.recover_account_yes recover_account,
			FROM_UNIXTIME(IFNULL(hcr.recover_yestime,hcr.recover_time), '%Y-%m-%d' ) recover_time,
			IF(hcr.recover_status=0,IF(b.`status`=8,'逾期中','未还款'),'已回款') recover_status
		FROM
			ht_coupon_recover hcr
		INNER JOIN ht_borrow_tender_cpn hbtc ON hcr.tender_id=hbtc.nid
		INNER JOIN ht_borrow b ON b.borrow_nid = hbtc.borrow_nid
		WHERE hcr.tender_id=#{nid}
	</select>

	<!-- 获取当前持有优惠券还款计划详情 -->
	<select id="couponRepaymentPlanDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			SUM(IF(hcr.recover_status=0,hcr.recover_account,0)) recover_account_wait,
			SUM(IF(hcr.recover_status=0,hcr.recover_capital,0)) recover_capital_wait,
			IF(SUM(IF(hcr.recover_status=0,hcr.recover_capital,0))>0,
					SUM(IF(hcr.recover_status=0,hcr.recover_account,0))-SUM(IF(hcr.recover_status=0,hcr.recover_capital,0)),
					SUM(IF(hcr.recover_status=0,hcr.recover_interest,0))) recover_interest_wait,
			SUM(hcr.recover_account_yes) recover_account_yes,
			DATE_FORMAT( MIN(hbtc.create_time), '%Y-%m-%d %H:%i:%s' ) createTime,
			hbtc.borrow_nid borrow_nid
		FROM
			ht_coupon_recover hcr
		INNER JOIN ht_borrow_tender_cpn hbtc ON hcr.tender_id=hbtc.nid
		WHERE hcr.tender_id=#{nid}
	</select>

	<!-- 获取当前持有融通宝不分期还款计划列表 -->
	<select id="rtbRepaymentPlanNoStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hiil.invest_order_id nid,
			1 recover_period,
			hiil.loan_interest recover_account_wait,
			0 recover_capital_wait,
			hiil.loan_interest recover_interest_wait,
			hiil.repay_interest_yes recover_account,
			FROM_UNIXTIME(IFNULL(hiil.repay_action_time,hiil.repay_time), '%Y-%m-%d' ) recover_time,
			IF(hiil.repay_status=0,IF(b.`status`=8,'逾期中','未还款'),'已还款') recover_status
		FROM
			ht_increase_interest_loan hiil
		INNER JOIN ht_borrow b ON b.borrow_nid = hiil.borrow_nid
		WHERE hiil.invest_order_id=#{nid}
	</select>

	<!-- 获取当前持有融通宝不分期还款计划详情 -->
	<select id="rtbRepaymentPlanNoStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			SUM(IF(hiil.repay_status=0,hiil.loan_interest,0)) recover_account_wait,
			0 recover_capital_wait,
			SUM(IF(hiil.repay_status=0,hiil.loan_interest,0)) recover_interest_wait,
			SUM(hiil.repay_interest_yes) recover_account_yes,
			DATE_FORMAT( MIN(hiii.create_time), '%Y-%m-%d %H:%i:%s' ) createTime,
			hiii.borrow_nid borrow_nid
		FROM
			ht_increase_interest_loan hiil
			INNER JOIN ht_increase_interest_invest hiii ON hiil.invest_order_id=hiii.order_id
		WHERE hiil.invest_order_id=#{nid}
	</select>

	<!-- 获取当前持有融通宝分期还款计划列表 -->
	<select id="rtbRepaymentPlanStagesList" resultMap="creditorRepayMentPlanMap" parameterType="java.util.Map">
		SELECT
			hiil.invest_order_id nid,
			hiil.repay_period recover_period,
			hiil.loan_interest recover_account_wait,
			0 recover_capital_wait,
			hiil.loan_interest recover_interest_wait,
			hiil.repay_interest_yes recover_account,
			FROM_UNIXTIME(IFNULL(hiil.repay_action_time,hiil.repay_time), '%Y-%m-%d' ) recover_time,
			IF(hiil.repay_status=0,IF(b.`status`=8,'逾期中','未还款'),'已还款') recover_status
		FROM
			ht_increase_interest_loan_detail hiil
		INNER JOIN ht_borrow b ON b.borrow_nid = hiil.borrow_nid
		WHERE hiil.invest_order_id=#{nid}
	</select>

	<!-- 获取当前持有融通宝分期还款计划详情 -->
	<select id="rtbRepaymentPlanStagesDetails" resultMap="creditorRepayMentPlanDetailsMap" parameterType="java.util.Map">
		SELECT
			SUM(IF(hiil.repay_status=0,hiil.loan_interest,0)) recover_account_wait,
			0 recover_capital_wait,
			SUM(IF(hiil.repay_status=0,hiil.loan_interest,0)) recover_interest_wait,
			SUM(hiil.repay_interest_yes) recover_account_yes,
			DATE_FORMAT( MIN(hiii.create_time), '%Y-%m-%d %H:%i:%s' ) createTime,
			hiii.borrow_nid borrow_nid
		FROM
			ht_increase_interest_loan_detail hiil
			INNER JOIN ht_increase_interest_invest hiii ON hiil.invest_order_id=hiii.order_id
		WHERE hiil.invest_order_id=#{nid}
	</select>



</mapper>