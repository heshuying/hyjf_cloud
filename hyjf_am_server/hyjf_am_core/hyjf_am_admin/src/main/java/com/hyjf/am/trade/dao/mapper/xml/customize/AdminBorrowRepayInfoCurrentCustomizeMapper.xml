<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.trade.dao.mapper.customize.AdminBorrowRepayInfoCurrentCustomizeMapper">
    <resultMap id="getRepayInfoCurrentListResultMap"
               type="com.hyjf.am.vo.admin.BorrowRepayInfoCurrentCustomizeVO">
    </resultMap>
    <sql id="where-type-1">
        <if test="borrowNid != null and borrowNid != ''">
            AND b.borrow_nid = #{borrowNid}
        </if>
        <if test="tenderOrderId != null and tenderOrderId != ''">
            AND br.nid = #{tenderOrderId}
        </if>
        <if test="assignOrderId != null and assignOrderId != ''">
            AND 1 = 2
        </if>
        <if test="repayPeriod != null and repayPeriod != ''">
            AND br.recover_period = #{repayPeriod}
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus == 8">
            AND b.`status` = 8
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus != 8">
            AND br.recover_status = #{repayStatus}
        </if>
        <if test="repayTimeStart != null and repayTimeStart != ''">
            AND br.recover_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayTimeStart})
        </if>
        <if test="repayTimeEnd != null and repayTimeEnd != ''">
            AND br.recover_time <![CDATA[<=]]> UNIX_TIMESTAMP(#{repayTimeEnd})+86399
        </if>
        <if test="repayedTimeStart != null and repayedTimeStart != ''">
            AND br.recover_yestime <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayedTimeStart})
        </if>
        <if test="repayedTimeEnd != null and repayedTimeEnd != ''">
            AND br.recover_yestime <![CDATA[<=]]>UNIX_TIMESTAMP(#{repayedTimeEnd})+86399
        </if>
    </sql>

    <sql id="where-type-2">
        <if test="borrowNid != null and borrowNid != ''">
            AND b.borrow_nid = #{borrowNid}
        </if>
        <if test="tenderOrderId != null and tenderOrderId != ''">
            AND rp.nid = #{tenderOrderId}
        </if>
        <if test="assignOrderId != null and assignOrderId != ''">
            AND 1 = 2
        </if>
        <if test="repayPeriod != null and repayPeriod != ''">
            AND rp.recover_period = #{repayPeriod}
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus == 8">
            AND rp.recover_status = 0 AND rp.advance_status = 3
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus != 8">
            AND rp.recover_status = #{repayStatus}
        </if>
        <if test="repayTimeStart != null and repayTimeStart != ''">
            AND rp.recover_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayTimeStart})
        </if>
        <if test="repayTimeEnd != null and repayTimeEnd != ''">
            AND rp.recover_time <![CDATA[<=]]> UNIX_TIMESTAMP(#{repayTimeEnd})+86399
        </if>
        <if test="repayedTimeStart != null and repayedTimeStart != ''">
            AND rp.recover_yestime <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayedTimeStart})
        </if>
        <if test="repayedTimeEnd != null and repayedTimeEnd != ''">
            AND rp.recover_yestime <![CDATA[<=]]>UNIX_TIMESTAMP(#{repayedTimeEnd})+86399
        </if>
    </sql>

    <sql id="where-type-3">
        <if test="borrowNid != null and borrowNid != ''">
            AND b.borrow_nid = #{borrowNid}
        </if>
        <if test="tenderOrderId != null and tenderOrderId != ''">
            AND cr.credit_tender_nid = #{tenderOrderId}
        </if>
        <if test="assignOrderId != null and assignOrderId != ''">
            AND cr.assign_nid = #{assignOrderId}
        </if>
        <if test="repayPeriod != null and repayPeriod != ''">
            AND cr.assign_repay_period = #{repayPeriod}
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus == 8">
            AND cr.`status` = 0 AND cr.advance_status = 3
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus != 8">
            AND cr.`status` = #{repayStatus}
        </if>
        <if test="repayTimeStart != null and repayTimeStart != ''">
            AND cr.assign_repay_next_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayTimeStart})
        </if>
        <if test="repayTimeEnd != null and repayTimeEnd != ''">
            AND cr.assign_repay_next_time <![CDATA[<=]]> UNIX_TIMESTAMP(#{repayTimeEnd})+86399
        </if>
        <if test="repayedTimeStart != null and repayedTimeStart != ''">
            AND cr.assign_repay_yes_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayedTimeStart})
        </if>
        <if test="repayedTimeEnd != null and repayedTimeEnd != ''">
            AND cr.assign_repay_yes_time <![CDATA[<=]]>UNIX_TIMESTAMP(#{repayedTimeEnd})+86399
        </if>
    </sql>

    <sql id="where-type-4">
        <if test="borrowNid != null and borrowNid != ''">
            AND b.borrow_nid = #{borrowNid}
        </if>
        <if test="tenderOrderId != null and tenderOrderId != ''">
            AND hcr.invest_order_id = #{tenderOrderId}
        </if>
        <if test="assignOrderId != null and assignOrderId != ''">
            AND hcr.assign_order_id = #{assignOrderId}
        </if>
        <if test="repayPeriod != null and repayPeriod != ''">
            AND hcr.assign_repay_period = #{repayPeriod}
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus == 8">
            AND hcr.repay_status = 0 AND hcr.advance_status = 3
        </if>
        <if test="repayStatus != null and repayStatus != '' and repayStatus != 8">
            AND hcr.repay_status = #{repayStatus}
        </if>
        <if test="repayTimeStart != null and repayTimeStart != ''">
            AND hcr.assign_repay_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayTimeStart})
        </if>
        <if test="repayTimeEnd != null and repayTimeEnd != ''">
            AND hcr.assign_repay_time <![CDATA[<=]]> UNIX_TIMESTAMP(#{repayTimeEnd})+86399
        </if>
        <if test="repayedTimeStart != null and repayedTimeStart != ''">
            AND hcr.assign_repay_yes_time <![CDATA[>=]]> UNIX_TIMESTAMP(#{repayedTimeStart})
        </if>
        <if test="repayedTimeEnd != null and repayedTimeEnd != ''">
            AND hcr.assign_repay_yes_time <![CDATA[<=]]>UNIX_TIMESTAMP(#{repayedTimeEnd})+86399
        </if>
    </sql>
    <select id="getRepayInfoCurrentList" resultMap="getRepayInfoCurrentListResultMap" parameterType="map">
        SELECT
            *
        FROM
            (
                <!-- 1、未分期原始出借订单查询-->
                SELECT
                    br.borrow_nid AS borrowNid,
                    br.nid AS tenderOrdid,
                    '' AS assignOrdid,
                    br.repay_ordid AS repayOrdid,
                    hic.inst_name AS instName,
                    b.plan_nid AS planNid,
                    b.borrow_user_name AS borrowUserName,
                    t.user_name AS recoverUserName,
                    '1' AS period,
                    1 AS recoverPeriod,
                    t.account,
                    br.recover_capital - br.credit_amount AS amountHold,
                    br.recover_capital AS recoverCapital,
                    br.recover_interest AS recoverInterest,
                    br.recover_account AS recoverAccount,
                    br.recover_fee AS recoverFee,
                    IF(b.`status` != 8, br.recover_status, 8) AS recoverStatus,

                IF (
                    bry.repay_status = 1
                    AND bry.repay_action_time > 0,
                    CASE bry.repay_money_source
                WHEN 1 THEN
                    '借款人还款'
                WHEN 2 THEN
                    '机构垫付'
                WHEN 3 THEN
                    '保证金垫付'
                ELSE
                    '借款人还款'
                END,
                ''
                ) AS repayMoneySource,
                br.recover_account_yes +
            IF (
                br.recover_status = 1,
                br.recover_fee,
                0
            ) AS recoverAmountTotal,
            FROM_UNIXTIME(br.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
            br.recover_yestime IS NULL
            OR br.recover_yestime = '',
            '',
            FROM_UNIXTIME(
                br.recover_yestime,
                '%Y-%m-%d %H:%i:%s'
            )
        ) AS repayActionTime,
         '1' AS recordType
        FROM
            ht_borrow_recover br
        INNER JOIN ht_borrow b ON br.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON br.tender_id = t.id
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE
            (
                b.borrow_style = 'end'
                OR b.borrow_style = 'endday'
            )
        AND br.credit_status != 2
        <include refid="where-type-1"/>

        UNION ALL
        <!-- 2、分期原始出借订单查询-->
            SELECT
                rp.borrow_nid,
                rp.nid AS tenderOrdid,
                '' AS assignOrdid,
                rp.repay_order_id AS repayOrdid,
                hic.inst_name AS instName,
                b.plan_nid AS planNid,
                b.borrow_user_name AS borrowUserName,
                t.user_name AS recoverUserName,
                concat_ws('/',rp.recover_period,b.borrow_period) AS period,
                rp.recover_period AS recoverPeriod,
                t.account,
                rp.recover_capital  - rp.credit_amount AS amountHold,
                rp.recover_capital AS recoverCapital,
                rp.recover_interest AS recoverInterest,
                rp.recover_account AS recoverAccount,
                rp.recover_fee AS recoverFee,
                IF(rp.recover_status=0,IF(brp.advance_status=3,8,0),1) AS recoverStatus,

            IF (
                brp.repay_status = 1
                AND brp.repay_action_time > 0,
                CASE brp.repay_money_source
            WHEN 1 THEN
                '借款人还款'
            WHEN 2 THEN
                '机构垫付'
            WHEN 3 THEN
                '保证金垫付'
            ELSE
                '借款人还款'
            END,
            ''
            ) AS repayMoneySource,
            rp.recover_account_yes +
        IF (
            rp.recover_status = 1,
            rp.recover_fee,
            0
        ) AS recoverAmountTotal,
         FROM_UNIXTIME(rp.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
            rp.recover_yestime IS NULL
            OR rp.recover_yestime = '',
            '',
            FROM_UNIXTIME(
                rp.recover_yestime,
                '%Y-%m-%d %H:%i:%s'
            )
        ) AS repayActionTime,
         '2' AS recordType
        FROM
            ht_borrow_recover_plan rp
        JOIN ht_borrow b ON rp.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON rp.tender_id = t.id
        INNER JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid
        AND brp.repay_period = rp.recover_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE rp.credit_status != 2
        <include refid="where-type-2"/>
        UNION
            <!-- 3、债权转让承接订单查询-->
            SELECT
                b.borrow_nid AS borrowNid,
                cr.credit_tender_nid AS tenderOrdid,
                cr.assign_nid AS assignOrdid,
                cr.credit_repay_order_id AS repayOrdid,
                hic.inst_name AS instName,
                b.plan_nid AS planNid,
                b.borrow_user_name AS borrowUserName,
                cr.user_name AS recoverUserName,
                concat_ws('/',cr.recover_period,b.borrow_period) AS period,
                cr.assign_repay_period AS recoverPeriod,
                t.account,
                cr.assign_capital AS amountHold,
                cr.assign_capital AS recoverCapital,
                cr.assign_interest AS recoverInterest,
                cr.assign_account AS recoverAccount,
                cr.manage_fee AS recoverFee,
                IF (
                cr.`status` = 0,

                IF (cr.advance_status = 3, 8, 0),
                1
                ) AS recoverStatus,

            IF (
                cr.`status` = 1
                AND cr.assign_repay_yes_time > 0,
                CASE bry.repay_money_source
            WHEN 1 THEN
                '借款人还款'
            WHEN 2 THEN
                '机构垫付'
            WHEN 3 THEN
                '保证金垫付'
            ELSE
                '借款人还款'
            END,
            ''
            ) AS repayMoneySource,
            cr.assign_repay_account +
        IF (
            cr. STATUS = 1,
            cr.manage_fee,
            0
        ) AS recoverAmountTotal,
         FROM_UNIXTIME(
            cr.assign_repay_next_time,
            '%Y-%m-%d'
        ) AS recoverTime,

        IF (
            cr.assign_repay_yes_time IS NULL
            OR cr.assign_repay_yes_time = '',
            '',
            FROM_UNIXTIME(
                cr.assign_repay_yes_time,
                '%Y-%m-%d %H:%i:%s'
            )
        ) AS repayActionTime,
         '3' AS recordType
        FROM
            ht_credit_repay cr
        JOIN ht_borrow b ON cr.bid_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON cr.credit_tender_nid = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid AND brp.repay_period = cr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-3"/>
        UNION
            <!-- 4、计划底层标的债权转让承接订单查询-->
            SELECT
                b.borrow_nid AS borrowNid,
                hcr.invest_order_id AS tenderOrdid,
                hcr.assign_order_id AS assignOrdid,
                hcr.credit_repay_order_id AS repayOrdid,
                hic.inst_name AS instName,
                b.plan_nid AS planNid,
                b.borrow_user_name AS borrowUserName,
                hcr.user_name AS recoverUserName,
                concat_ws('/',hcr.repay_period,b.borrow_period) AS period,
                hcr.assign_repay_period AS recoverPeriod,
                t.account,
                hcr.repay_capital AS amountHold,
                hcr.repay_capital AS recoverCapital,
                hcr.repay_interest AS recoverInterest,
                hcr.repay_account AS recoverAccount,
                hcr.manage_fee AS recoverFee,
                IF (
                hcr.repay_status = 0,

                IF (hcr.advance_status = 3, 8, 0),
                1
                )
                AS recoverStatus,

            IF (
                hcr.repay_status = 1
                AND hcr.assign_repay_yes_time > 0,
                CASE bry.repay_money_source
            WHEN 1 THEN
                '借款人还款'
            WHEN 2 THEN
                '机构垫付'
            WHEN 3 THEN
                '保证金垫付'
            ELSE
                '借款人还款'
            END,
            ''
            ) AS repayMoneySource,
            hcr.repay_account_yes +
        IF (
            hcr.repay_status = 1,
            hcr.manage_fee,
            0
        ) AS recoverAmountTotal,
        IF (
            hcr.assign_repay_next_time IS NULL
            OR hcr.assign_repay_time = '',
            '',
            FROM_UNIXTIME(
            hcr.assign_repay_time,
            '%Y-%m-%d'
            )
        )
        AS recoverTime,

        IF (
            hcr.assign_repay_yes_time IS NULL
            OR hcr.assign_repay_yes_time = '',
            '',
            FROM_UNIXTIME(
                hcr.assign_repay_yes_time,
                '%Y-%m-%d %H:%i:%s'
            )
        ) AS repayActionTime,
         '4' AS recordType
        FROM
            ht_hjh_debt_credit_repay hcr
        JOIN ht_borrow b ON hcr.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON hcr.invest_order_id = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid AND brp.repay_period = hcr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-4"/>
            ) t
        ORDER BY t.borrowNid,t.recoverUserName,t.recoverPeriod ASC
        <if test="limitStart >= 0" >
            LIMIT #{limitStart} , #{limitEnd}
        </if>
    </select>

    <select id="getRepayInfoCurrentCount" resultType="int" parameterType="map">
        SELECT
            COUNT(t.borrowNid)
        FROM
            (
                SELECT
                    br.borrow_nid AS borrowNid
        FROM
            ht_borrow_recover br
        INNER JOIN ht_borrow b ON br.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON br.tender_id = t.id
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE
            (
                b.borrow_style = 'end'
                OR b.borrow_style = 'endday'
            )
        <include refid="where-type-1"/>
        UNION ALL
            SELECT
                rp.borrow_nid
        FROM
            ht_borrow_recover_plan rp
        JOIN ht_borrow b ON rp.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON rp.tender_id = t.id
        INNER JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid
        AND brp.repay_period = rp.recover_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-2"/>
        UNION ALL
            SELECT
                b.borrow_nid AS borrowNid
        FROM
            ht_credit_repay cr
        JOIN ht_borrow b ON cr.bid_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON cr.credit_tender_nid = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-3"/>
        UNION ALL
            SELECT
                b.borrow_nid AS borrowNid
        FROM
            ht_hjh_debt_credit_repay hcr
        JOIN ht_borrow b ON hcr.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON hcr.invest_order_id = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-4"/>
            ) t
    </select>

    <select id="getRepayInfoCurrentSum" resultType="map" parameterType="map">
        SELECT
            SUM(IFNULL(recoverCapital,0)) AS capitalSum,
            SUM(IFNULL(recoverInterest,0)) AS interestSum,
            SUM(IFNULL(recoverAccount,0)) AS accountSum,
            SUM(IFNULL(recoverFee,0)) AS feeSum
        FROM
        (
        <!-- 1、未分期原始出借订单查询-->
        SELECT
        br.borrow_nid AS borrowNid,
        br.nid AS tenderOrdid,
        '' AS assignOrdid,
        br.repay_ordid AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.borrow_user_name AS borrowUserName,
        t.user_name AS recoverUserName,
        '1' AS period,
        t.account,
        br.recover_capital - br.recover_capital_yes - br.credit_amount AS amountHold,
        br.recover_capital AS recoverCapital,
        br.recover_interest AS recoverInterest,
        br.recover_account AS recoverAccount,
        br.recover_fee AS recoverFee,
        br.recover_status AS recoverStatus,

        IF (
        bry.repay_status = 1
        AND bry.repay_action_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        br.recover_account_yes +
        IF (
        br.recover_status = 1,
        br.recover_fee,
        0
        ) AS recoverAmountTotal,
        FROM_UNIXTIME(br.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
        br.recover_yestime IS NULL
        OR br.recover_yestime = '',
        '',
        FROM_UNIXTIME(
        br.recover_yestime,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '1' AS recordType
        FROM
        ht_borrow_recover br
        INNER JOIN ht_borrow b ON br.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON br.tender_id = t.id
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE
        (
        b.borrow_style = 'end'
        OR b.borrow_style = 'endday'
        )
        <include refid="where-type-1"/>

        UNION ALL
        <!-- 2、分期原始出借订单查询-->
        SELECT
        rp.borrow_nid,
        rp.nid AS tenderOrdid,
        '' AS assignOrdid,
        rp.repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.borrow_user_name AS borrowUserName,
        t.user_name AS recoverUserName,
        rp.recover_period AS period,
        t.account,
        rp.recover_capital - rp.recover_capital_yes - rp.credit_amount AS amountHold,
        rp.recover_capital AS recoverCapital,
        rp.recover_interest AS recoverInterest,
        rp.recover_account AS recoverAccount,
        rp.recover_fee AS recoverFee,
        rp.recover_status AS recoverStatus,

        IF (
        brp.repay_status = 1
        AND brp.repay_action_time > 0,
        CASE brp.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        rp.recover_account_yes +
        IF (
        rp.recover_status = 1,
        rp.recover_fee,
        0
        ) AS recoverAmountTotal,
        FROM_UNIXTIME(rp.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
        rp.recover_yestime IS NULL
        OR rp.recover_yestime = '',
        '',
        FROM_UNIXTIME(
        rp.recover_yestime,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '2' AS recordType
        FROM
        ht_borrow_recover_plan rp
        JOIN ht_borrow b ON rp.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON rp.tender_id = t.id
        INNER JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid
        AND brp.repay_period = rp.recover_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-2"/>
        UNION
        <!-- 3、债权转让承接订单查询-->
        SELECT
        b.borrow_nid AS borrowNid,
        cr.credit_tender_nid AS tenderOrdid,
        cr.assign_nid AS assignOrdid,
        cr.credit_repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.borrow_user_name AS borrowUserName,
        cr.user_name AS recoverUserName,
        cr.assign_repay_period AS period,
        t.account,
        cr.assign_capital AS amountHold,
        cr.assign_capital AS recoverCapital,
        cr.assign_interest AS recoverInterest,
        cr.assign_account AS recoverAccount,
        cr.manage_fee AS recoverFee,
        cr. STATUS AS recoverStatus,

        IF (
        cr.`status` = 1
        AND cr.assign_repay_yes_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        cr.assign_repay_account +
        IF (
        cr. STATUS = 1,
        cr.manage_fee,
        0
        ) AS recoverAmountTotal,
        FROM_UNIXTIME(
        cr.assign_repay_next_time,
        '%Y-%m-%d'
        ) AS recoverTime,

        IF (
        cr.assign_repay_yes_time IS NULL
        OR cr.assign_repay_yes_time = '',
        '',
        FROM_UNIXTIME(
        cr.assign_repay_yes_time,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '3' AS recordType
        FROM
        ht_credit_repay cr
        JOIN ht_borrow b ON cr.bid_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON cr.credit_tender_nid = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-3"/>
        UNION
        <!-- 4、计划底层标的债权转让承接订单查询-->
        SELECT
        b.borrow_nid AS borrowNid,
        hcr.invest_order_id AS tenderOrdid,
        hcr.assign_order_id AS assignOrdid,
        hcr.credit_repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.borrow_user_name AS borrowUserName,
        hcr.user_name AS recoverUserName,
        hcr.assign_repay_period AS period,
        t.account,
        hcr.repay_capital AS amountHold,
        hcr.repay_capital AS recoverCapital,
        hcr.repay_interest AS recoverInterest,
        hcr.repay_account AS recoverAccount,
        hcr.manage_fee AS recoverFee,
        hcr.repay_status AS recoverStatus,

        IF (
        hcr.repay_status = 1
        AND hcr.assign_repay_yes_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        hcr.repay_account_yes +
        IF (
        hcr.repay_status = 1,
        hcr.manage_fee,
        0
        ) AS recoverAmountTotal,
        FROM_UNIXTIME(
        hcr.assign_repay_next_time,
        '%Y-%m-%d'
        ) AS recoverTime,

        IF (
        hcr.assign_repay_yes_time IS NULL
        OR hcr.assign_repay_yes_time = '',
        '',
        FROM_UNIXTIME(
        hcr.assign_repay_yes_time,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '4' AS recordType
        FROM
        ht_hjh_debt_credit_repay hcr
        JOIN ht_borrow b ON hcr.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_tender AS t ON hcr.invest_order_id = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        WHERE 1=1
        <include refid="where-type-4"/>
        ) t
    </select>

    <select id="getRepayInfoCurrentListExport" resultType="com.hyjf.am.vo.admin.BorrowRepayInfoCurrentExportCustomizeVO" parameterType="map">
        SELECT * FROM
        (
        <!-- 1、未分期原始出借订单查询-->
        SELECT
        br.borrow_nid AS borrowNid,
        br.nid AS tenderOrdid,
        '' AS assignOrdid,
        br.repay_ordid AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.user_id AS borrowUserId,
        b.borrow_user_name AS borrowUserName,
        binfo. NAME AS borrowName,
        bpt.borrow_name AS projectTypeName,
        b.borrow_Period AS borrowPeriod,
        b.borrow_Apr AS borrowApr,
        b.account AS borrowAccount,
        b.borrow_account_yes AS borrowAccountYes,
        bs. NAME AS repayType,
        u2.user_id AS recoverUserId,
        u2.username AS recoverUserName,
        u2.attribute AS recoverUserAttribute,
        CASE
        WHEN u2.attribute = '1' THEN
        `od6`.`name`
        ELSE
        `od3`.`name`
        END `recoverRegionName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od5`.`name`
        ELSE
        `od2`.`name`
        END `recoverBranchName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od4`.`name`
        ELSE
        `od`.`name`
        END `recoverDepartmentName`,
        u3.username AS referrerName,
        u3.user_id AS referrerUserId,
        u3.truename AS referrerTrueName,
        `od6`.`name` AS `referrerRegionName`,
        `od5`.`name` AS `referrerBranchName`,
        `od4`.`name` AS `referrerDepartmentName`,
        t.account AS recoverTotal,
        br.recover_capital - br.recover_capital_yes - br.credit_amount AS amountHold,
        br.recover_capital AS recoverCapital,
        br.recover_interest AS recoverInterest,
        br.recover_Account AS recoverAccount,
        br.recover_fee AS recoverFee,

        IF (
        b.repay_last_time = ''
        OR b.repay_last_time = '0'
        OR b.repay_last_time = 'null',
        '',
        FROM_UNIXTIME(
        b.repay_last_time,
        '%Y-%m-%d'
        )
        ) AS recoverLastTime,
        '1' AS period,
        br.recover_capital AS recoverCapitalPeriod,
        br.recover_interest AS recoverInterestPeriod,
        br.recover_Account AS recoverAccountPeriod,
        br.recover_fee AS recoverFeePeriod,
        br.charge_days AS chargeDays,
        br.charge_interest - br.charge_penalty_interest AS chargeInterestReduce,
        br.charge_penalty_interest AS chargePenaltyInterest,
        br.late_days AS lateDays,
        br.late_interest AS lateInterest,
        br.recover_capital_yes AS recoverCapitalYesPeriod,
        br.recover_interest_yes AS recoverInterestYesPeriod,
        br.recover_Account_yes AS recoverAccountYesPeriod,
        br.recover_fee_yes AS recoverFeeYesPeriod,
        br.recover_capital_wait AS recoverCapitalWait,
        br.recover_interest_wait AS recoverInterestWait,
        br.recover_account_wait AS recoverAccountWait,
        bry.repay_username AS repayUserName,
        br.recover_status AS recoverStatus,
        bry.auto_repay AS autoRepay,

        IF (
        bry.repay_status = 1
        AND bry.repay_action_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        api.submitter,
        FROM_UNIXTIME(br.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
        br.recover_yestime IS NULL
        OR br.recover_yestime = '',
        '',
        FROM_UNIXTIME(
        br.recover_yestime,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '1' AS recordType
        FROM
        ht_borrow_recover br
        INNER JOIN ht_borrow b ON br.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON br.tender_id = t.id
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON br.borrow_userid = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON br.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = br.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE
        (
        b.borrow_style = 'end'
        OR b.borrow_style = 'endday'
        )
        <include refid="where-type-1"/>
        UNION ALL
        <!-- 2、分期原始出借订单查询-->
        SELECT
        rp.borrow_nid AS borrowNid,
        rp.nid AS tenderOrdid,
        '' AS assignOrdid,
        rp.repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.user_id AS borrowUserId,
        b.borrow_user_name AS borrowUserName,
        binfo. NAME AS borrowName,
        bpt.borrow_name AS projectTypeName,
        b.borrow_Period AS borrowPeriod,
        b.borrow_Apr AS borrowApr,
        b.account AS borrowAccount,
        b.borrow_account_yes AS borrowAccountYes,
        bs. NAME AS repayType,
        u2.user_id AS recoverUserId,
        u2.username AS recoverUserName,
        u2.attribute AS recoverUserAttribute,
        CASE
        WHEN u2.attribute = '1' THEN
        `od6`.`name`
        ELSE
        `od3`.`name`
        END `recoverRegionName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od5`.`name`
        ELSE
        `od2`.`name`
        END `recoverBranchName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od4`.`name`
        ELSE
        `od`.`name`
        END `recoverDepartmentName`,
        u3.username AS referrerName,
        u3.user_id AS referrerUserId,
        u3.truename AS referrerTrueName,
        `od6`.`name` AS `referrerRegionName`,
        `od5`.`name` AS `referrerBranchName`,
        `od4`.`name` AS `referrerDepartmentName`,
        t.account AS recoverTotal,
        br.recover_capital - br.recover_capital_yes - br.credit_amount AS amountHold,
        br.recover_capital AS recoverCapital,
        br.recover_interest AS recoverInterest,
        br.recover_Account AS recoverAccount,
        br.recover_fee AS recoverFee,

        IF (
        b.repay_last_time = ''
        OR b.repay_last_time = '0'
        OR b.repay_last_time = 'null',
        '',
        FROM_UNIXTIME(
        b.repay_last_time,
        '%Y-%m-%d'
        )
        ) AS recoverLastTime,
        concat_ws(
        '/',
        rp.recover_period,
        b.borrow_period
        ) AS period,
        rp.recover_capital AS recoverCapitalPeriod,
        rp.recover_interest AS recoverInterestPeriod,
        rp.recover_Account AS recoverAccountPeriod,
        rp.recover_fee AS recoverFeePeriod,
        rp.charge_days AS chargeDays,
        rp.charge_interest - rp.charge_penalty_interest AS chargeInterestReduce,
        rp.charge_penalty_interest AS chargePenaltyInterest,
        rp.late_days AS lateDays,
        rp.late_interest AS lateInterest,
        rp.recover_capital_yes AS recoverCapitalYesPeriod,
        rp.recover_interest_yes AS recoverInterestYesPeriod,
        rp.recover_Account_yes AS recoverAccountYesPeriod,
        rp.recover_fee_yes AS recoverFeeYesPeriod,
        rp.recover_capital_wait AS recoverCapitalWait,
        rp.recover_interest_wait AS recoverInterestWait,
        rp.recover_account_wait AS recoverAccountWait,
        brp.repay_username AS repayUserName,
        rp.recover_status AS recoverStatus,
        brp.auto_repay AS autoRepay,

        IF (
        brp.repay_status = 1
        AND brp.repay_action_time > 0,
        CASE brp.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        api.submitter,
        FROM_UNIXTIME(rp.recover_time, '%Y-%m-%d') AS recoverTime,

        IF (
        rp.recover_yestime IS NULL
        OR rp.recover_yestime = '',
        '',
        FROM_UNIXTIME(
        rp.recover_yestime,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '2' AS recordType
        FROM
        ht_borrow_recover_plan rp
        INNER JOIN ht_borrow_recover br ON br.nid = rp.nid
        INNER JOIN ht_borrow b ON rp.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON rp.tender_id = t.id
        INNER JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid
        AND brp.repay_period = rp.recover_period
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = rp.recover_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON rp.borrow_userid = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON rp.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = rp.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-2"/>
        UNION ALL
        <!-- 3、债权转让承接订单查询-->
        SELECT
        b.borrow_nid AS borrowNid,
        cr.credit_tender_nid AS tenderOrdid,
        cr.assign_nid AS assignOrdid,
        cr.credit_repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.user_id AS borrowUserId,
        b.borrow_user_name AS borrowUserName,
        binfo. NAME AS borrowName,
        bpt.borrow_name AS projectTypeName,
        b.borrow_Period AS borrowPeriod,
        b.borrow_Apr AS borrowApr,
        b.account AS borrowAccount,
        b.borrow_account_yes AS borrowAccountYes,
        bs. NAME AS repayType,
        u2.user_id AS recoverUserId,
        u2.username AS recoverUserName,
        u2.attribute AS recoverUserAttribute,
        CASE
        WHEN u2.attribute = '1' THEN
        `od6`.`name`
        ELSE
        `od3`.`name`
        END `recoverRegionName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od5`.`name`
        ELSE
        `od2`.`name`
        END `recoverBranchName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od4`.`name`
        ELSE
        `od`.`name`
        END `recoverDepartmentName`,
        u3.username AS referrerName,
        u3.user_id AS referrerUserId,
        u3.truename AS referrerTrueName,
        `od6`.`name` AS `referrerRegionName`,
        `od5`.`name` AS `referrerBranchName`,
        `od4`.`name` AS `referrerDepartmentName`,
        t.account AS recoverTotal,
        cr.assign_capital AS amountHold,
        cr.assign_capital AS recoverCapital,
        cr.assign_interest AS recoverInterest,
        cr.assign_account AS recoverAccount,
        cr.manage_fee AS recoverFee,

        IF (
        b.repay_last_time = ''
        OR b.repay_last_time = '0'
        OR b.repay_last_time = 'null',
        '',
        FROM_UNIXTIME(
        b.repay_last_time,
        '%Y-%m-%d'
        )
        ) AS recoverLastTime,
        '1' AS period,
        cr.assign_capital AS recoverCapitalPeriod,
        cr.assign_interest AS recoverInterestPeriod,
        cr.assign_account AS recoverAccountPeriod,
        cr.manage_fee AS recoverFeePeriod,
        cr.charge_days AS chargeDays,
        cr.charge_interest - cr.charge_penalty_interest AS chargeInterestReduce,
        cr.charge_penalty_interest AS chargePenaltyInterest,
        cr.late_days AS lateDays,
        cr.late_interest AS lateInterest,
        cr.assign_repay_capital AS recoverCapitalYesPeriod,
        cr.assign_repay_interest AS recoverInterestYesPeriod,
        cr.assign_repay_account AS recoverAccountYesPeriod,

        IF (
        cr.`status` = 1,
        cr.manage_fee,
        0
        ) AS recoverFeeYesPeriod,
        cr.assign_capital - cr.assign_repay_capital AS recoverCapitalWait,
        cr.assign_interest - cr.assign_repay_interest AS recoverInterestWait,
        cr.assign_account - cr.assign_repay_account AS recoverAccountWait,
        bry.repay_username AS repayUserName,
        cr.`status` AS recoverStatus,
        bry.auto_repay AS autoRepay,

        IF (
        bry.repay_status = 1
        AND bry.repay_action_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        api.submitter,
        FROM_UNIXTIME(
        cr.assign_repay_next_time,
        '%Y-%m-%d'
        ) AS recoverTime,

        IF (
        cr.assign_repay_yes_time IS NULL
        OR cr.assign_repay_yes_time = '',
        '',
        FROM_UNIXTIME(
        cr.assign_repay_yes_time,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '3' AS recordType
        FROM
        ht_credit_repay cr
        INNER JOIN ht_credit_tender ct ON ct.assign_nid = cr.assign_nid
        INNER JOIN ht_borrow b ON cr.bid_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON cr.credit_tender_nid = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = cr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON bry.user_id = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON cr.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = cr.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-3"/>
        UNION ALL
        <!-- 4、计划底层标的债权转让承接订单查询-->
        SELECT
        b.borrow_nid AS borrowNid,
        hcr.invest_order_id AS tenderOrdid,
        hcr.assign_order_id AS assignOrdid,
        hcr.credit_repay_order_id AS repayOrdid,
        hic.inst_name AS instName,
        b.plan_nid AS planNid,
        b.user_id AS borrowUserId,
        b.borrow_user_name AS borrowUserName,
        binfo. NAME AS borrowName,
        bpt.borrow_name AS projectTypeName,
        b.borrow_Period AS borrowPeriod,
        b.borrow_Apr AS borrowApr,
        b.account AS borrowAccount,
        b.borrow_account_yes AS borrowAccountYes,
        bs. NAME AS repayType,
        u2.user_id AS recoverUserId,
        u2.username AS recoverUserName,
        u2.attribute AS recoverUserAttribute,
        CASE
        WHEN u2.attribute = '1' THEN
        `od6`.`name`
        ELSE
        `od3`.`name`
        END `recoverRegionName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od5`.`name`
        ELSE
        `od2`.`name`
        END `recoverBranchName`,
        CASE
        WHEN u2.attribute = '1' THEN
        `od4`.`name`
        ELSE
        `od`.`name`
        END `recoverDepartmentName`,
        u3.username AS referrerName,
        u3.user_id AS referrerUserId,
        u3.truename AS referrerTrueName,
        `od6`.`name` AS `referrerRegionName`,
        `od5`.`name` AS `referrerBranchName`,
        `od4`.`name` AS `referrerDepartmentName`,
        t.account AS recoverTotal,
        hcr.repay_capital AS amountHold,
        hcr.repay_capital AS recoverCapital,
        hcr.repay_interest AS recoverInterest,
        hcr.repay_account AS recoverAccount,
        hcr.manage_fee AS recoverFee,

        IF (
        b.repay_last_time = ''
        OR b.repay_last_time = '0'
        OR b.repay_last_time = 'null',
        '',
        FROM_UNIXTIME(
        b.repay_last_time,
        '%Y-%m-%d'
        )
        ) AS recoverLastTime,
        '1' AS period,
        hcr.repay_capital AS recoverCapitalPeriod,
        hcr.repay_interest AS recoverInterestPeriod,
        hcr.repay_account AS recoverAccountPeriod,
        hcr.manage_fee AS recoverFeePeriod,
        hcr.advance_days AS chargeDays,
        hcr.repay_advance_interest - hcr.repay_advance_penalty_interest AS chargeInterestReduce,
        hcr.repay_advance_penalty_interest AS chargePenaltyInterest,
        hcr.late_days AS lateDays,
        hcr.repay_late_interest AS lateInterest,
        hcr.repay_capital_yes AS recoverCapitalYesPeriod,
        hcr.repay_interest_yes AS recoverInterestYesPeriod,
        hcr.repay_account_yes AS recoverAccountYesPeriod,

        IF (
        hcr.repay_status = 1,
        hcr.manage_fee,
        0
        ) AS recoverFeeYesPeriod,
        hcr.repay_capital_wait AS recoverCapitalWait,
        hcr.repay_interest_wait AS recoverInterestWait,
        hcr.repay_interest_wait AS recoverAccountWait,
        bry.repay_username AS repayUserName,
        hcr.repay_status AS recoverStatus,
        bry.auto_repay AS autoRepay,

        IF (
        bry.repay_status = 1
        AND bry.repay_action_time > 0,
        CASE bry.repay_money_source
        WHEN 1 THEN
        '借款人还款'
        WHEN 2 THEN
        '机构垫付'
        WHEN 3 THEN
        '保证金垫付'
        ELSE
        '借款人还款'
        END,
        ''
        ) AS repayMoneySource,
        api.submitter,
        FROM_UNIXTIME(
        hcr.assign_repay_next_time,
        '%Y-%m-%d'
        ) AS recoverTime,

        IF (
        hcr.assign_repay_yes_time IS NULL
        OR hcr.assign_repay_yes_time = '',
        '',
        FROM_UNIXTIME(
        hcr.assign_repay_yes_time,
        '%Y-%m-%d %H:%i:%s'
        )
        ) AS repayActionTime,
        '4' AS recordType
        FROM
        ht_hjh_debt_credit_repay hcr
        INNER JOIN ht_hjh_debt_credit_tender hct ON hct.assign_order_id = hcr.assign_order_id
        INNER JOIN ht_borrow b ON hcr.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON hcr.invest_order_id = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = hcr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON bry.user_id = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON hcr.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = hcr.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-4"/>
        ) t
        ORDER BY t.borrowNid
        <if test="limitStart!=null and limitStart >= 0" >
            LIMIT #{limitStart} , #{limitEnd}
        </if>
    </select>

    <select id="getRepayInfoCurrentCountExport" resultType="int" parameterType="map">
        SELECT COUNT(t.borrowNid)FROM
        (SELECT
        br.borrow_nid AS borrowNid
        FROM
        ht_borrow_recover br
        INNER JOIN ht_borrow b ON br.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON br.tender_id = t.id
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON br.borrow_userid = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON br.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = br.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE
        (
        b.borrow_style = 'end'
        OR b.borrow_style = 'endday'
        )
        <include refid="where-type-1"/>
        UNION ALL
        SELECT
        rp.borrow_nid AS borrowNid
        FROM
        ht_borrow_recover_plan rp
        INNER JOIN ht_borrow_recover br ON br.nid = rp.nid
        INNER JOIN ht_borrow b ON rp.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON rp.tender_id = t.id
        INNER JOIN ht_borrow_repay_plan AS brp ON b.borrow_nid = brp.borrow_nid
        AND brp.repay_period = rp.recover_period
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = rp.recover_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON rp.borrow_userid = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON rp.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = rp.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-2"/>
        UNION ALL
        SELECT
        b.borrow_nid AS borrowNid
        FROM
        ht_credit_repay cr
        INNER JOIN ht_credit_tender ct ON ct.assign_nid = cr.assign_nid
        INNER JOIN ht_borrow b ON cr.bid_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON cr.credit_tender_nid = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = cr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON bry.user_id = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON cr.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = cr.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-3"/>
        UNION ALL
        SELECT
        b.borrow_nid AS borrowNid
        FROM
        ht_hjh_debt_credit_repay hcr
        INNER JOIN ht_hjh_debt_credit_tender hct ON hct.assign_order_id = hcr.assign_order_id
        INNER JOIN ht_borrow b ON hcr.borrow_nid = b.borrow_nid
        INNER JOIN ht_borrow_info AS binfo ON binfo.borrow_nid = b.borrow_nid
        LEFT JOIN ht_borrow_style AS bs ON b.borrow_style = bs.nid
        INNER JOIN ht_borrow_tender AS t ON hcr.invest_order_id = t.nid
        INNER JOIN ht_borrow_repay AS bry ON b.borrow_nid = bry.borrow_nid
        LEFT JOIN ht_borrow_apicron AS api ON api.borrow_nid = b.borrow_nid
        AND api.period_now = hcr.assign_repay_period
        LEFT JOIN ht_hjh_inst_config hic ON hic.inst_code = binfo.inst_code
        LEFT JOIN ht_borrow_project_type bpt ON bpt.borrow_cd = CAST(b.project_type AS CHAR)
        LEFT JOIN ht_r_user AS u1 ON bry.user_id = u1.user_id
        LEFT JOIN ht_r_user AS u2 ON hcr.user_id = u2.user_id
        LEFT JOIN ht_r_oa_users `ou` ON `ou`.hyd_id = hcr.user_id
        AND ou.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od` ON `od`.`id` = `ou`.`departmentid`
        AND `od`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od2` ON `od2`.`id` = `od`.`parentid`
        LEFT JOIN ht_r_oa_department `od3` ON `od3`.`id` = `od2`.`parentid`
        LEFT JOIN ht_r_user AS u3 ON t.invite_user_id = u3.user_id
        LEFT JOIN ht_r_oa_users `ou1` ON `ou1`.hyd_id = t.invite_user_id
        AND ou1.user_status IN ('E', 'Q1', 'Q11', 'Q2', 'Q21')
        LEFT JOIN ht_r_oa_department `od4` ON `od4`.`id` = `ou1`.`departmentid`
        AND `od4`.id IS NOT NULL
        LEFT JOIN ht_r_oa_department `od5` ON `od5`.`id` = `od4`.`parentid`
        LEFT JOIN ht_r_oa_department `od6` ON `od6`.`id` = `od5`.`parentid`
        WHERE 1=1
        <include refid="where-type-4"/>
        ) t
    </select>
</mapper>