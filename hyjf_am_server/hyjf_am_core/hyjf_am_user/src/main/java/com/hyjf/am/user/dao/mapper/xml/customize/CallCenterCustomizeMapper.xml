<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyjf.am.user.dao.mapper.customize.CallCenterCustomizeMapper">

<!-- 复投用户筛选 -->
<select id="findNoServiceFuTouUsersList" resultMap="CallcenterUserBaseCustomize" parameterType="Map">
	SELECT
		hydu.user_id,
		hydu.username,
		hydu.mobile
	FROM
		ht_user  hydu
		<!-- #关联用户信息 -->
		JOIN ht_user_info info ON hydu.user_id = info.user_id 
	WHERE
		NOT EXISTS (
			SELECT
				1
			FROM
				ht_callcenter_service_users csu
			WHERE
				hydu.username = csu.username
			AND csu.assigned != 0
		)
	<!-- #关联用户信息 -->
	AND info.attribute = 0
	<!-- #6个月内注册的用户不传 -->
	AND hydu.reg_time <![CDATA[<=]]> UNIX_TIMESTAMP(
		DATE_ADD(NOW(), INTERVAL - 6 MONTH)
	) 
	<!-- #有投资是在还款中 此处跨库关联 -->
	AND EXISTS (
		SELECT
			tender.user_id
		FROM
			`hyjf_trade`.`ht_borrow_tender` tender
			`hyjf_trade`.`ht_borrow` borrow
		WHERE
			tender.user_id = hydu.user_id
		AND tender.borrow_nid = borrow.borrow_nid
		AND borrow.`status` = 4
	)
	<if test="limitStart != null and limitEnd !=null">
		LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
	</if>
</select>


	<!-- 流失用户筛选 -->
	<select id="findNoServiceLiuShiUsersList" resultMap="CallcenterUserBaseCustomize" parameterType="Map">
		SELECT
			hydu.user_id,
			hydu.username,
			hydu.mobile
		FROM
			ht_user hydu
		<!-- #关联用户信息 -->
		JOIN ht_user_info info ON hydu.user_id = info.user_id 
		<!-- #关联用户账户的信息 -->
		JOIN `hyjf_trade`.`ht_account`  account ON account.user_id = hydu.user_id 
		WHERE
			NOT EXISTS (
				SELECT
					1
				FROM
					ht_callcenter_service_users csu
				WHERE
					hydu.username = csu.username
				AND csu.assigned != 0
			)
		<!-- #无主单 -->
		AND info.attribute = 0 
		<!-- #账户资产≤50元 -->
		AND account.bank_total <![CDATA[<=]]> 50 
		<!-- #还款状态为“还款中”的用户不传 -->
		AND NOT EXISTS (
			SELECT
				tender.user_id
			FROM
			   `hyjf_trade`.`ht_borrow_tender` tender
			   `hyjf_trade`.`ht_borrow` borrow
				
			WHERE
				tender.user_id = hydu.user_id
			AND tender.borrow_nid = borrow.borrow_nid
			AND borrow.`status` = 4
		) 
		<!-- #累计投资金额≥5000 -->
		AND (
			SELECT
				SUM(t.account)
			FROM
				`hyjf_trade`.`ht_borrow_tender` t
			WHERE
				t.user_id = hydu.user_id
		) <![CDATA[>=]]> 5000
		<if test="limitStart != null and limitEnd !=null">
			LIMIT #{limitStart,jdbcType=INTEGER} , #{limitEnd,jdbcType=INTEGER}
		</if>
	</select>

</mapper>